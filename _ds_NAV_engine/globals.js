/**
 * @properties={typeid:35,uuid:"04fde543-69cc-4de9-af47-7f7c22221f17"}
 */
var NAV_action_item_category_action = 'Actions';

/**
 * @properties={typeid:35,uuid:"c8e9baad-4ca5-4111-9ceb-4257cc4ddeaf"}
 */
var NAV_action_item_category_add = 'Add';

/**
 * @properties={typeid:35,uuid:"14aca55c-d5bf-4734-8e2c-9eaacf8e42ea"}
 */
var NAV_action_item_category_filter = 'Filters';

/**
 * @properties={typeid:35,uuid:"a4c5f7bd-90af-4de9-87a2-749c98c26996"}
 */
var NAV_action_item_category_report = 'Reports';

/**
 * @properties={typeid:35,uuid:"8ad58fd5-6640-4533-a736-906c6018eed7"}
 */
var NAV_action_item_category_tab = 'Tabs';

/**
 * @properties={typeid:35,uuid:"603eed9c-dae9-415a-8ce2-0448c04415cd",variableType:4}
 */
var NAV_action_item_filter_sub1;

/**
 * @properties={typeid:35,uuid:"c65b6161-a436-41ee-b326-a6383e3457b3",variableType:4}
 */
var NAV_action_item_filter_sub2;

/**
 * @properties={typeid:35,uuid:"b67ba890-0da3-4bb6-bc60-4c45d90f1fb3"}
 */
var NAV_column_relation = '';

/**
 * @properties={typeid:35,uuid:"53c12f5d-b101-4b85-9cb3-421415086abc",variableType:4}
 */
var NAV_constant_one = 1;

/**
 * @properties={typeid:35,uuid:"48bb6b19-55db-43df-a6df-42d0b8c9925c"}
 */
var NAV_export_access = '';

/**
 * @properties={typeid:35,uuid:"9d5202c9-7092-4e60-a6fd-34883bc72ecb"}
 */
var NAV_export_navset = '';

/**
 * @properties={typeid:35,uuid:"e846eb36-3c55-4bf8-938c-c87b99a425b1"}
 */
var NAV_filter_column = '';

/**
 * @properties={typeid:35,uuid:"06af79eb-28ea-4d7a-bace-766f2fe2a1c1",variableType:4}
 */
var NAV_filter_level = 1;

/**
 * @properties={typeid:35,uuid:"43ca97e8-3878-41fd-9ee6-3a8588b6f3d0"}
 */
var NAV_filter_operator = '';

/**
 * @properties={typeid:35,uuid:"099b6774-5e90-4c11-8659-fe9d91f74e45"}
 */
var NAV_filter_relation = '';

/**
 * @properties={typeid:35,uuid:"9ec08c62-ff3e-4431-9eb7-4b966812e083"}
 */
var NAV_filter_value = '';

/**
 * @properties={typeid:35,uuid:"a957cb02-5d4e-4370-b4bf-6f69f4a0ed9f"}
 */
var NAV_filter_valuelist = '';

/**
 * @properties={typeid:35,uuid:"e5527fda-b14c-445e-b245-d3868dc2a348"}
 */
var NAV_find_relation = '';

/**
 * @properties={typeid:35,uuid:"4109f3dd-075c-4767-aafd-a4940ae30af9"}
 */
var NAV_import_access = '';

/**
 * @properties={typeid:35,uuid:"d936d5e9-0585-475d-a047-5f604f5ee9ae"}
 */
var NAV_import_navset = '';

/**
 * @properties={typeid:35,uuid:"a8ced98a-7f42-4930-a021-fff5e01f95df"}
 */
var NAV_import_navset_flag = '';

/**
 * @properties={typeid:35,uuid:"c464ad5f-8f71-405c-aab9-4c1339db4121"}
 */
var NAV_importexport_areas = '';

/**
 * @properties={typeid:35,uuid:"e944d726-036e-4e46-a262-2a8d955d40e4"}
 */
var NAV_list = '';

/**
 * @properties={typeid:35,uuid:"ad0d1dc0-4c57-4a42-8c56-b2268abe4a17"}
 */
var NAV_list_2 = '';

/**
 * @properties={typeid:35,uuid:"3a982de9-e5ea-4cb9-9f03-26dd4668e913"}
 */
var NAV_list_header = '';

/**
 * @properties={typeid:35,uuid:"69dceaef-b28e-4e46-bcfb-1dbcb893440a"}
 */
var NAV_module_filter = '';

/**
 * @properties={typeid:35,uuid:"87002b1b-a4e5-429f-987d-b20fedf12634",variableType:4}
 */
var NAV_named_column = 1;

/**
 * @properties={typeid:35,uuid:"0618d530-6a36-4b6b-a1db-48d81a7a06d7",variableType:4}
 */
var NAV_navigation_item_selected;

/**
 * @properties={typeid:35,uuid:"eec4d528-a87b-4edf-bd57-7360bc838231",variableType:4}
 */
var NAV_navigation_selected;

/**
 * @properties={typeid:35,uuid:"47c700b6-24c2-4e9c-bd14-d76df704977b",variableType:4}
 */
var NAV_P_all;

/**
 * @properties={typeid:35,uuid:"5dc65415-862f-4ed0-bcbb-acace058cfd1"}
 */
var NAV_password = '';

/**
 * @properties={typeid:35,uuid:"f4da5f17-2afc-48a7-a58a-9368cb3d04f5"}
 */
var NAV_search_valuelist = '';

/**
 * @properties={typeid:35,uuid:"4311f451-1e2d-4188-8284-8fdc9d394f6b"}
 */
var NAV_universal_selected_filter = '';

/**
 * @properties={typeid:35,uuid:"f57b9736-ec41-44ab-8775-549649921261"}
 */
var NAV_universal_selected_tab = '';

/**
 *
 * @properties={typeid:24,uuid:"94b6d117-2046-4255-8994-dfc4477a34f4"}
 */
function NAV_find_clear()
{

/*
 *	TITLE    :	NAV_find_clear
 *			  	
 *	MODULE   :	ds_NAV_engine
 *			  	
 *	ABOUT    :	clear current find parameters, load all records
 *			  	
 *	INPUT    :	
 *			  	
 *	OUTPUT   :	
 *			  	
 *	REQUIRES :	
 *			  	
 *	MODIFIED :	Apr 16, 2008 -- Troy Elliott, Data Mosaic
 *			  	
 */	//TODO: firing of these methods is driving me crazy! NAV_find_focus_lost should NOT need to be called


if (application.__parent__.solutionPrefs) {
	var baseForm = solutionPrefs.config.formNameBase
	var currentNavItem = solutionPrefs.config.currentFormID
	var formName = solutionPrefs.config.currentFormName
	var fastFindEnabled = navigationPrefs.byNavItemID[currentNavItem].fastFind
	
	//first time find is cleared, there is no value, so we set at a second to make sure and trigger the rest of the method
	var timeElapsed = (solutionPrefs.fastFind.findClear) ? new Date() - solutionPrefs.fastFind.findClear : 1000
	
	//only actually run this method if greater than 250 ms has passed since last time find was cleared
	//and find values configured
	if (timeElapsed > 250) { // && navigationPrefs.byNavItemID[currentNavItem].fastFind) {
		var serverName = forms[formName].controller.getServerName()
		var tableName = forms[formName].controller.getTableName()
	
		//if running a filter or no find configured, clear out field searching on
		if (utils.stringPatternCount(globals.DATASUTRA_find,'Filter: ') || !fastFindEnabled) {
			var searchingOn = null
			var searchingTip = 'Not searching any field'
		}
		//preserve field searching on
		else {
			var searchingOn = globals.DATASUTRA_find_field
			var searchingTip = navigationPrefs.byNavItemID[currentNavItem].fastFind.lastFindTip
		}
		
		//remove find restrictions
		var allObject = new Object()
		allObject.findName = '<html><strong><em>Show all</em></strong>'
		allObject.columnName = 'Show all'
		allObject.columnType = 'SHOWALL'
		globals.NAV_find_fields_control(allObject)
		
		//re-select selected field (checkmark)
		if (fastFindEnabled) {
			globals.DATASUTRA_find_field = searchingOn
			navigationPrefs.byNavItemID[currentNavItem].fastFind.lastFindField = searchingOn
			navigationPrefs.byNavItemID[currentNavItem].fastFind.lastFindTip = searchingTip
		}
		
		//refresh tooltiptext on find field
		forms[baseForm + '__header__fastfind'].elements.fld_find.toolTipText = searchingTip
		
		//only run when if required data is available
		if (solutionPrefs.repository && solutionPrefs.repository.allFormsByTable && 
			solutionPrefs.repository.allFormsByTable[serverName] && 
			solutionPrefs.repository.allFormsByTable[serverName][tableName] && 
			solutionPrefs.repository.allFormsByTable[serverName][tableName][formName]) {
			
			//position in code global assured by NAV_find_fields_control
			//check if not using separateFoundset
			if (!solutionPrefs.repository.allFormsByTable[serverName][tableName][formName].useSeparateFoundset) {
				solutionPrefs.fastFind.currentSearch[serverName][tableName].lastFindField = searchingOn
				solutionPrefs.fastFind.currentSearch[serverName][tableName].lastFindTip = searchingTip
			}
		}
	}
	
	//set time last cleared to limit how fast the focusgained/lost and UL refresh occur
	solutionPrefs.fastFind.findClear = new Date()
}



}

/**
 *
 * @properties={typeid:24,uuid:"c4056e4b-8840-4cca-9ed5-23a08565410a"}
 */
function NAV_find_end_normal()
{

/*
 *	TITLE    :	NAV_find_end_normal
 *			  	
 *	MODULE   :	ds_NAV_engine
 *			  	
 *	ABOUT    :	returns search box end graphic to empty or performs find
 *			  	
 *	INPUT    :	called from datePicker (optional)
 *			  	
 *	OUTPUT   :	
 *			  	
 *	REQUIRES :	globals.CODE_key_pressed()
 *			  	
 *	MODIFIED :	Sept 2007 -- Troy Elliott, Data Mosaic
 *			  	
 */ //TODO: find across all fields

if (application.__parent__.solutionPrefs) {

	var baseForm = solutionPrefs.config.formNameBase
	var currentNavItem = solutionPrefs.config.currentFormID
	var formName = solutionPrefs.config.currentFormName
	
	//no value, return search box to default state
	if (globals.DATASUTRA_find == null) {
		//forms[baseForm + '__header'].elements.find_end.setImageURL('media:///find_end.png')
		//application.updateUI()
	}
	//show all selected with value, show error
	else if (globals.DATASUTRA_find_field == 'Show all' && globals.DATASUTRA_find) {
		plugins.dialogs.showErrorDialog('Show all', 'Cannot search for '+globals.DATASUTRA_find+ ' when "Show all" item is selected.')
	}
	//find field selected (or default find field set and fast find configured) and value present, search
	else if (globals.DATASUTRA_find_field && globals.DATASUTRA_find_field != 'Show all' && navigationPrefs.byNavItemID[currentNavItem].fastFind && globals.DATASUTRA_find ) {
		//forms[baseForm + '__header'].elements.find_end.setImageURL('media:///find_stop.png')
		
		var	keyPressed = globals.CODE_key_pressed()
	
		var findItems = navigationPrefs.byNavItemID[currentNavItem].fastFind.slice(0)
		var trigger = 0
		
		//TODO: not... see NAV_find_fields for more explanation
		var dateObject = new Object()
		dateObject.findName = 'All dates'
		dateObject.columnName = 'All dates'
		dateObject.columnType = 'DATETIME'
		
		var numObject = new Object()
		numObject.findName = 'All numbers'
		numObject.columnName = 'All numbers'
		numObject.columnType = 'NUMBER'
		
		var textObject = new Object()
		textObject.findName = 'All text'
		textObject.columnName = 'All text'
		textObject.columnType = 'TEXT'		
		
		//add suffices to list
		findItems.push(dateObject,numObject,textObject)
		
		for ( var i = 0 ; i < findItems.length && !trigger ; i++ ) {
			var findField = (findItems[i].relation != 'NONE') ? findItems[i].relation + '.' + findItems[i].columnName : findItems[i].columnName
			if (globals.DATASUTRA_find_field == findField) {
				trigger = 1
			}
		}
		NAV_find_search(findItems[i-1],keyPressed)
	}
	//no finds set up
	else if (!navigationPrefs.byNavItemID[currentNavItem].fastFind) {
		globals.DATASUTRA_find = null
		plugins.dialogs.showErrorDialog('Not configured', 'No search fields are enabled on this form.')
	}
	//no field selected
	else if (!globals.DATASUTRA_find_field && globals.DATASUTRA_find) {
		plugins.dialogs.showWarningDialog('Alert', 'No find field selected...choose one.','OK')
		globals.NAV_find_fields()
	}
}
}

/**
 *
 * @properties={typeid:24,uuid:"7013e286-1a9a-4128-a504-750f84a2a31e"}
 */
function NAV_find_fields()
{

/*
 *	TITLE    :	NAV_find_fields
 *			  	
 *	MODULE   :	ds_NAV_engine
 *			  	
 *	ABOUT    :	show pop-up with fields to search on
 *			  	
 *	INPUT    :	
 *			  	
 *	OUTPUT   :	
 *			  	
 *	REQUIRES :	globals.DATASUTRA_find_field, element named btn_find on formNameBase, NAV_find_fields_control()
 *			  	
 *	MODIFIED :	Mar 6, 2008 -- Troy Elliott, Data Mosaic
 *			  	
 */

if (application.__parent__.solutionPrefs) {
	
	var baseForm = solutionPrefs.config.formNameBase
	var currentNavItem = solutionPrefs.config.currentFormID	
	
	//if there are find values, proceed
	if (navigationPrefs.byNavItemID[currentNavItem].fastFind) {
		/*
		//if no value yet, set check variable to show all
		if (globals.DATASUTRA_find_field == null) {
			globals.DATASUTRA_find_field = 'Show all'
		}
		*/
		
		//get menu list from active find items
		var findItems = navigationPrefs.byNavItemID[currentNavItem].fastFind.slice(0)
		
		//no searchable items
		if (findItems == null || (findItems && !findItems.length)) {
			plugins.dialogs.showErrorDialog('No find fields!', 'No find fields have been defined in the configuration.', 'OK')
		}
		//searchable items
		else {
			//all prefix options
			var allObject = new Object()
			allObject.findName = '<html><strong><em>Show all</em></strong>'
			allObject.columnName = 'Show all'
			allObject.columnType = 'SHOWALL'
			
			var filterObject = new Object()
			filterObject.findName = '<html><strong>Filter applied...</strong>'
			filterObject.columnName = 'Filtered'
			filterObject.columnType = 'FILTER'
			
			var replaceObject = new Object()
			replaceObject.findName = '<html><strong>Power replace</strong>'
			replaceObject.columnName = 'Replace'
			replaceObject.columnType = 'REPLACE'
			replaceObject.toolTip = 'Replace the existing value in a field for currently found records'
			
			var blankObject = new Object()
			blankObject.findName = '-'
			blankObject.columnName = '-'
			blankObject.columnType = ''
			
			//all suffix options
			var dateObject = new Object()
			dateObject.findName = 'All dates'
			dateObject.columnName = 'All dates'
			dateObject.columnType = 'DATETIME'
			dateObject.toolTip = '<html><head></head><body>Search in all fast find items that are <strong>Dates</strong></body></html>'
			
			var numObject = new Object()
			numObject.findName = 'All numbers'
			numObject.columnName = 'All numbers'
			numObject.columnType = 'NUMBER'
			numObject.toolTip = '<html><head></head><body>Search in all fast find items that are <strong>Numbers</strong></body></html>'
			
			var textObject = new Object()
			textObject.findName = 'All text'
			textObject.columnName = 'All text'
			textObject.columnType = 'TEXT'
			textObject.toolTip = '<html><head></head><body>Search in all fast find items that are <strong>Text</strong></body></html>'
			
			//figure out which suffices to add
			var addDate = false
			var addNum = false
			var addText = false
			for (var j = 0; j < findItems.length; j++) {
				//check for 
				if (!addDate && findItems[j].columnType == 'DATETIME') {
					addDate = true
				}
				//check for 
				if (!addNum && (findItems[j].columnType == 'INTEGER' || findItems[j].columnType == 'NUMBER')) {
					addNum = true
				}
				//check for 
				if (!addText && findItems[j].columnType == 'TEXT') {
					addText = true
				}
			}
			
			//add prefix
			//findItems.unshift(allObject,filterObject,blankObject)
			
		//get user modes
			//using access and control, need user modes
			if (solutionPrefs.access && solutionPrefs.access.accessControl) {
				var user = globals.CODE_copy_object(solutionPrefs.access.allowedUserPrefs)
			}
			//no access and control, use default user modes
			else {
				//there is a fw config navigation set
				if (solutionPrefs.config.navigationSetID) {
					var user = globals.NAV_preference_mode_get('User',solutionPrefs.config.navigationSetID)
				}
			}
		//add on power replace if present && there are replace items set up
			var replace = false
			for (var i = 0; i < user.itemName.length ; i++) {
				if (user.itemName[i] == 'Power Replace') {
					replace = true
				}
			}
			if (replace && navigationPrefs.byNavItemID[currentNavItem].powerReplace) {
				//there are findable items, add replace and divider
				if (findItems.length) {
					findItems.unshift(replaceObject,blankObject)
				}
				//no findable items, only add replace
				else {
					findItems.unshift(replaceObject)
				}
			}
			
//			//add suffices
//				//divider
//				if (addDate || addNum || addText) {
//					findItems.push(blankObject)
//				}
//				//date
//				if (addDate) {
//					findItems.push(dateObject)
//				}
//				//number or integer
//				if (addNum) {
//					findItems.push(numObject)
//				}
//				//text
//				if (addText) {
//					findItems.push(textObject)
//				}
				
			//build menu
			var menu = new Array()
			for (var i = 0 ; i < findItems.length ; i++) {
				var findField = (findItems[i].relation != 'NONE') ? findItems[i].relation + '.' + findItems[i].columnName : findItems[i].columnName
				//when a fast find item selected, create checkbox menu item
				if (globals.DATASUTRA_find_field == findField) {
					menu[i] = plugins.popupmenu.createCheckboxMenuItem(findItems[i].findName, NAV_find_fields_control)
					menu[i].setSelected(true)
				}
				//create a normal menu item
				else {
					menu[i] = plugins.popupmenu.createMenuItem(findItems[i].findName, NAV_find_fields_control)
				}
				
				//pass arguments
				menu[i].setMethodArguments(findItems[i])
				
				//disable dividers
				if (findItems[i].findName == '-') {
					menu[i].setEnabled(false)
				}
				
//				//set tooltip, if exists
//				if (findItems[i].toolTip) {
//					menu[i].setToolTipText(findItems[i].toolTip)
//				}
			}
			
			var elem = forms[baseForm + '__header__fastfind'].elements.btn_find
			if (elem != null) {
				plugins.popupmenu.showPopupMenu(elem, menu)
			}
		}
	}
}
}

/**
 *
 * @properties={typeid:24,uuid:"9ef40968-9dd8-4229-94ca-3f38361d3aa0"}
 */
function NAV_find_fields_control()
{

/*
 *	TITLE    :	NAV_find_fields_control
 *			  	
 *	MODULE   :	ds_NAV_engine
 *			  	
 *	ABOUT    :	show all records, popup date picker, or request focus on search box after field to find on is chosen
 *			  	
 *	INPUT    :	object with properties: findName, columnType
 *			  	
 *	OUTPUT   :	
 *			  	
 *	REQUIRES :	globals.FX_html_list_generate()
 *			  	
 *	MODIFIED :	Mar 6, 2008 -- Troy Elliott, Data Mosaic
 *			  	
 */

if (application.__parent__.solutionPrefs) {

//MEMO: need to somehow put this section in a Function of it's own
//running in Tano...strip out jsevents for now
if (utils.stringToNumber(application.getVersion()) >= 5) {
	//cast Arguments to array
	var Arguments = new Array()
	for (var i = 0; i < arguments.length; i++) {
		Arguments.push(arguments[i])
	}

	//reassign arguments without jsevents
	arguments = Arguments.filter(globals.CODE_jsevent_remove)
}

	var baseForm = solutionPrefs.config.formNameBase
	var formName = solutionPrefs.config.currentFormName
	var currentNavItem = solutionPrefs.config.currentFormID
	var findValue = arguments[0]
	var colType = findValue.columnType
	var valuelist = findValue.valuelist
	var fastFindStatus = navigationPrefs.byNavItemID[currentNavItem].fastFind
	var listName = navigationPrefs.byNavItemID[currentNavItem].navigationItem.listToLoad
	
	//base form where searching originates has been overridden
	if (navigationPrefs.byNavItemID[currentNavItem].fastFind.searchForm) {
		formName = navigationPrefs.byNavItemID[currentNavItem].fastFind.searchForm
	}	
	
	//custom search
	if (colType == 'CUSTOM') {
		//show dialog for value to be searched on
		application.showFormInDialog(
					forms[findValue.formName],
					-1,-1,-1,-1,
					' ',
					true,
					false,
					'findPowerSearch',
					false
				)
		
		//set tooltiptext to find field
		forms[baseForm + '__header__fastfind'].elements.fld_find.toolTipText = 'Power searching...'
		if (fastFindStatus) {
			navigationPrefs.byNavItemID[currentNavItem].fastFind.lastFindTip = 'Power searching...'
		}
	}
	//replace called
	else if (colType == 'REPLACE') {
		var replaceDisplay = new Array()
		var replaceStored = new Array()

		//set columns available on this form to be replaced
		for (var i = 0; i < navigationPrefs.byNavItemID[currentNavItem].powerReplace.length; i++) {
			if (navigationPrefs.byNavItemID[currentNavItem].powerReplace[i].replaceAllowed) {
				replaceDisplay[replaceDisplay.length] = navigationPrefs.byNavItemID[currentNavItem].powerReplace[i].replaceName
				replaceStored[replaceStored.length] = i
			}
		}
		application.setValueListItems('NAV_replace_columns',replaceDisplay,replaceStored)

		//set columns available on this form to be used in a replace
		replaceDisplay = new Array()
		replaceStored = new Array()
		for (var i = 0; i < navigationPrefs.byNavItemID[currentNavItem].powerReplace.length; i++) {
			if (navigationPrefs.byNavItemID[currentNavItem].powerReplace[i].replaceResource) {
				replaceDisplay[replaceDisplay.length] = navigationPrefs.byNavItemID[currentNavItem].powerReplace[i].replaceName
				replaceStored[replaceStored.length] = i
			}
		}
		application.setValueListItems('NAV_replace_fields',replaceDisplay,replaceStored)

		//set types of replacement
		var typeDisplay = new Array('Serial number','Column values','Date','Value')
		//remove column values if no fields configured
		if (!replaceDisplay.length) {
			typeDisplay.splice(1,1)
		}
		application.setValueListItems('NAV_replace_type',typeDisplay)

		//show popup dialog
		application.showFormInDialog(
					forms.NAV_P__replace,
					-1,-1,-1,-1,
					'Power Replace',
					false,
					false,
					'findPowerReplace',
					true
				)
	}
	//only proceed if 1) filter or 2) dividing line was NOT clicked 
	else if (!(colType == 'FILTER' || findValue.findName == '-')) {
		//set global used for check mark 
		globals.DATASUTRA_find_field = (findValue.relation != 'NONE') ? findValue.relation + '.' + findValue.columnName : findValue.columnName

		//set global used for grayed out calc
		globals.DATASUTRA_find_pretty = findValue.findName

		//set properties in code global to remember state of last find_field
		if (fastFindStatus) {
			navigationPrefs.byNavItemID[currentNavItem].fastFind.lastFindField = findValue.columnName
		}

		//perform find

		//show all records
		if (colType == 'SHOWALL') {
			//null out field global
			globals.DATASUTRA_find = null
			
			//how many records loaded
			var oldLoaded = forms[formName].foundset.getSize()

			//load all records
			forms[formName].foundset.loadAllRecords()

			//fire restriction enzyme
			globals.NAV_foundset_restrict(true,null,true)
			
			//run post processing method if present
			if (forms[formName] && forms[formName].FIND_post_process) {
				forms[formName].FIND_post_process()
			}
			
//			//UL in servoy greater than 4.1
//			if (utils.stringToNumber(solutionPrefs.clientInfo.verServoy) > 4 && navigationPrefs.byNavItemID[currentNavItem].navigationItem.useFwList) { 
//				forms[navigationPrefs.byNavItemID[currentNavItem].listData.tabFormInstance].controller.loadAllRecords()
//			}
//			//custom list used and based on same table, reset it too
//			else if (listName && forms[listName]) {
//				var formWorkflow = forms[formName].controller.getServerName() + '—' + forms[formName].controller.getTableName()
//				var formList = forms[listName].controller.getServerName() + '—' + forms[listName].controller.getTableName()
//				
//				//check that the two forms are based on the same table from the same server
//				if (formWorkflow == formList) {
//					forms[listName].controller.loadAllRecords()
//					
//					//crazy hack for our nested unrelated panes
//					if (forms[listName + '_1L']) {
//						var formListSub = forms[listName + '_1L'].controller.getServerName() + '—' + forms[listName + '_1L'].controller.getTableName()
//						
//						if (formList == formListSub) {
//							//load related foundset
//							forms[listName + '_1L'].controller.loadAllRecords()
//						}
//					}
//				}
//			}

			//if more than 200 records were loaded, check again
			if (oldLoaded > 200) {
				var newLoaded = forms[formName].foundset.getSize()

				//reset to initial 200 by getting query used and then reloading it manually
				if (newLoaded > 200) {
					var sql = databaseManager.getSQL(forms[formName].foundset)
					var args = databaseManager.getSQLParameters(forms[formName].foundset)

					forms[formName].foundset.loadRecords(sql, args)

//					//UL in servoy greater than 4.1
//						//totally junk the UL at this point to resync up the foundsets
//					if (utils.stringToNumber(solutionPrefs.clientInfo.verServoy) > 4 && navigationPrefs.byNavItemID[currentNavItem].navigationItem.useFwList) {
//						forms.NAV_T_universal_list.DISPLAY_cycle(true)
//					}
//					//custom list used and based on same table, reset it too
//					else if (listName && forms[listName]) {
//						var formWorkflow = forms[formName].controller.getServerName() + '—' + forms[formName].controller.getTableName()
//						var formList = forms[listName].controller.getServerName() + '—' + forms[listName].controller.getTableName()
//						
//						//check that the two forms are based on the same table from the same server
//						if (formWorkflow == formList) {
//							forms[listName].controller.loadAllRecords()
//								
//							//crazy hack for our nested unrelated panes
//							if (forms[listName + '_1L']) {
//								var formListSub = forms[listName + '_1L'].controller.getServerName() + '—' + forms[listName + '_1L'].controller.getTableName()
//								
//								if (formList == formListSub) {
//									//load related foundset
//									forms[listName + '_1L'].controller.loadAllRecords()
//								}
//							}
//						}
//					}
				}
			}

			//existing sort on that foundset, clear
			if (navigationPrefs.byNavItemID[currentNavItem].listData.sortField && navigationPrefs.byNavItemID[currentNavItem].listData.sortDirection) {
				navigationPrefs.byNavItemID[currentNavItem].listData.sortField = null
				navigationPrefs.byNavItemID[currentNavItem].listData.sortDirection = null
			}

			//forms[baseForm + '__header'].elements.find_end.setImageURL('media:///find_end.png')

			var serverName = forms[formName].controller.getServerName()
			var tableName = forms[formName].controller.getTableName()

			//add server name if not already
			if (!solutionPrefs.fastFind.currentSearch[serverName]) {
				solutionPrefs.fastFind.currentSearch[serverName] = new Object()
			}
			//add table name if not already
			if (!solutionPrefs.fastFind.currentSearch[serverName][tableName]) {
				solutionPrefs.fastFind.currentSearch[serverName][tableName] = new Object()
			}
			//only run when if required data is available
			if (solutionPrefs.repository && solutionPrefs.repository.allFormsByTable && 
				solutionPrefs.repository.allFormsByTable[serverName] && 
				solutionPrefs.repository.allFormsByTable[serverName][tableName] && 
				solutionPrefs.repository.allFormsByTable[serverName][tableName][formName]) {

				//check if not using separateFoundset
				if (!solutionPrefs.repository.allFormsByTable[serverName][tableName][formName].useSeparateFoundset) {
					solutionPrefs.fastFind.currentSearch[serverName][tableName].lastFindValue = null
					solutionPrefs.fastFind.currentSearch[serverName][tableName].lastFindField = null
					solutionPrefs.fastFind.currentSearch[serverName][tableName].sortField = null
					solutionPrefs.fastFind.currentSearch[serverName][tableName].sortDirection = null
					solutionPrefs.fastFind.currentSearch[serverName][tableName].lastFindTip = 'Not searching any field'		
				}
			}

			forms[baseForm + '__header__fastfind'].elements.fld_find.toolTipText = 'Searching in "'+findValue.findName+'"'
			if (fastFindStatus) {
				navigationPrefs.byNavItemID[currentNavItem].fastFind.lastFindTip = 'Searching in "'+findValue.findName+'"'
			}
			
			//null out stored values of last find
			if (fastFindStatus) {
				navigationPrefs.byNavItemID[currentNavItem].fastFind.lastFindValue = null
			}

			//using universal list, use selected list display options to create it
			if (navigationPrefs.byNavItemID[solutionPrefs.config.currentFormID].navigationItem.useFwList) {
				//serclipse < 4
				if (utils.stringToNumber(solutionPrefs.clientInfo.verServoy) < 4) {
					var formUL = navigationPrefs.byNavItemID[solutionPrefs.config.currentFormID].listData.tabFormInstance
					forms[formUL].UL_sync_records()
				}

				globals.TRIGGER_toolbar_record_navigator_set()
			}

			//LOG find
			globals.TRIGGER_log_create('Fast finds',
								forms[formName].controller.getServerName(),
								forms[formName].controller.getTableName(),
								'Show all'
								)
		}
		//show date picker
		else if (colType == "DATETIME") {
			forms.DATE_P__search.FrameworksFastFind = true

			application.showFormInDialog(forms.DATE_P__search,-1,-1,-1,-1,"Search",false,false,'datePicker')

//			//load form into fastfind tab panel
//			globals.NAV_find_set_popdown('DATE_P__search')

			//set tooltiptext to find field
			forms[baseForm + '__header__fastfind'].elements.fld_find.toolTipText = 'Searching in "'+findValue.findName+'"'
			if (fastFindStatus) {
				navigationPrefs.byNavItemID[currentNavItem].fastFind.lastFindTip = 'Searching in "'+findValue.findName+'"'
			}
		}
		//show value list item chooser
		else if (valuelist) {
			//get display items
			var vlItems = application.getValueListItems(valuelist)
			var vlDisplay = vlItems.getColumnAsArray(1)
			var vlReal = vlItems.getColumnAsArray(2)

			//remove null and empty values from valuelist
			for (var i = 0; i < vlDisplay.length; i++) {
				if (vlDisplay[i] == null || vlDisplay[i] == '') {
					vlDisplay.splice(i,1)
					vlReal.splice(i,1)
					i--
				}
			}

			//set vl to be this one
			application.setValueListItems('NAV_search',vlDisplay,vlDisplay)

			//more than 500 valuelist items or specified, show typeahead
			if (vlDisplay.length >= 500 || findValue.typeahead) {
				forms.NAV_P__find.elements.fld_combobox.visible = false
				forms.NAV_P__find.elements.fld_typeahead.visible = true
			}
			//show combobox
			else {
				forms.NAV_P__find.elements.fld_combobox.visible = true
				forms.NAV_P__find.elements.fld_typeahead.visible = false
			}

			//show dialog for value to be searched on
			//var vlValue = plugins.dialogs.showSelectDialog('Valuelist','Choose item from valuelist.',vlDisplay)
			application.showFormInDialog(
						forms.NAV_P__find,
						-1,-1,-1,-1,
						'Valuelist',
						true,
						false,
						'findValuelist',
						false
					)

		//	//FiD closed with OK, proceed
		//	if (globals.NAV_search_valuelist) {
		//		globals.DATASUTRA_find = globals.NAV_search_valuelist
		//	}

			//set tooltiptext to find field
			forms[baseForm + '__header__fastfind'].elements.fld_find.toolTipText = 'Searching in "'+findValue.findName+'"'
			if (fastFindStatus) {
				navigationPrefs.byNavItemID[currentNavItem].fastFind.lastFindTip = 'Searching in "'+findValue.findName+'"'
			}
		}
		else {
			forms[baseForm + '__header__fastfind'].elements.fld_find.requestFocus(true)

			//set tooltiptext to find field
			forms[baseForm + '__header__fastfind'].elements.fld_find.toolTipText = 'Searching in "'+findValue.findName+'"'
			if (fastFindStatus) {
				navigationPrefs.byNavItemID[currentNavItem].fastFind.lastFindTip = 'Searching in "'+findValue.findName+'"'
			}
		}
	}
}
}

/**
 *
 * @properties={typeid:24,uuid:"4dc5bfa1-07c3-4684-bb5a-eb81351ff548"}
 */
function NAV_find_focus_gained()
{

/*
 *	TITLE    :	NAV_find_focus_gained
 *			  	
 *	MODULE   :	ds_NAV_engine
 *			  	
 *	ABOUT    :	sets search box graphics to non blue selected versions
 *			  	
 *	INPUT    :	
 *			  	
 *	OUTPUT   :	
 *			  	
 *	REQUIRES :	
 *			  	
 *	MODIFIED :	Sept 2007 -- Troy Elliott, Data Mosaic
 *			  	
 */

if (application.__parent__.solutionPrefs) {
	var baseForm = solutionPrefs.config.formNameBase
	
	//null out what field searching on
	//forms[baseForm].gray_find_field = null
	
	//set graphics that make find field
	forms[baseForm + '__header__fastfind'].elements.find_end.setImageURL('media:///find_stop_over.png')
	forms[baseForm + '__header__fastfind'].elements.find_mid.setImageURL('media:///find_middle_over.png')
	forms[baseForm + '__header__fastfind'].elements.btn_find.setImageURL('media:///find_magnify_over.png')
	
	//punch down time that method was run -> used by focus lost to determine if it should actually lose focus
	forms[baseForm + '__header__fastfind'].findFocusGained = new Date()
	
	//call focus back on itself
	forms[baseForm + '__header__fastfind'].elements.fld_find.requestFocus(false)
}
}

/**
 *
 * @properties={typeid:24,uuid:"354609c2-827a-4712-ae1d-f78d0f802cc8"}
 */
function NAV_find_focus_lost()
{

/*
 *	TITLE    :	NAV_find_focus_lost
 *			  	
 *	MODULE   :	ds_NAV_engine
 *			  	
 *	ABOUT    :	sets search box graphics to non blue selected versions
 *			  	
 *	INPUT    :	
 *			  	
 *	OUTPUT   :	
 *			  	
 *	REQUIRES :	
 *			  	
 *	MODIFIED :	Sept 2007 -- Troy Elliott, Data Mosaic
 *			  	
 */

if (application.__parent__.solutionPrefs) {
	var baseForm = solutionPrefs.config.formNameBase
	var elem = application.getMethodTriggerElementName()
	var form = application.getMethodTriggerFormName()
	
	var findFocusLost = new Date()
	var timeElapsed = findFocusLost - forms[baseForm + '__header__fastfind'].findFocusGained
	
	//only actually run this method if greater than 100 ms has passed between gain and loss
	if (timeElapsed > 100) {
	/*	if (globals.DATASUTRA_find) {
			forms[baseForm + '__header__fastfind'].elements.find_end.setImageURL('media:///find_stop.png')
		}
		else {
			forms[baseForm + '__header__fastfind'].elements.find_end.setImageURL('media:///find_end.png')
		}	*/
		forms[baseForm + '__header__fastfind'].elements.find_end.setImageURL('media:///find_stop.png')
		forms[baseForm + '__header__fastfind'].elements.find_mid.setImageURL('media:///find_middle.png')
		forms[baseForm + '__header__fastfind'].elements.btn_find.setImageURL('media:///find_magnify.png')
	}
	//request focus without firing the method
	else {
		forms[baseForm + '__header'].elements.fld_constant.requestFocus(false)
	}
	
}
}

/**
 *
 * @properties={typeid:24,uuid:"ed5ad8d1-8530-43ff-a244-251d915d370d"}
 */
function NAV_find_search()
{

/*
 *	TITLE    :	NAV_find_search
 *			  	
 *	MODULE   :	ds_NAV_engine
 *			  	
 *	ABOUT    :	perform find
 *			  	
 *	INPUT    :	object with properties: columnName, columnType, findName, relation, valuelist
 *			  	
 *	OUTPUT   :	
 *			  	
 *	REQUIRES :	globals.CODE_key_pressed(), globals.DATASUTRA_find
 *			  	
 *	MODIFIED :	July 13, 2010 -- Troy Elliott, Data Mosaic
 *	
 */

if (application.__parent__.solutionPrefs) {

//MEMO: need to somehow put this section in a Function of it's own
//running in Tano...strip out jsevents for now
if (utils.stringToNumber(application.getVersion()) >= 5) {
	//cast Arguments to array
	var Arguments = new Array()
	for (var i = 0; i < arguments.length; i++) {
		Arguments.push(arguments[i])
	}
	
	//reassign arguments without jsevents
	arguments = Arguments.filter(globals.CODE_jsevent_remove)
}

	/****
		1. setup
	****/
	
	//control variables
	var baseForm = solutionPrefs.config.formNameBase
	var formName = solutionPrefs.config.currentFormName
	var currentNavItem = solutionPrefs.config.currentFormID
	var keyPressed = (arguments[1] != undefined) ? arguments[1] : globals.CODE_key_pressed()
	
	//only continue with method if there is a fastFind node configured; possible to not have one if default find set to All text batch
	if (navigationPrefs.byNavItemID[currentNavItem].fastFind) {
		
		//base form where searching originates has been overridden
		if (navigationPrefs.byNavItemID[currentNavItem].fastFind.searchForm) {
			formName = navigationPrefs.byNavItemID[currentNavItem].fastFind.searchForm
		}
		
		//search variables
		var colName = arguments[0].columnName
		var colType = arguments[0].columnType
		var findName = arguments[0].findName
		var relation = arguments[0].relation || 'NONE'
		var valuelist = arguments[0].valuelist
		
		if (!valuelist) {
			var searchValue = globals.DATASUTRA_find
		}
		else {
			//get vl items
			var vlItems = application.getValueListItems(valuelist)
			var vlDisplay = vlItems.getColumnAsArray(1)
			var vlReal = vlItems.getColumnAsArray(2)
			
			//get the real value for the display value chosen
			for (var i = 0; i < vlDisplay.length && !searchValue ; i++) {
				if (vlDisplay[i] == globals.DATASUTRA_find) {
					var searchValue = vlReal[i]
				}
			}
			
			if (!searchValue) {
				return
			}
		}
		
		var serverName = forms[formName].controller.getServerName()
		var tableName = forms[formName].controller.getTableName()
		
		//current foundset
		var initialFS = forms[formName].foundset.duplicateFoundSet()
		
		//no modifier key pressed and viewed through a relation, do search on the whole shebang
		if (!keyPressed && forms[formName].foundset.getRelationName()) {
			var fullFS = databaseManager.getFoundSet(serverName,tableName)
			fullFS.clear()
		}
		
		//remember state of last find request
		navigationPrefs.byNavItemID[currentNavItem].fastFind.lastFindValue = searchValue
		navigationPrefs.byNavItemID[currentNavItem].fastFind.lastFindField = colName
		
		//if an omit request, get the table object to find array of PKs
		if (keyPressed && keyPressed == 8) {
			var jsTable = databaseManager.getTable(forms[formName].foundset)
			var pkCols = jsTable.getRowIdentifierColumnNames()
			
			//MEMO: does not account for multiple primary keys on a table
			var primaryKey = pkCols[0]
			if (primaryKey) {
				var originalIDs = databaseManager.getFoundSetDataProviderAsArray(forms[formName].foundset,primaryKey)
			}
		}
		
		
		/****
			2. find
		****/
		
		//show date picker
		if (colType == "DATETIME" && searchValue == null) {
			forms.DATE_P__search.FrameworksFastFind = true
			application.showFormInDialog(forms.DATE_P__search,-1,-1,-1,-1,"Search",false)
		}
		
		//if no value to search for, quit
		if (searchValue == null) {
			return
		}
		
		//begin find with modifiers
		if (!fullFS) {
			var findMode = forms[formName].controller.find()
		}
		//begin a full find
		else {
			var findMode = fullFS.find()
		}
		
		if (!findMode) {
			plugins.dialogs.showErrorDialog(
					'Error',
					'Outstanding unsaved data.  Find not performed.'
				)
			
			globals.TRIGGER_log_create('Fast finds',
							serverName,
							tableName,
							'Find mode not entered',
							relation,
							colName,
							searchValue
						)
		}
		else {
			//multiple find requests
			//TODO: if non-left join relation, unexpected results may occur
			if (colName == 'All dates' || colName == 'All numbers' || colName == 'All text') {
				var allFinds = navigationPrefs.byNavItemID[currentNavItem].fastFind
				
				var newRequest = false
				
				switch (colName) {
					case 'All dates':
						for (var i = 0; i < allFinds.length; i++) {
							if (allFinds[i].columnType == 'DATETIME') { // && allFinds[i].relation == 'NONE') {
								globals.NAV_find_search_request(formName,allFinds[i].relation,allFinds[i].columnName,allFinds[i].columnType,searchValue,newRequest,fullFS)
								newRequest = true
							}
						}
						break
					case 'All numbers':
						for (var i = 0; i < allFinds.length; i++) {
							if ((allFinds[i].columnType == 'INTEGER' || allFinds[i].columnType == 'NUMBER')) { // && allFinds[i].relation == 'NONE') {
								globals.NAV_find_search_request(formName,allFinds[i].relation,allFinds[i].columnName,allFinds[i].columnType,searchValue,newRequest,fullFS)
								newRequest = true
							}
						}
						break
					case 'All text':
						for (var i = 0; i < allFinds.length; i++) {
							if (allFinds[i].columnType == 'TEXT') { // && allFinds[i].relation == 'NONE') {
								var dlgTitle = globals.NAV_find_search_request(formName,allFinds[i].relation,allFinds[i].columnName,allFinds[i].columnType,searchValue,newRequest,fullFS)
								newRequest = true
							}
						}
						break
				}
			}
			//single find request
			else {	
				//add find request
					//Fx method returns break if this method should stop
				var dlgTitle = globals.NAV_find_search_request(formName,relation,colName,colType,searchValue,undefined,fullFS)
				if (dlgTitle == 'break') {
					return
				}
			}
			
			//perform search
			if (keyPressed == 1) { //shift for reduce
				var count = forms[formName].controller.search(false, true)
				
				//execute restriction if required; if restricted, reset the count
				if (globals.NAV_foundset_restrict(true,null,true)) {
					count = forms[formName].foundset.getSize()
				}
				
				//LOG find
				globals.TRIGGER_log_create('Fast finds',
									serverName,
									tableName,
									'Extend',
									relation,
									colName,
									searchValue,
									count
								)
			}
			else if (keyPressed == 2) { //control for extend
				var count = forms[formName].controller.search(false, false)
				
				//execute restriction if required; if restricted, reset the count
				if (globals.NAV_foundset_restrict(true,null,true)) {
					count = forms[formName].foundset.getSize()
				}
				
				//LOG find
				globals.TRIGGER_log_create('Fast finds',
									serverName,
									tableName,
									'Reduce',
									relation,
									colName,
									searchValue,
									count
								)
				
				//no new records found, throw up warning
				if (databaseManager.getFoundSetCount(initialFS) == databaseManager.getFoundSetCount(forms[formName].foundset)) {
					plugins.dialogs.showWarningDialog(
							'No more records', 
							'<html><body>No additional records found using <strong>"'+searchValue+'"</strong><br>' + 
							' to search the <strong>'+findName+'</strong> field</body></html>',
							'OK'
						)
				}
			}
			else if (keyPressed == 8) { //option/alt for omit
				var count = forms[formName].controller.search()
				
				//execute restriction if required; if restricted, reset the count
				if (globals.NAV_foundset_restrict(true,null,true)) {
					count = forms[formName].foundset.getSize()
				}
				
				//there is something to omit
				if (count) {
					var omitIDs = databaseManager.getFoundSetDataProviderAsArray(forms[formName].foundset,primaryKey)
					
					var flag = 0
					var tempPKs = new Array()
					
					//loop through originalIDs
					for ( var z = 0 ; z < originalIDs.length ; z++ ) {		
						//loop through omitIDs and remove from originalIDs
						var j = 0
						while (omitIDs[j] <= originalIDs[z] ) {
							if (omitIDs[j] == originalIDs[z]) {
								flag = 1
								omitIDs.shift()
							}
							j ++	
						}
						if (!flag) {
							tempPKs.push(originalIDs[z])
						}
						
						//reset values for next loop
						flag = 0					
					}
					
					//load tempPKs
					var loadSet = databaseManager.convertToDataSet(tempPKs)
					forms[formName].controller.loadRecords(loadSet)
				}
		
				//LOG find
				globals.TRIGGER_log_create('Fast finds',
									serverName,
									tableName,
									'Omit',
									relation,
									colName,
									searchValue,
									count
								)
			}
			else {
				if (fullFS) {
					var count = fullFS.search()
					forms[formName].controller.loadRecords(fullFS)
				}
				else {
					var count = forms[formName].controller.search()
				}
				
				//execute restriction if required; if restricted, reset the count
				if (globals.NAV_foundset_restrict(true,null,true)) {
					count = forms[formName].foundset.getSize()
				}
				
				//LOG find
				globals.TRIGGER_log_create('Fast finds',
									serverName,
									tableName,
									'Normal',
									relation,
									colName,
									searchValue,
									count
								)
			}
			
			if (count == 0) {
				if (!dlgTitle) {
					var dlgTitle = 'Error searching'
				}
				else {
					dlgTitle = 'ERROR: ' + dlgTitle
				}
				
				//if a valuelist, get real value for passed display value
				if (valuelist) {
					searchValue = application.getValueListDisplayValue(valuelist,searchValue)
					
					//reset properties on body form to remember pretty name of last find request
					navigationPrefs.byNavItemID[currentNavItem].fastFind.lastFindValue = searchValue
				}
				
				plugins.dialogs.showWarningDialog(
							dlgTitle, 
							'<html><body>No records found for <strong>"'+searchValue+'"</strong>' + 
							' while searching in <strong>'+findName+'</strong> field</body></html>',
							'OK'
						)
				
				//load back foundset we started with
				forms[formName].controller.loadRecords(initialFS)
				
				//UL used in servoy greater than 4.1
				if (navigationPrefs.byNavItemID[currentNavItem].navigationItem.useFwList &&
					(utils.stringToNumber(solutionPrefs.clientInfo.verServoy) >= 4)) {
					
					forms[navigationPrefs.byNavItemID[currentNavItem].listData.tabFormInstance].controller.loadRecords(initialFS)
					//forms.NAV_T_universal_list.DISPLAY_cycle(true)
				}
				
				forms[baseForm + '__header__fastfind'].elements.fld_find.requestFocus(true)
			}
			else {
				//existing sort on that foundset (by clicking on the UL headers)
				if (navigationPrefs.byNavItemID[currentNavItem].listData.sortField && navigationPrefs.byNavItemID[currentNavItem].listData.sortDirection) {
					forms[formName].controller.sort(navigationPrefs.byNavItemID[currentNavItem].listData.sortField + ' ' + navigationPrefs.byNavItemID[currentNavItem].listData.sortDirection)
				}
				//fire the initial sort for this form
				else if (navigationPrefs.byNavItemID[currentNavItem].navigationItem.fwSortString && navigationPrefs.byNavItemID[currentNavItem].navigationItem.fwSortString.substr(0,6) != 'ERROR!') {
					forms[formName].controller.sort(navigationPrefs.byNavItemID[currentNavItem].navigationItem.fwSortString)
				}
				
				//UL used
				if (navigationPrefs.byNavItemID[currentNavItem].navigationItem.useFwList) {
					//UL in servoy greater than 4.1
					if (utils.stringToNumber(solutionPrefs.clientInfo.verServoy) >= 4) {
						forms[navigationPrefs.byNavItemID[currentNavItem].listData.tabFormInstance].controller.loadRecords(
									databaseManager.getSQL(forms[formName].foundset),
									databaseManager.getSQLParameters(forms[formName].foundset)
								)
						//forms.NAV_T_universal_list.DISPLAY_cycle(true)
					}
					//regenerate html list in 3.5.x
					else if (utils.stringToNumber(solutionPrefs.clientInfo.verServoy) < 4) {
						globals.TRIGGER_ul_refresh_all()
					}
				}
				//update record navigator //if universal list not used
				else {
					globals.TRIGGER_toolbar_record_navigator_set()
				}
			}
			
			//rememember the last field searched on
			//add server name if not already
			if (!solutionPrefs.fastFind.currentSearch[serverName]) {
				solutionPrefs.fastFind.currentSearch[serverName] = new Object()
			}
			//add table name if not already
			if (!solutionPrefs.fastFind.currentSearch[serverName][tableName]) {
				solutionPrefs.fastFind.currentSearch[serverName][tableName] = new Object()
				}
			//only run when using query based way to hit repository
			if (solutionPrefs.repository && solutionPrefs.repository.allFormsByTable) {
				//check if not using separateFoundset
				if (!solutionPrefs.repository.allFormsByTable[serverName][tableName][formName].useSeparateFoundset) {
					solutionPrefs.fastFind.currentSearch[serverName][tableName].lastFindValue = searchValue
					solutionPrefs.fastFind.currentSearch[serverName][tableName].lastFindField = colName
					solutionPrefs.fastFind.currentSearch[serverName][tableName].lastFindTip = navigationPrefs.byNavItemID[currentNavItem].fastFind.lastFindTip
				}
			}
			
			//run post processing method if present
			if (forms[formName] && forms[formName].FIND_post_process) {
				forms[formName].FIND_post_process()
			}
		}
	}
}
}

/**
 *
 * @properties={typeid:24,uuid:"53b1a6e0-0dd4-40c5-af64-348bd5c51e91"}
 */
function NAV_find_search_request()
{

/*
 *	TITLE    :	NAV_find_search_request
 *			  	
 *	MODULE   :	ds_NAV_engine
 *			  	
 *	ABOUT    :	adds a find request to the stack
 *			  	
 *	INPUT    :	1) name of form in workflow area
 *			  	2) relation name
 *			  	3) name of column
 *			  	4) type of column
 *			  	5) value to search
 *			  	6) create a new find request (optional)
 *			  	7) foundset to search in (optional)
 *			  	
 *	OUTPUT   :	'break' if column searched on is media or showall
 *			  	
 *	REQUIRES :	
 *			  	
 *	MODIFIED :	Apr 16, 2008 -- Troy Elliott, Data Mosaic
 *			  	
 */

var formName = arguments[0]
var relation = (arguments[1] == 'NONE') ? false : arguments[1]
var colName = arguments[2]
var colType = arguments[3]
var searchValue = arguments[4]
var newRecord = arguments[5]
var fsSearch = arguments[6] || forms[formName]		//note, not really a foundset, but a form if nothing passed in
var currentNavItem = solutionPrefs.config.currentFormID

//add new request
if (newRecord && colType != 'SHOWALL' && colType != 'MEDIA') {
	if (fsSearch && !fsSearch._formname_) {
		fsSearch.newRecord()
	}
	else {
		fsSearch.controller.newRecord()
	}
}

//add request to search by
switch (colType) {
		case "TEXT":
					var prefix = ''
					var suffix = ''
					var dlgTitle
					var wildChar = solutionPrefs.fastFind.findWildcard
					var start = false
					var end = false
					
					//only look for characters if a text field
					if (typeof searchValue == 'string') {
						//is first character the control one?
						if (searchValue.charAt(0) == wildChar) {
							start = true
							searchValue = searchValue.slice(1)
						}
						//is last character the control one?
						if (searchValue.charAt(searchValue.length-1) == wildChar) {
							end = true
							searchValue = searchValue.slice(0,searchValue.length-1)
						}
					}
					
					//exact match
					if (start && end) {
						dlgTitle = 'Searching for exact value'
					}
					//starts with
					else if (start) {
						suffix += '%'
						dlgTitle = 'Searching at beginning of field'
					}
					//ends with
					else if (end) {
						prefix += '%'
						dlgTitle = 'Searching at end of field'
					}
					//contains
					else {
						prefix += '#%'
						suffix += '%'
						dlgTitle = 'Searching anywhere in field'
					}
					
					if (relation) {
						fsSearch[relation][colName] = prefix + searchValue + suffix
					}
					else {
						fsSearch[colName] = prefix + searchValue + suffix
					}
					
					return dlgTitle
					break
					
		case "INTEGER":
					if (relation) {
						fsSearch[relation][colName] = searchValue
					}
					else {
						fsSearch[colName] = searchValue
					}
					break
					
		case "NUMBER":
					if (relation) {
						fsSearch[relation][colName] = searchValue
					}
					else {
						fsSearch[colName] = searchValue
					}
					break
					
		case "DATETIME":
					//get default format for dates
					var defaultFormat = solutionPrefs.fastFind.dateFormat
					
					//if no mask, apply default one
					if (utils.stringPosition(searchValue,'|',1,1) != -1) {
						if (relation) {
							fsSearch[relation][colName] = searchValue
						}
						else {
							fsSearch[colName] = searchValue
						}
					}
					else {
						if (relation) {
							fsSearch[relation][colName] = searchValue + '|' + defaultFormat
						}
						else {
							fsSearch[colName] = searchValue + '|' + defaultFormat
						}
					}
					break
					
		case "MEDIA":
					return 'break'
					break

		case "SHOWALL":
					forms[formName].controller.loadAllRecords()
					
					//existing sort on that foundset
					if (navigationPrefs.byNavItemID[currentNavItem].listData.sortField && navigationPrefs.byNavItemID[currentNavItem].listData.sortDirection) {
						forms[formName].controller.sort(navigationPrefs.byNavItemID[currentNavItem].listData.sortField + ' ' + navigationPrefs.byNavItemID[currentNavItem].listData.sortDirection)
					}
					return 'break'
					break
}

}

/**
 *
 * @properties={typeid:24,uuid:"6b1d334c-4cf2-4d87-afed-342d12a3badb"}
 */
function NAV_display_row_set()
{

/*
 *	TITLE    :	NAV_display_row_set
 *			  	
 *	MODULE   :	ds_NAV_engine
 *			  	
 *	ABOUT    :	creates structure for one column of a smart list display
 *			  	
 *	INPUT    :	index of selected display's column
 *			  	
 *	OUTPUT   :	array of objects; properties: rowDisplay, numChars, width, align, format, formatMask, header, fieldName
 *			  	
 *	REQUIRES :	globals.NAV_display_row_set_item()
 *			  	
 *	MODIFIED :	Oct 2007 -- Troy Elliott, Data Mosaic
 *			  	
 */

//MEMO: need to somehow put this section in a Function of it's own
//running in Tano...strip out jsevents for now
if (utils.stringToNumber(application.getVersion()) >= 5) {
	//cast Arguments to array
	var Arguments = new Array()
	for (var i = 0; i < arguments.length; i++) {
		Arguments.push(arguments[i])
	}
	
	//reassign arguments without jsevents
	arguments = Arguments.filter(globals.CODE_jsevent_remove)
}

var record = arguments[0]
var rlnDisplayItem = 'nav_list_display_to_list_display_item'

//there are column records
if (utils.hasRecords(record[rlnDisplayItem])) {
	//sort to preserve column order
	record[rlnDisplayItem].sort('row_order asc')
	
	var displayColumnItems = new Array()
	
	for ( var i = 1 ; i <= record[rlnDisplayItem].getSize() ; i++ ) {
		var displayAbout = new Object()
		
		var displayColumnItem = record[rlnDisplayItem].getRecord(i)
		
		displayAbout.rowDisplay = globals.NAV_display_row_set_item(displayColumnItem)
		displayAbout.width = (displayColumnItem.display_width_percent) ? displayColumnItem.display_width_percent : 20
		displayAbout.align = displayColumnItem.display_align
		displayAbout.format = displayColumnItem.display_format
		displayAbout.formatMask = displayColumnItem.format_mask
		displayAbout.header = (displayColumnItem.header) ? displayColumnItem.header : 'N/A'
		displayAbout.fieldName = displayColumnItem.field_name
		displayAbout.editable = (displayColumnItem.flag_edit) ? true : false
		
		displayColumnItems.push(displayAbout)
	}
}
else {
	var displayColumnItems = null
}

return displayColumnItems


}

/**
 *
 * @properties={typeid:24,uuid:"7887d6ae-1dfd-4e11-9804-ee9483b3c8bb"}
 */
function NAV_display_row_set_item()
{

/*
 *	TITLE    :	NAV_display_row_set_item
 *			  	
 *	MODULE   :	ds_NAV_engine
 *			  	
 *	ABOUT    :	creates structure for display value of one column
 *			  	
 *	INPUT    :	record object with information about display item
 *			  	
 *	OUTPUT   :	array of objects; properties: isField (actual table values for this column), value (what to display/evaluate)
 *			  	
 *	REQUIRES :	globals.CODE_copy_object()
 *			  	
 *	MODIFIED :	Sept 2007 -- Troy Elliott, Data Mosaic
 *			  	
 */

var record = arguments[0]

//parse into rawDisplay for html engine
var displayChunks = new Array()
var chunk = new Object()
var i = 0

//	process text input and replace tags with field names
if (record.display) {
	var pDisplay = ""
	
	//loop through text
	var x = 0
	var tagStart = false
	var tagEnd = false
	var tagCurrent = ""
	while (x < record.display.length) {
	
		var character = record.display.charAt(x)
		
		if (character == "<") {
			tagStart = true
			tagEnd = false
		}
		else if (character == ">") {
			tagStart = false
			tagEnd = true
		}
		
		//add to final content if both flags false
		if (!tagStart && !tagEnd) {
			pDisplay += record.display.charAt(x)
		}
		
		//if tagStart, add in pDisplay if exists and capture the tag
		if (tagStart) {
			//if pDisplay has a value, add any trailing text
			if (pDisplay.length) {
				chunk.isField = 0
				chunk.value = pDisplay
				displayChunks[i] = globals.CODE_copy_object(chunk)
				pDisplay = ""
				i++
			}
			
			tagCurrent += record.display.charAt(x)
		}

		
		//if tagEnd store/clear non-field string, find friendly value, store, continue
		if (tagEnd) {
			
			//if pDisplay has a value, add to display array
			if (pDisplay.length) {
				chunk.isField = 0
				chunk.value = pDisplay
				displayChunks[i] = globals.CODE_copy_object(chunk)
				pDisplay = ""
				i++
			}
			
			//trim leading "<<" and tailing '>'
			tagCurrent = utils.stringReplace(tagCurrent, "<<", "")
			
			//put field value in displayChunks
			chunk.isField = 1
			chunk.value = tagCurrent
			displayChunks[i] = globals.CODE_copy_object(chunk)
			tagCurrent = ""
			i++
			
			//reset end flag to false
			tagEnd = false
			
			//add one more to skip final ">"
			x ++		
		}	
		

		//go to next character in input	
		x ++
	}
	
	//if pDisplay has a value, add any trailing text
	if (pDisplay.length) {
		chunk.isField = 0
		chunk.value = pDisplay
		displayChunks[i] = globals.CODE_copy_object(chunk)
		pDisplay = ""
	}
}
else {
	chunk.isField = 0
	chunk.value = 'No default display'
	displayChunks[0] = chunk
}

return displayChunks
}

/**
 *
 * @properties={typeid:24,uuid:"6eafcfb0-7189-4076-a326-0f3873a05b93"}
 */
function NAV_universal_list_header_generate()
{

/*
 *	TITLE    :	NAV_universal_list_header_generate
 *			  	
 *	MODULE   :	ds_NAV_engine
 *			  	
 *	ABOUT    :	generates header for smart list with sortable header fields
 *			  	
 *	INPUT    :	object -> properties: field, width, align, header, and rowDisplay
 *			  	
 *	OUTPUT   :	
 *			  	
 *	REQUIRES :	
 *			  	
 *	MODIFIED :	Oct 2007 -- Troy Elliott, Data Mosaic
 *			  	
 */	//TODO: decide on alignment...used to be '+rowDisp[m].align+'
	//TODO: one possibility (rowDisp[m].width+rowDisp[m].numChars/3)

if (application.__parent__.solutionPrefs) {
	
//MEMO: need to somehow put this section in a Function of it's own
//running in Tano...strip out jsevents for now
if (utils.stringToNumber(application.getVersion()) >= 5) {
	//cast Arguments to array
	var Arguments = new Array()
	for (var i = 0; i < arguments.length; i++) {
		Arguments.push(arguments[i])
	}
	
	//reassign arguments without jsevents
	arguments = Arguments.filter(globals.CODE_jsevent_remove)
}
	
	var rowDisp = arguments[0]
	var currentNavItem = solutionPrefs.config.currentFormID
	var sortField = navigationPrefs.byNavItemID[currentNavItem].listData.sortField
	var sortDirection = navigationPrefs.byNavItemID[currentNavItem].listData.sortDirection
	var html = '<html><head>'
	
	//css
	html += '<style type="text/css" media="screen"><!-- '
	html += 'table { table-layout: fixed; width: 100%; border-spacing: 0px; border: 0px; } '
	html += 'td  {  text-indent: 4px; white-space: nowrap; overflow: hidden; border: 0px; '
		html += 'padding-top: 2px; padding-right: 3px; padding-bottom: 2px; padding-left: 3px; height: 20; line-height: 20; '
		html += 'color: "#323A4B"; text-decoration: none; font-weight: bold; background-image: url("media:///bck_sub_blue.png"); } '
	html += '.asc { background-image: url("media:///bck_sub_sort_asc.png"); } '
	html += '.desc { background-image: url("media:///bck_sub_sort_desc.png"); } '
	html += 'a { color: "#323A4B"; text-decoration: none; font-weight: bold; } '
	html += '--></style></head>'
	
	
	//body
	html += '<body>'
	html += '<table>'
	html += '<tr>'
	for ( var m = 0 ; m < rowDisp.length ; m++ ) {
		var prettyName = rowDisp[m].header
		
		//replace < with 
		prettyName = utils.stringReplace(prettyName, '<', '&lt;')
		
		//load sort graphic if appropriate
		if ((sortField == rowDisp[m].field) && sortDirection) {
			//ascending
			if (sortDirection == 'asc') {
				html += '<td class="asc" width="'+rowDisp[m].width+'%" align="'+rowDisp[m].align+'"><a href="javascript:FX_sort(\'' + rowDisp[m].field + '\')">'+prettyName+'</a></td>'		
			}
			//descending
			else if (sortDirection == 'desc') {
				html += '<td class="desc" width="'+rowDisp[m].width+'%" align="'+rowDisp[m].align+'"><a href="javascript:FX_sort(\'' + rowDisp[m].field + '\')">'+prettyName+'</a></td>'				
			}
		}
		//if header not defined when only one row, show alert
		else if ((rowDisp.length == 1) && (rowDisp[0].header == null)) {
			html += '<td width="'+rowDisp[m].width+'%" align="left">Header not defined</td>'		
		}
		else {				
			html += '<td width="'+rowDisp[m].width+'%" align="'+rowDisp[m].align+'"><a href="javascript:FX_sort(\'' + rowDisp[m].field + '\')">'+prettyName+'</a></td>'
		}
	}
	html += '<td></td>'
	html +=	'</tr></table></body></html>'
	
	//assign to header field
	globals.NAV_list_header = html
	
	//save into listData for next use
	navigationPrefs.byNavItemID[solutionPrefs.config.currentFormID].listData.headerHTML = html
}
}

/**
 *
 * @properties={typeid:24,uuid:"1edbfe8f-effa-4359-ac91-16dac1c6493c"}
 */
function NAV_display_load()
{

/*
 *	TITLE    :	NAV_display_load
 *			  	
 *	MODULE   :	ds_NAV_engine
 *			  	
 *	ABOUT    :	loads in all active, configured smart list displays
 *			  	resets the item_updated flag on all loaded displays
 *			  	
 *	INPUT    :	1- navigation item record
 *			  	
 *	OUTPUT   :	array of objects; properties: rawDisplay, rowPreview, displayID, displayDefault, and listTitle
 *			  	
 *	REQUIRES :	solutionPrefs, globals.NAV_display_row_set()
 *			  	
 *	MODIFIED :	Oct 17, 2007 -- Troy Elliott, Data Mosaic
 *			  	
 */

if (application.__parent__.solutionPrefs) {

//MEMO: need to somehow put this section in a Function of it's own
//running in Tano...strip out jsevents for now
if (utils.stringToNumber(application.getVersion()) >= 5) {
	//cast Arguments to array
	var Arguments = new Array()
	for (var i = 0; i < arguments.length; i++) {
		Arguments.push(arguments[i])
	}
	
	//reassign arguments without jsevents
	arguments = Arguments.filter(globals.CODE_jsevent_remove)
}
	
	var record = arguments[0]
	var rlnDisplay = 'nav_navigation_item_to_list_display'
	
	var displayItems = new Array()
	
	//there are records
	if (utils.hasRecords(record[rlnDisplay])) {
		//sort them
		record[rlnDisplay].sort('row_order asc')
		
		//process them
		for ( var i = 1 ; i <= record[rlnDisplay].getSize() ; i++ ) {
			var displayItem = record[rlnDisplay].getRecord(i)
			
			displayItems[i - 1] = {
					rawDisplay : globals.NAV_display_row_set(displayItem),
					rowPreview : displayItem.display_preview,
					displayID : displayItem.id_list_display,
					displayDefault : displayItem.display_default,
					listTitle : displayItem.list_title
				}
			
			if (displayItem.display_default) {
				var defaultDisplay = i - 1
			}
			
			//reset items_updated flag
			displayItem.item_updated = 0
		}
	}
	
	//set default display
	displayItems.displayPosn = (typeof defaultDisplay == 'number') ? defaultDisplay : 0
	displayItems.displayID = displayItems[displayItems.displayPosn].displayID
	
	return displayItems
}
}

/**
 *
 * @properties={typeid:24,uuid:"0d5046ef-2433-4af0-a927-25f6d45519bd"}
 */
function NAV_navigation_item_filter_load()
{

/*
 *	TITLE    :	NAV_navigation_item_filter_load
 *			  	
 *	MODULE   :	ds_NAV_engine
 *			  	
 *	ABOUT    :	returns all filters for a workflow form
 *			  	
 *	INPUT    :	1- navigation item
 *			  	
 *	OUTPUT   :	array of objects; properties: findName, columnName, columnType, relation, valuelist, toolTip
 *			  	
 *	REQUIRES :	globals.CODE_sort_dd_array()
 *			  	
 *	MODIFIED :	May 15, 2009 -- Troy Elliott, Data Mosaic
 *			  	
 */

//MEMO: need to somehow put this section in a Function of it's own
//running in Tano...strip out jsevents for now
if (utils.stringToNumber(application.getVersion()) >= 5) {
	//cast Arguments to array
	var Arguments = new Array()
	for (var i = 0; i < arguments.length; i++) {
		Arguments.push(arguments[i])
	}
	
	//reassign arguments without jsevents
	arguments = Arguments.filter(globals.CODE_jsevent_remove)
}

var fsNavItem = arguments[0]
var rlnFilter = 'nav_navigation_item_to_navigation_item_filter'

if (fsNavItem) {
	var fsFilter = fsNavItem[rlnFilter]
}

//create array for filter specs
var filterNode = new Array()

//if filter specs
if (utils.hasRecords(fsFilter)) {
	
	//go through all filter spec items
	for (var i = 1; i <= fsFilter.getSize(); i++) {
		var recordFilterItem = fsFilter.getRecord(i)
		
		//plop down filter spec
		filterNode.push(globals.CODE_record_object(recordFilterItem,true,true))
	}
	
}

return filterNode


}

/**
 *
 * @properties={typeid:24,uuid:"e72d1a7a-f93c-4b49-b37b-5a354d864598"}
 */
function NAV_find_load()
{

/*
 *	TITLE    :	NAV_find_load
 *			  	
 *	MODULE   :	ds_NAV_engine
 *			  	
 *	ABOUT    :	returns all currently enabled find values for a workflow form
 *			  	
 *	INPUT    :	1- navigation item
 *			  	
 *	OUTPUT   :	array of objects; properties: findName, columnName, columnType, relation, valuelist, toolTip
 *			  	
 *	REQUIRES :	globals.CODE_sort_dd_array()
 *			  	
 *	MODIFIED :	Sept 2007 -- Troy Elliott, Data Mosaic
 *			  	
 */

//MEMO: need to somehow put this section in a Function of it's own
//running in Tano...strip out jsevents for now
if (utils.stringToNumber(application.getVersion()) >= 5) {
	//cast Arguments to array
	var Arguments = new Array()
	for (var i = 0; i < arguments.length; i++) {
		Arguments.push(arguments[i])
	}
	
	//reassign arguments without jsevents
	arguments = Arguments.filter(globals.CODE_jsevent_remove)
}

var fsNavItem = arguments[0]
var rlnFindActive = 'nav_navigation_item_to_column__find'

if (fsNavItem) {
	var fsFind = fsNavItem[rlnFindActive]
}

var findItems = new Array()

for ( var i = 0 ; i < fsFind.getSize() ; i++ ) {
	var findItem = fsFind.getRecord(i+1)
	
	findItems[i] = {
		findName : (findItem.name_display) ? findItem.name_display : findItem.name_column,
		columnType : findItem.type_column,
		columnName : findItem.name_column,
		relation : (findItem.status_relation) ? findItem.table_or_relation : 'NONE',
		valuelist : findItem.valuelist,
		typeahead : findItem.flag_typeahead,
		toolTip : null
	}
}

findItems.sort(globals.CODE_sort_dd_array)

return findItems



}

/**
 *
 * @properties={typeid:24,uuid:"2d5933a3-fada-458a-abd4-61f9d2c968cc"}
 */
function NAV_workflow_load()
{

/*
 *	TITLE    :	NAV_workflow_load
 *			  	
 *	MODULE   :	ds_NAV_engine
 *			  	
 *	ABOUT    :	this method loads in the appropriate list and form views, saving/restoring current status of display, list, find, etc.
 *			  	
 *	INPUT    :	all arguments are optional in the base shell
 *			  	1- id_navigation_item
 *			  	2- history position
 *			  	3- clear history
 *			  	4- first form of solution
 *			  	5- specify space to be on
 *			  	
 *	OUTPUT   :	solutionPrefs.config.currentFormName, solutionPrefs.currentTableName
 *			  	
 *	REQUIRES :	solutionPrefs
 *			  	
 *	MODIFIED :	November 17, 2009 -- Troy Elliott, Data Mosaic
 *			  	
 */

if (application.__parent__.solutionPrefs) {
	
//MEMO: need to somehow put this section in a Function of it's own
//running in Tano...strip out jsevents for now
if (utils.stringToNumber(application.getVersion()) >= 5) {
	//cast Arguments to array
	var Arguments = new Array()
	for (var i = 0; i < arguments.length; i++) {
		Arguments.push(arguments[i])
	}
	
	//reassign arguments without jsevents
	arguments = Arguments.filter(globals.CODE_jsevent_remove)
}
	
	var navigationItemID = arguments[0] || null
	var historyPosition = arguments[1]
	var clearHistory = arguments[2]
	var firstForm = arguments[3]
	var spaceOV = arguments[4]
	
	var baseForm = solutionPrefs.config.formNameBase
	
	var listTab
	var mainTab
	
	//save information about current space setup only if not coming from a preference
	if (!solutionPrefs.config.prefs.preferenceMode && solutionPrefs.config.currentFormID && navigationPrefs.byNavItemID[solutionPrefs.config.currentFormID]) {
		navigationPrefs.byNavItemID[solutionPrefs.config.currentFormID].spaceStatus = new Array()
		navigationPrefs.byNavItemID[solutionPrefs.config.currentFormID].spaceStatus.lastSpace = solutionPrefs.config.activeSpace
		
		for (var i = 1; i <= 14; i++) {
			navigationPrefs.byNavItemID[solutionPrefs.config.currentFormID].spaceStatus.push(forms[baseForm + '__header'].elements['btn_space_' + i].visible)
		}
	}
	//reset preferencemode indicator if coming form one
	else if (solutionPrefs.config.prefs.preferenceMode) {
		solutionPrefs.config.prefs.preferenceMode = false
	}
	
	//if in help mode, try to stay there
	if (solutionPrefs.config.helpMode) {
		var helpMode = true
	}
	
	//if in a design mode, stay in it
	if (solutionPrefs.design.statusDesign) {
		//check for where exactly we are
		var possibleModes = new Array(
								'buttonaction',
								'buttonadd',
								'buttonreport',
								'navigation',
								'fastfind',
								'universallist',
								'spec',
								'task',
								'help',
								'prototyper'
							)
		for (var i = 0; i < possibleModes.length; i++) {
			if (solutionPrefs.design.modes[possibleModes[i]]) {
				var designMode = possibleModes[i]
				
				//not using a custom list
				if (designMode == 'navigation' || designMode == 'buttonadd') {
					var designList = false
				}
				//using a custom list
				else {
					var designList = true
				}
				
				break
			}
		}
	
	}
	
	//if no navigationItem, but a historyPositions
	if (!navigationItemID && typeof historyPosition == 'number' && historyPosition >= 0) {
		navigationItemID = solutionPrefs.history[historyPosition].navigationItemID
	}
	
	//if navitem unspecified
	if (typeof navigationItemID == 'object' && !navigationItemID) {
		var mainTab = 'DATASUTRA_0F_solution__blank_1'
		
		//load main window
		if (forms[baseForm].elements.tab_content_C.tabIndex > 0) {
			forms[baseForm].elements.tab_content_C.removeTabAt(1)
		}
		forms[baseForm].elements.tab_content_C.addTab(forms[mainTab],'')
		forms[baseForm].elements.tab_content_C.tabIndex = forms[baseForm].elements.tab_content_C.getMaxTabIndex()
		
		//load blank list window
		forms[baseForm].elements.tab_content_B.tabIndex = 1
		
		//clear out currently loaded info
		solutionPrefs.config.currentFormName = mainTab
		solutionPrefs.config.currentFormID = undefined
		
		/*
		solutionPrefs.history = new Array()
		
		//add new history item to solution Prefs
		var historyItem = solutionPrefs.history[solutionPrefs.history.length] = new Object()
		historyItem.navigationSetID = null
		historyItem.navigationSetName = null
		historyItem.navigationItemID = null
		historyItem.navigationItemName = 'No workflow form'
		historyItem.navigationItemRegistry = null
		historyItem.formName = null
		historyItem.timeAccessed = application.getServerTimeStamp()
		
		//save information about current history position into solutionPrefs
		solutionPrefs.config.currentHistoryPosition = solutionPrefs.history.length - 1
		solutionPrefs.config.currentFormName = mainTab
		solutionPrefs.config.currentFormID = null
		*/
		
		//update history controller
		//forms.TOOL_history.REC_on_select()
	}
	//if navitem specified
	else {
		//specs for this form
		var navSpecs = navigationPrefs.byNavItemID[navigationItemID].navigationItem
		
		//turn off ul rec on select in 3.5
		if ((utils.stringToNumber(solutionPrefs.clientInfo.verServoy) < 4) &&
			navigationPrefs.byNavItemID[navigationItemID] && navigationPrefs.byNavItemID[navigationItemID].listData && 
			navigationPrefs.byNavItemID[navigationItemID].listData.tabFormInstance && 
			(navigationPrefs.byNavItemID[navigationItemID].listData.tabFormInstance in forms)) {
			
			var ulSelectOff = true
			forms[navigationPrefs.byNavItemID[navigationItemID].listData.tabFormInstance + '_1L'].configured = false
		}

		//if using custom list, get it if it is available in solution, otherwise load blank list
		listTab = (navSpecs.useFwList) ? 'NAV_0L_universal_list' : navSpecs.listToLoad
		//if form is not available in solution, load blank list
		if (!listTab && !forms[listTab]) {
			listTab = 'DATASUTRA_0F_solution__blank_2'
		}
		
		//get form to load; check if loaded; if selected value is not available in solution, load blank
		if (navSpecs.formToLoad) {
			mainTab = navSpecs.formToLoad
		}
		//form not in memory
		if (!(mainTab in forms)) {
			//throw up busy bar and busy cursor -- do not run when solution first loaded
			if (navSpecs.initialForm && !firstForm) {
				var formNotLoaded = true
				
				plugins.sutra.busyCursor = true
				globals.TRIGGER_progressbar_start(-273, navSpecs.initialFormLabel)
			}
			//update when not showing progress bar to get around multi-threading the navigation item html field
			else if (!firstForm) {
				application.updateUI()
			}
		}
		//update when not showing progress bar to get around multi-threading the navigation item html field
		else if (!firstForm) {
			application.updateUI()
		}
		
		//blank
		if (!forms[mainTab]) {
			mainTab = 'DATASUTRA_0F_solution__blank_1'
		}
		else {
			var serverName = forms[mainTab].controller.getServerName()
			var tableName = forms[mainTab].controller.getTableName()
		}
		
		//if navigate to a new form when not at end of history stack, clear end
		if (historyPosition == undefined && (solutionPrefs.history.length > solutionPrefs.config.currentHistoryPosition + 1)) {
			solutionPrefs.history.splice(solutionPrefs.config.currentHistoryPosition + 1,solutionPrefs.history.length - solutionPrefs.config.currentHistoryPosition)
		}
		
		//only add history item if not navigating history and not in any preference
		if (historyPosition == undefined && forms[baseForm].elements.tab_content_A.getTabFormNameAt(1) == 'NAV_0L_solution') {
			//add new history item to solution Prefs
			var historyItem = solutionPrefs.history[solutionPrefs.history.length] = new Object()
			historyItem.navigationSetID = navSpecs.idNavigation
			historyItem.navigationSetName = application.getValueListDisplayValue('NAV_navigation_set',navSpecs.idNavigation)
			historyItem.navigationItemID = navSpecs.idNavigationItem
			historyItem.navigationItemName = navSpecs.itemName
			historyItem.navigationItemRegistry = navSpecs.itemId
			historyItem.formName = navSpecs.formToLoad
			historyItem.timeAccessed = application.getServerTimeStamp()
			
			//clear history if requested
			if (clearHistory) {
				solutionPrefs.history = new Array(historyItem)
			}
			
			//truncate list length, if needed
			var hixLength = solutionPrefs.history.length
			if (hixLength > 30) {
				solutionPrefs.history.splice(0,1)
			}
		}
		
		//save information about current history position into solutionPrefs
		var currentHix = solutionPrefs.config.currentHistoryPosition = (historyPosition != undefined) ? historyPosition : (solutionPrefs.history.length - 1)
		solutionPrefs.config.currentFormName = mainTab
		solutionPrefs.config.currentFormID = navigationItemID
		
		//update history controller
		forms.TOOL_history.REC_on_select()
		
		//fire restriction enzyme  //MEMO: will only run if the filters have changed
		globals.NAV_foundset_restrict()
		
		//remove main window if new one different than currently displayed one
		if (forms[baseForm].elements.tab_content_C.tabIndex > 0  && (forms[baseForm].elements.tab_content_C.getTabFormNameAt(1) != mainTab)) {
			forms[baseForm].elements.tab_content_C.removeTabAt(1)
		}
		//load main window if no tab currently there
		if (!forms[baseForm].elements.tab_content_C.getMaxTabIndex()) {
			forms[baseForm].elements.tab_content_C.addTab(forms[mainTab],'')
			forms[baseForm].elements.tab_content_C.tabIndex = forms[baseForm].elements.tab_content_C.getMaxTabIndex()
		}
		
		
		//load list window

		//form not yet added, add to lists tab panel
		if (listTab != 'DATASUTRA_0F_solution__blank_2' && navigationPrefs.byNavItemID[navigationItemID] && !globals.NAV_universal_list_get_status(navigationPrefs.byNavItemID[navigationItemID].listData)) {
			//create new form instances for UL
			if (navSpecs.useFwList) {
				//3.5 hacked UL
				if (utils.stringToNumber(solutionPrefs.clientInfo.verServoy) < 4) {	
					var uniList = 'NAV_0L_universal_list'
					
					//new form name (NAV_0L_universal_list__set000_item000_CRM_0F_companies)
					var newFormName = uniList + '__set' + navSpecs.idNavigation + '_item' + navSpecs.idNavigationItem + '_' + mainTab
					
					//if form not already defined, define, get and assign 200 record chunk
					if (!forms[newFormName]) {
						//create new form instances
						var success = application.createNewFormInstance(uniList,newFormName)
						var success = application.createNewFormInstance(uniList+'_1L',newFormName+'_1L')
						
						//assign secondary form to UL
						forms[newFormName].elements.tab_ul.removeAllTabs()
						forms[newFormName].elements.tab_ul.addTab(forms[newFormName+'_1L'],'UL Records',null,null,null,null)
						
						//assign UL to list tab panels
						forms[baseForm].elements.tab_content_B.addTab(forms[newFormName],newFormName,null,null,null,null)
						
						//foundset count
						var foundsetCount = databaseManager.getFoundSetCount(forms[mainTab].foundset)
						
						//get records
						var dsUniversalList = databaseManager.getDataSetByQuery(
										forms[baseForm].controller.getServerName(), 
										'SELECT id_universal_list FROM sutra_universal_list WHERE id_universal_list >= ?',
										[navigationPrefs.foundsetPool.nextFreePK],
										forms[mainTab].foundset.getSize() + 1)
										//(foundsetCount == forms[mainTab].foundset.getSize()) ? forms[mainTab].foundset.getSize() + 1 : forms[mainTab].foundset.getSize())
						var pkUL = dsUniversalList.getColumnAsArray(1)
						
						//save next pk down; and remove it from array
						navigationPrefs.foundsetPool.nextFreePK = pkUL.pop()
						
						//punch down foundset onto form via pk array
						forms[newFormName+'_1L'].foundset.loadRecords(databaseManager.convertToDataSet(pkUL))
						
						//save status info
						navigationPrefs.byNavItemID[navigationItemID].listData.foundsets.blueprint = pkUL
						navigationPrefs.byNavItemID[navigationItemID].listData.foundsets.current = forms[newFormName+'_1L'].foundset
						navigationPrefs.byNavItemID[navigationItemID].listData.tabFormInstance = newFormName
						navigationPrefs.byNavItemID[navigationItemID].listData.tabNumber = forms[baseForm].elements.tab_content_B.getMaxTabIndex()
						navigationPrefs.byNavItemID[navigationItemID].listData.dateAdded = application.getServerTimeStamp()
						
						//only switch to this tab if not on any of the developer modes
						if (!designList) {
							forms[baseForm].elements.tab_content_B.tabIndex = forms[baseForm].elements.tab_content_B.getMaxTabIndex()
						}
						//fire form on show to illiminate flicker when eventually shown
						else {
							forms[newFormName].FORM_on_show()
						}
					}
				}
				
				//4.1+ Solution Model
				else if (utils.stringToNumber(solutionPrefs.clientInfo.verServoy) >= 4) {
					var uniList = 'NAV_T_universal_list_1L'
					
					//new form name (UL__set000_item000_CRM_0F_companies)
					var newFormName = 'UL' + '__set' + navSpecs.idNavigation + '_item' + navSpecs.idNavigationItem + '_' + mainTab
					
					//if form not already defined or if button-status has changed, define
					if (!forms[newFormName] ||
						(navigationPrefs.byNavItemID[navigationItemID].listData.withButtons && !(navSpecs.barItemAdd || navSpecs.barItemAction || navSpecs.barItemFilter || navSpecs.barItemReport)) ||
						(!navigationPrefs.byNavItemID[navigationItemID].listData.withButtons && (navSpecs.barItemAdd || navSpecs.barItemAction || navSpecs.barItemFilter || navSpecs.barItemReport))
						) {
						
						//create new forms
						var template = globals.NAV_universal_list_form_to_template(uniList)
						var myForm = globals.NAV_universal_list_template_to_form(template,newFormName)
						
						//set datasource
						myForm.serverName = serverName
						myForm.tableName = tableName
						
						//set to use same foundset
						var origForm = solutionModel.getForm(mainTab)
						if (origForm.namedFoundSet) {
							myForm.namedFoundSet = origForm.namedFoundSet
						}
						
						//set events
						myForm.onShow = solutionModel.getGlobalMethod('NAV_universal_list_show')
						myForm.onRecordSelection = solutionModel.getGlobalMethod('NAV_universal_list_select')
						myForm.rowBGColorCalculation = 'globals.NAV_row_background'
//						myForm.getBodyPart().background = '#D1D7E2'
						
						//get the UL data and set it up
						var allULDisplays = navigationPrefs.byNavItemID[navigationItemID].universalList.displays
						var initialUL = allULDisplays[allULDisplays.displayPosn].rawDisplay
						
						for (var i = 0; i < initialUL.length; i++) {
							var lineItem = initialUL[i]
							
							//determine alignment
							var horizAlign = 2
							switch (lineItem.align) {
								case 'left':
									horizAlign = 2
									break
								case 'right':
									horizAlign = 4
									break
								case 'center':
									horizAlign = 0
									break
							}
							
							var fieldFormat = null
							var fieldVL = null
							
							//determine format
							if (lineItem.formatMask == 'Number' || lineItem.formatMask == 'Date') { // || lineItem.formatMask == 'Text') {
								var fieldFormat = lineItem.format
							}
							else if (lineItem.formatMask == 'Valuelist') {
								var fieldVL = lineItem.format
							}	
							
							//TODO: check for better name
							var nameNameField = (lineItem.rowDisplay[0].isField) ? lineItem.rowDisplay[0].value : lineItem.fieldName
							
							//TODO: error checking for contents of rawDisplay
							if (!nameNameField) {
								continue
							}
							
							//create field
							var myField = myForm.newTextField(
											nameNameField,			//dataprovider
											i,						//x
											0,						//y
											lineItem.width,			//width
											20						//height
										)
							
							myField.name = application.getUUID().toString()
							myField.onFocusGained = solutionModel.getGlobalMethod('NAV_universal_list_select__unhilite')
							myField.anchors = SM_ANCHOR.ALL
							myField.horizontalAlignment = horizAlign
							myField.styleClass = 'customlist'
							myField.editable = lineItem.editable
							myField.borderType = 'EmptyBorder,0,0,0,0'
							myField.margin = '0,4,0,4'
							myField.scrollbars = 0
							myField.transparent = false
							myField.text = (lineItem.header) ? lineItem.header : nameNameField
							if (fieldFormat) {
								myField.format = fieldFormat
							}
							if (fieldVL) {
								myField.valuelist = solutionModel.getValueList(fieldVL)
							}
							
							if (lineItem.editable) {
								myField.onRightClick = solutionModel.getGlobalMethod('NAV_universal_list_edit')
							}
						}
						
						//assign the secondary form to the main UL with buttons
						if (navSpecs.barItemAdd || navSpecs.barItemAction || navSpecs.barItemFilter || navSpecs.barItemReport) {
							forms.NAV_T_universal_list.elements.tab_ul.addTab(forms[newFormName],'UL Records',null,null,null,null)
							navigationPrefs.byNavItemID[navigationItemID].listData.withButtons = true
							navigationPrefs.byNavItemID[navigationItemID].listData.tabNumber = forms.NAV_T_universal_list.elements.tab_ul.getMaxTabIndex()
						}
						//assign the secondary form to the main UL without buttons
						else {
							forms.NAV_T_universal_list__no_buttons.elements.tab_ul.addTab(forms[newFormName],'UL Records',null,null,null,null)
							navigationPrefs.byNavItemID[navigationItemID].listData.withButtons = false
							navigationPrefs.byNavItemID[navigationItemID].listData.tabNumber = forms.NAV_T_universal_list__no_buttons.elements.tab_ul.getMaxTabIndex()
						}
						
						//save status info
						navigationPrefs.byNavItemID[navigationItemID].listData.tabFormInstance = newFormName
						navigationPrefs.byNavItemID[navigationItemID].listData.dateAdded = application.getServerTimeStamp()
						
						//only switch to this tab if not on any of the developer modes
						if (!designMode) {
							if (navigationPrefs.byNavItemID[navigationItemID].listData.withButtons) {
								forms.NAV_T_universal_list.FORM_on_show(true)
								forms[baseForm].elements.tab_content_B.tabIndex = 2
								forms.NAV_T_universal_list.elements.tab_ul.tabIndex = navigationPrefs.byNavItemID[navigationItemID].listData.tabNumber
							}
							else {
								forms.NAV_T_universal_list__no_buttons.FORM_on_show(true)
								forms[baseForm].elements.tab_content_B.tabIndex = 3
								forms.NAV_T_universal_list__no_buttons.elements.tab_ul.tabIndex = navigationPrefs.byNavItemID[navigationItemID].listData.tabNumber
							}
						}
						//fire form on show to illiminate flicker when eventually shown
						else {
						//	forms[newFormName].FORM_on_show()
						}
					}
				}
			}
			//add non-UL form to the list as a new tab
			else {
				//assign to list tab panels
				forms[baseForm].elements.tab_content_B.addTab(forms[listTab],'',null,null,null,null)
				
				//save status info
				navigationPrefs.byNavItemID[navigationItemID].listData.tabNumber = forms[baseForm].elements.tab_content_B.getMaxTabIndex()
				navigationPrefs.byNavItemID[navigationItemID].listData.dateAdded = application.getServerTimeStamp()
				
				if (!designList) {
					//update record navigator
					globals.TRIGGER_toolbar_record_navigator_set(solutionPrefs.config.recordNavigatorStatus)
					
					//select tab
					forms[baseForm].elements.tab_content_B.tabIndex = forms[baseForm].elements.tab_content_B.getMaxTabIndex()
				}
			}
		}
		//blank form or error, set to blank tab
		else if (!designList && listTab == 'DATASUTRA_0F_solution__blank_2') {
			forms[baseForm].elements.tab_content_B.tabIndex = 1
		}
		//form already exists, set tab index
		else if (!designList) {
			//3.5
			if (utils.stringToNumber(solutionPrefs.clientInfo.verServoy) < 4) {
				forms[baseForm].elements.tab_content_B.tabIndex = navigationPrefs.byNavItemID[navigationItemID].listData.tabNumber
			}
			//>=4
			else if (utils.stringToNumber(solutionPrefs.clientInfo.verServoy) >= 4) {
				//UL, set to 2 and then correct tab
				if (navSpecs.useFwList) {
					if (navigationPrefs.byNavItemID[navigationItemID].listData.withButtons) {
						forms.NAV_T_universal_list.FORM_on_show(true)
						forms[baseForm].elements.tab_content_B.tabIndex = 2
						forms.NAV_T_universal_list.elements.tab_ul.tabIndex = navigationPrefs.byNavItemID[navigationItemID].listData.tabNumber
					}
					else {
						forms.NAV_T_universal_list__no_buttons.FORM_on_show(true)
						forms[baseForm].elements.tab_content_B.tabIndex = 3
						forms.NAV_T_universal_list__no_buttons.elements.tab_ul.tabIndex = navigationPrefs.byNavItemID[navigationItemID].listData.tabNumber
					}
				}
				//set to correct tab
				else {
					forms[baseForm].elements.tab_content_B.tabIndex = navigationPrefs.byNavItemID[navigationItemID].listData.tabNumber
				}
			}
		}
		
		//load help window(s) if in help mode
		if (helpMode) {
			globals.DS_help(true)
			
			//in help preview mode, update the activate/deactivate toggle
			if (designMode) {
				forms.DEV_0F_solution__designbar_1F__help.NAV_ITEM_on_select()
			}
		}
		//stay in dev mode currently in
		else if (designMode) {
			globals.DEV_quick_buttons(designMode,true)
			
			//update the layout if needed
			if (solutionPrefs.design.currentMode && 
				solutionPrefs.design.modes.dictionary[solutionPrefs.design.currentMode] && 
				forms[solutionPrefs.design.modes.dictionary[solutionPrefs.design.currentMode]] &&
				forms[solutionPrefs.design.modes.dictionary[solutionPrefs.design.currentMode]].NAV_ITEM_on_select) {
				
				forms[solutionPrefs.design.modes.dictionary[solutionPrefs.design.currentMode]].NAV_ITEM_on_select()
			}
		}
		
		//if using UL in 35 and active space different than last space, refresh UL
		if (navSpecs.useFwList && (utils.stringToNumber(solutionPrefs.clientInfo.verServoy) < 4) && 
			navigationPrefs.byNavItemID[navigationItemID].spaceStatus && 
			navigationPrefs.byNavItemID[navigationItemID].spaceStatus.lastSpace && 
			navigationPrefs.byNavItemID[navigationItemID].spaceStatus.lastSpace != solutionPrefs.config.activeSpace) {
			
			forms[navigationPrefs.byNavItemID[navigationItemID].listData.tabFormInstance].UL_fill_data()
		}
		
		//if field to search by, the search string, tooltip text, or selected display are present on a form,
		//prepopulate the appropriate globals, otherwise set to null
		
		//only run when data is available
		if (solutionPrefs.repository && solutionPrefs.repository.allFormsByTable) {
			//if both server/table are valid and exist AND not using a separate foundset AND a stored value exists for that location
			if (serverName && tableName && solutionPrefs.repository.allFormsByTable[serverName] && solutionPrefs.repository.allFormsByTable[serverName][tableName] && solutionPrefs.repository.allFormsByTable[serverName][tableName][mainTab] && !solutionPrefs.repository.allFormsByTable[serverName][tableName][mainTab].useSeparateFoundset && solutionPrefs.fastFind.currentSearch[serverName] && solutionPrefs.fastFind.currentSearch[serverName][tableName]) {
				globals.DATASUTRA_find = solutionPrefs.fastFind.currentSearch[serverName][tableName].lastFindValue
				globals.DATASUTRA_find_field = solutionPrefs.fastFind.currentSearch[serverName][tableName].lastFindField
				forms[baseForm + '__header__fastfind'].elements.fld_find.toolTipText = solutionPrefs.fastFind.currentSearch[serverName][tableName].lastFindTip
				
				navigationPrefs.byNavItemID[navigationItemID].listData.sortField = solutionPrefs.fastFind.currentSearch[serverName][tableName].sortField
				navigationPrefs.byNavItemID[navigationItemID].listData.sortDirection = solutionPrefs.fastFind.currentSearch[serverName][tableName].sortDirection
			}
			else {
				globals.DATASUTRA_find = (navigationPrefs.byNavItemID[navigationItemID].fastFind && navigationPrefs.byNavItemID[navigationItemID].fastFind.lastFindValue) ? navigationPrefs.byNavItemID[navigationItemID].fastFind.lastFind : null
				globals.DATASUTRA_find_field = (navigationPrefs.byNavItemID[navigationItemID].fastFind && navigationPrefs.byNavItemID[navigationItemID].fastFind.lastFindField) ? navigationPrefs.byNavItemID[navigationItemID].fastFind.lastFindField : null
				forms[baseForm + '__header__fastfind'].elements.fld_find.toolTipText = (navigationPrefs.byNavItemID[navigationItemID].fastFind && navigationPrefs.byNavItemID[navigationItemID].fastFind.lastFindTip) ? navigationPrefs.byNavItemID[navigationItemID].fastFind.lastFindTip : 'Not searching any field'
			}
		}
		else {
			globals.DATASUTRA_find = (navigationPrefs.byNavItemID[navigationItemID].fastFind && navigationPrefs.byNavItemID[navigationItemID].fastFind.lastFindValue) ? navigationPrefs.byNavItemID[navigationItemID].fastFind.lastFind : null
			globals.DATASUTRA_find_field = (navigationPrefs.byNavItemID[navigationItemID].fastFind && navigationPrefs.byNavItemID[navigationItemID].fastFind.lastFindField) ? navigationPrefs.byNavItemID[navigationItemID].fastFind.lastFindField : null
			forms[baseForm + '__header__fastfind'].elements.fld_find.toolTipText = (navigationPrefs.byNavItemID[navigationItemID].fastFind && navigationPrefs.byNavItemID[navigationItemID].fastFind.lastFindTip) ? navigationPrefs.byNavItemID[navigationItemID].fastFind.lastFindTip : 'Not searching any field'
		}
		
		//check for default find field
		var findInitial = navSpecs.findDefault
		if (findInitial && !globals.DATASUTRA_find_field) {
			globals.DATASUTRA_find_field = findInitial
		}
		
		//set check on display pop-down
		//this form has been visited before and has a default display
		if (navigationPrefs.byNavItemID[navigationItemID].universalList && navigationPrefs.byNavItemID[navigationItemID].universalList.displays && navigationPrefs.byNavItemID[navigationItemID].universalList.displays.displayID) {
			globals.DATASUTRA_display = navigationPrefs.byNavItemID[navigationItemID].universalList.displays.displayID
		}
		//no displays configured
		else {
			globals.DATASUTRA_display = null
		}
		
		//if above globals.DATASUTRA_find, set appropriate end graphics
	/*	if (globals.DATASUTRA_find) {
			forms[baseForm + '__header__fastfind'].elements.find_end.setImageURL('media:///find_stop.png')
		}
		else {
			forms[baseForm + '__header__fastfind'].elements.find_end.setImageURL('media:///find_end.png')
		}	*/
		
		//SPACES setup
		var spacesOK = navigationPrefs.byNavItemID[navigationItemID].spaceSetup
		var sessionSpaces = navigationPrefs.byNavItemID[navigationItemID].spaceStatus
		
		//space override specifed; activate (only if different than current one)
		if (spaceOV && spaceOV != solutionPrefs.config.activeSpace) {
			globals.DS_space_change('btn_space_'+spacesOK[spaceOV],true)
		}
		//activate default space if there is one, it is different than current space;  do this on first time form loaded and all subsequent times until space changed while on this navItem
		else if (navSpecs.spaceDefault && spacesOK['space_' + (navSpecs.spaceDefault)] != solutionPrefs.config.activeSpace && (!sessionSpaces || ((sessionSpaces && sessionSpaces.lastSpace && sessionSpaces.lastSpace == spacesOK['space_' + navSpecs.spaceDefault]) ? true : false))) {
			globals.DS_space_change('btn_space_'+navSpecs.spaceDefault,true)
		}
		//current space is not allowed for this item, 
		else if (solutionPrefs.config.activeSpace && !spacesOK[spacesOK[solutionPrefs.config.activeSpace] - 1]) {
			//activate last space on for this item
			if (sessionSpaces && sessionSpaces.lastSpace && sessionSpaces.lastSpace != solutionPrefs.config.activeSpace) {
				globals.DS_space_change('btn_space_'+spacesOK[sessionSpaces.lastSpace],true)
			}
			//activate first allowable space
			else {
				var escape = false
				for (var i = 0; i < spacesOK.length && !escape; i++) {
					if (spacesOK[i]) {
						escape = true
						globals.DS_space_change('btn_space_' + (i+1),true)
					}
				}
			}
		}
		//on first load of solution, go to standard view if none specified
		else if (firstForm) {
			globals.DS_space_change('btn_space_1',true,true)
		}
		
		var borderEnabled = 'MatteBorder,0,0,0,1,#333333'
		var borderDisabled = 'MatteBorder,0,0,0,1,#797778'
		//enabled status specified for different spaces
		for (var i = 1; i <= 14; i++) {
			forms[baseForm + '__header'].elements['btn_space_' + i].enabled = spacesOK[i-1]
			
			if (i != 1 && i != 8) {
				forms[baseForm + '__header'].elements['btn_space_' + i].setBorder(spacesOK[i-1] ? borderEnabled : borderDisabled)
			}
		}
		
		//form visited before, use space setup as of the last visit
		if (sessionSpaces) {
			for (var i = 0; i < 14; i++) {
				forms[baseForm + '__header'].elements['btn_space_'+(i+1)].visible = sessionSpaces[i]
			}
		}
		//decide which space options are showing first based on defaults for this form
		else {
			var flipPreference = (navSpecs.spaceFlip) ? true : false
			
			for (var i = 0, j = i + 7; i < 7; i++, j++) {
				//both available, take spaceFlip preference
				if (spacesOK[i] && spacesOK[j]) {
					forms[baseForm + '__header'].elements['btn_space_'+(i+1)].visible = !flipPreference
					forms[baseForm + '__header'].elements['btn_space_'+(j+1)].visible = flipPreference
				}
				//only flip available, show it
				else if (spacesOK[j]) {
					forms[baseForm + '__header'].elements['btn_space_'+(i+1)].visible = false
					forms[baseForm + '__header'].elements['btn_space_'+(j+1)].visible = true
				}
				//only normal or neither available, show normal
				else {
					forms[baseForm + '__header'].elements['btn_space_'+(i+1)].visible = true
					forms[baseForm + '__header'].elements['btn_space_'+(j+1)].visible = false
				}
			}
		}
		
		//make sure active space's button is showing
		if (!forms[baseForm + '__header'].elements['btn_space_'+spacesOK[solutionPrefs.config.activeSpace]].visible) {
			//if not visible, turn on and do the opposite for it's complement
			
			//get other value
			if (spacesOK[solutionPrefs.config.activeSpace] < 8) {
				var complement = spacesOK[solutionPrefs.config.activeSpace] + 7
			}
			else {
				var complement = spacesOK[solutionPrefs.config.activeSpace] - 7
			}
			
			forms[baseForm + '__header'].elements['btn_space_'+spacesOK[solutionPrefs.config.activeSpace]].visible = true
			forms[baseForm + '__header'].elements['btn_space_'+complement].visible = false
		}
		
		//LOG navigation
		globals.TRIGGER_log_create('Navigation items',
							mainTab,
							listTab
							)
		
		
		//form was not in memory, turn off busy bar and busy cursor
		if (formNotLoaded) {
			globals.TRIGGER_progressbar_stop()
			plugins.sutra.busyCursor = false	
		}
		
		//turn ul rec on select back on
		if (ulSelectOff) {
			forms[navigationPrefs.byNavItemID[navigationItemID].listData.tabFormInstance + '_1L'].configured = true
		}
	}
}
}

/**
 * @properties={typeid:24,uuid:"26DA3CF9-9871-41AE-B157-7214B1AD663C"}
 */
function NAV_universal_list_edit(input,elem) {
	//called to depress menu
	if (input instanceof JSEvent) {
		var elem = forms[input.getFormName()].elements[input.getElementName()]
		
		//build menu
		var menu = new Array()
		menu.push(plugins.popupmenu.createMenuItem('Edit...', globals.NAV_universal_list_edit))
		menu[0].setMethodArguments(null,input)
		
		//pop up the popup menu
		if (elem != null) {
		    plugins.popupmenu.showPopupMenu(elem, menu)
		}
	}
	else {
		//enter field for editing
		if (elem) {
			input = elem
			forms[input.getFormName()].elements[input.getElementName()].selectAll()
			forms[input.getFormName()].elements[input.getElementName()].requestFocus(false)
			
//			application.updateUI()
		}
	}
}

/**
 *
 * @properties={typeid:24,uuid:"195b29be-f37f-4d74-8b42-483331b872dd"}
 */
function NAV_navigation_load()
{

/*
 *	TITLE    :	NAV_navigation_load
 *			  	
 *	MODULE   :	ds_NAV_engine
 *			  	
 *	ABOUT    :	creates global with information about available navsets
 *			  	
 *	INPUT    :	1- initial load (default false) (optional)
 *			  	2- group id with privileges (optional when a/c disabled; otherwise mandatory)
 *			  	3- return created object instead of assigned (optional)
 *			  	4- navSetID to include irregardless of group settings (optional)
 *			  	
 *	OUTPUT   :	
 *			  	
 *	REQUIRES :	solutionPrefs, input 2 when a/c enabled
 *			  	
 *	USAGE    :	NAV_navigation_load(initialLoad, groupID, returnObject) Instantiates navigationPrefs code global
 *			  	
 *	MODIFIED :	July 16, 2008 -- Troy Elliott, Data Mosaic
 *			  	
 */

if (application.__parent__.solutionPrefs) {	
	
//MEMO: need to somehow put this section in a Function of it's own
//running in Tano...strip out jsevents for now
if (utils.stringToNumber(application.getVersion()) >= 5) {
	//cast Arguments to array
	var Arguments = new Array()
	for (var i = 0; i < arguments.length; i++) {
		Arguments.push(arguments[i])
	}
	
	//reassign arguments without jsevents
	arguments = Arguments.filter(globals.CODE_jsevent_remove)
}
	
	var initialLoad = arguments[0]
	var groupID = arguments[1]
	var returnPrefs = arguments[2]
	var includeSet = arguments[3]
	
	var serverName = forms[solutionPrefs.config.formNameBase].controller.getServerName()
	var maxReturnedRows = 100
	
	//navPrefs will be returned and saved in the group record
	if (returnPrefs) {
		var navPrefs = new Object()
		
		//punch in stuff about the UL list here so we don't need to at run time
		navPrefs.foundsetPool = {
								recyclePKs : new Array(),
								omitPKs : new Array(),
								resetRequired : false
							}
		//starting position
		var dsUniversalList = databaseManager.getDataSetByQuery(
								serverName, 
								'SELECT id_universal_list FROM sutra_universal_list',
								null,
								1)
		navPrefs.foundsetPool.nextFreePK = dsUniversalList.getValue(1,1)
	}
	//navigationPrefs code global for running this session
	else {
		var navPrefs = navigationPrefs
	}
	
	//SINGLE USER
	//get all active navigation sets
	var args = null
	var query = 'SELECT id_navigation, nav_name, nav_default ' +
				'FROM sutra_navigation ' +
				'WHERE nav_status = 1 ' +
				'ORDER BY order_by ASC'
	var dataset = databaseManager.getDataSetByQuery(serverName, query, args, maxReturnedRows)
	
	var navigationSets = dataset.getColumnAsArray(1)
	var navSetNames = dataset.getColumnAsArray(2)
	var navSetDefault = dataset.getColumnAsArray(3)

	//ACCESS & CONTROL
	if (groupID) {
		//get navigation sets allowed for this group
		var args = [groupID,1]
		var query = 'SELECT id_navigation FROM sutra_control_navigation ' +
					'WHERE id_group = ? AND flag_chosen = ? ' +
					'ORDER BY order_by ASC'
		var dataset = databaseManager.getDataSetByQuery(serverName, query, args, maxReturnedRows)
		var groupOrderedNavigationSets = dataset.getColumnAsArray(1)
		
		//set value list with appropriate values
		var args = new Array()
		var query = 'SELECT id_navigation, nav_name, nav_default FROM sutra_navigation ' +
				'WHERE id_navigation IN ('
				for (var i = 0; i < groupOrderedNavigationSets.length; i++) {
					query += '?'
					args[args.length] = groupOrderedNavigationSets[i]
					
					//comma on all but the last element
					if (i + 1 < groupOrderedNavigationSets.length) {
						query += ','
					}
				}
				
				/*
				//tack on an extra navigation set
				if (includeSet) {
					//last item was a ?, add another comma
					if (utils.stringRight(query,1) == '?') {
						query += ','
					}
					query += '?'
					args[args.length] = includeSet
				}
				*/
			query += ')'
		var dataset = databaseManager.getDataSetByQuery(serverName, query, args, maxReturnedRows)
		
		var groupNavigationSets = dataset.getColumnAsArray(1)
		var groupNavSetNames = dataset.getColumnAsArray(2)
		var groupNavSetDefault = dataset.getColumnAsArray(3)
		
		//nothing configured for this group, exit
		if (!groupNavigationSets || groupNavigationSets.length == 0) {
			return false
		}
		
		//compare group with standard - remove non-active items
		for (var i = 0; i < groupNavigationSets.length; i++) {
			var found = false
			for (var j = 0; j < navigationSets.length && !found; j++) {
				if (groupNavigationSets[i] == navigationSets[j]) {
					found = true
				}
			}
			
			//remove from group -- no longer an option at the main level in frameworks
			if (!found) {
				groupNavigationSets.splice(i,1)
				groupNavSetNames.splice(i,1)
				groupNavSetDefault.splice(i,1)
			}
		}
		
		//assign over values; re-init
		var navigationSets = new Array()
		var navSetNames = new Array()
		var navSetDefault = new Array()
		
		
		//order correctly
		for (var i = 0; i < groupOrderedNavigationSets.length; i++) {
			var found = false
			for (var j = 0; j < groupNavigationSets.length && !found; j++) {
				if (groupOrderedNavigationSets[i] == groupNavigationSets[j]) {
					found = true
					navigationSets.push(groupNavigationSets[j])
					navSetNames.push(groupNavSetNames[j])
					navSetDefault.push(groupNavSetDefault[j])
				}
			}
		}
	}
	
	//actually using navPrefs for the current session
	if (!returnPrefs) {
		//set value list used for changing navigation sets
		application.setValueListItems('NAV_navigation_set', navSetNames, navigationSets)
	}
	
	//add in hidden frameworks configuration set items
	navigationSets.push(solutionPrefs.config.navigationSetID)
	navSetNames.push('configPanes')
	navSetDefault.push(null)
	
	//create objects the first time around
	if (initialLoad) {
		navPrefs.byNavSetName = new Object()
		navPrefs.byNavSetID = new Object()
		navPrefs.byNavItemID = new Object()
	}
	//remove sets that are no longer present
	else {
		//byNavItemID nodes that are OK to keep
		var processedNavItems = new Array()
		
		//for every existing navigation set
		for (var i in navPrefs.byNavSetName) {
			//if looking at a relic that has already been cleared out, ignore
			if (navPrefs.byNavSetName[i]) {
				//loop through all current navigation sets looking for a match
				var found = false
				for (var j = 0; j < navigationSets.length && !found; j++) {
					if (navPrefs.byNavSetName[i].navSetID == navigationSets[j]) {
						found = true
					}
				}
				
				//match not found, null out all children and then the parent
				if (!found) {
					var oldSetID = navPrefs.byNavSetName[i].navSetID
					
					//clear out by name
					for (var j = 0; j < navPrefs.byNavSetName[i].itemsByOrder.length; j++) {
						navPrefs.byNavSetName[i].itemsByOrder[j] = null
					}
					navPrefs.byNavSetName[i] = null
					
					//clear out by id
					navPrefs.byNavSetID[oldSetID] = null
				}
			}
		}
	}
	
	//build navPrefs
	for (var i = 0; i < navigationSets.length; i++) {
		//check if this set already exists
		if (navPrefs.byNavSetName[navSetNames[i]] && navPrefs.byNavSetName[navSetNames[i]] != null) {
			var setExists = true
			
			//lastly selected navItem
			var navItemLast = navPrefs.byNavSetID[navigationSets[i]].lastNavItem
			
			//remove byNavSetName container (will be rebuilt)
			navPrefs.byNavSetID[navigationSets[i]] =
			navPrefs.byNavSetName[navSetNames[i]] = 
								{
							itemsByName : new Array(),
							itemsByOrder : new Array(),
							navSetID : navigationSets[i],
							navSetName : navSetNames[i]
						}
		}
		//add navigation set
		else {
			var setExists = false
			
			navPrefs.byNavSetID[navigationSets[i]] =
			navPrefs.byNavSetName[navSetNames[i]] = 
								{
							itemsByName : new Array(),
							itemsByOrder : new Array(),
							navSetID : navigationSets[i],
							navSetName : navSetNames[i]
						}
		}
		
		//punch down which navigation set is the default
		if (navSetDefault[i]) {
			navPrefs.byNavSetID.defaultSet = navigationSets[i]
		}
		
		//get all nav items for this set
		var query = 'SELECT id_navigation_item ' +
					'FROM sutra_navigation_item ' +
					'WHERE id_navigation = ? '
		var args = [navigationSets[i]]
		
		var navigationItems = databaseManager.getFoundSet(serverName,'sutra_navigation_item')
		navigationItems.loadRecords(query,args)
		
		if (utils.hasRecords(navigationItems)) {
			navigationItems.sort('node_1 asc, node_2 asc')
			
			//loop through nav items and pop down that information to the client side
			for (var j = 1; j <= navigationItems.getSize(); j++) {
				var record = navigationItems.getRecord(j)
				
				//mark this record as an OK node to keep
				if (!initialLoad) {
					processedNavItems.push(record.id_navigation_item)
				}
				
				//create nav item node(s)
				navPrefs.byNavSetName[navSetNames[i]].itemsByName[record.item_name] = 
				navPrefs.byNavSetName[navSetNames[i]].itemsByOrder[j-1] = 
				navPrefs.byNavItemID[record.id_navigation_item] = 
					globals.NAV_navigation_item_load(record,setExists)
			}
			
			//try to stay on the same navigation item if it is still available
			if (navItemLast) {
				var foundItem = false
				for (var j = 0; j < navPrefs.byNavSetID[navigationSets[i]].itemsByOrder.length && !foundItem; j++) {
					if (navPrefs.byNavSetID[navigationSets[i]].itemsByOrder[j].navigationItem.idNavigationItem == navItemLast) {
						foundItem = true
						navPrefs.byNavSetID[navigationSets[i]].lastNavItem = navItemLast
					}
				}
			}
		}
	}
	
	//TODO: would be better to remove
	//null out navItems that are no longer valid
	if (!initialLoad) {
		for (var i in navPrefs.byNavItemID) {
			//loop through all valid navigation items looking for a match
			var found = false
			for (var j = 0; j < processedNavItems.length && !found; j++) {
				if (i == processedNavItems[j] ) {
					found = true
				}
			}
			
			//remove if not found and it is something
			if (navPrefs.byNavItemID[i] && !found) {
				navPrefs.byNavItemID[i] = null
			}
		}
	}
	
	//return navPrefs to be saved into group record
	if (returnPrefs) {
		return navPrefs
	}
	//navPrefs successfully built
	else {
		return true
	}
}


}

/**
 *
 * @properties={typeid:24,uuid:"cde50863-6a16-48bf-bbe8-fd954c21e003"}
 */
function NAV_navigation_item_load()
{

/*
 *	TITLE    :	NAV_navigation_item_load
 *			  	
 *	MODULE   :	ds_NAV_engine
 *			  	
 *	ABOUT    :	given a navigation item record the corresponding node is created/smartupdated
 *			  	
 *	INPUT    :	1- navigationItem record
 *			  	2- smartUpdate
 *			  	
 *	OUTPUT   :	node for passed navigation item
 *			  	
 *	REQUIRES :	
 *			  	
 *	USAGE    :	
 *			  	
 *	MODIFIED :	Jun 2008 -- Troy Elliott, Data Mosaic
 *			  	
 */

var record = arguments[0]
var smartUpdate = arguments[1]

var relationName = 'nav_navigation_item_to_navigation'
var rlnDisplay = 'nav_navigation_item_to_list_display'
var rlnFindActive = 'nav_navigation_item_to_column__find'
var rlnReplaceActive = 'nav_navigation_item_to_column__replace'

//new nav item
var navItemObj = new Object()
//old nav item
if (smartUpdate) {
	var oldNavItemObj = navigationPrefs.byNavItemID[record.id_navigation_item]
}
else {
	var oldNavItemObj = null
}

//TODO: (not)	NAV ITEM set/name information
navItemObj._about_ = '[' + record[relationName].nav_name + '] ' + record.item_name

//TODO: (not)	SPACE information
	//spaces configured
	if (record.space_available) {
		var availableSpaces = record.space_available.split('\n')
	}
	//no spaces
	else {
		var availableSpaces = new Array()//1,2,3,4,5,6,7,8,9,10,11,12,13,14)
	}
	
	//convert to numbers so they'll sort
	for (var i = 0; i < availableSpaces.length; i++) {
		availableSpaces[i] = utils.stringToNumber(availableSpaces[i])
	}
	
	availableSpaces.sort(globals.CODE_sort_numeric)
	
	var spaceRealNames = ['standard','list','vertical','centered','classic','wide','workflow',
			'standard flip','list flip','vertical flip','centered flip','classic flip','wide flip','workflow flip']
	
	//which spaces to turn on/off
	var setupSpaces = new Array()
	var loop = 0
	for (var k = 0; k < 14; k++ ) {
		//translation from number to name
			//MEMO: this is based on the button name, so is 1 greater than the array value
		setupSpaces['space_'+(k+1)] = spaceRealNames[k]
		setupSpaces[spaceRealNames[k]] = k + 1
		
		if (availableSpaces.length > loop) {
			if (availableSpaces[loop] == k + 1) {
				setupSpaces[k] = true
				loop++
			}
			else {
				setupSpaces[k] = false
			}
		}
		else {
			setupSpaces[k] = false
		}
	}
	
	//spaces allowed
	navItemObj.spaceSetup = setupSpaces
	
	//spaces currently showing  //TODO: probably should reset this every trip in/out of configuration screens
	if (oldNavItemObj && oldNavItemObj.spaceStatus) {
		navItemObj.spaceStatus = oldNavItemObj.spaceStatus
	}

//TODO: (not)	BLUEPRINT of navigation item information
	navItemObj.navigationItem = globals.CODE_record_object(record,true,true)

//TODO: (not)	LIST status information
	if (record.use_fw_list) {
		navItemObj.listData = {
						clientUUID : solutionPrefs.clientInfo.servoyUUID,
						dateAdded : (oldNavItemObj) ? oldNavItemObj.listData.dateAdded : null,
						dateFullRefresh : (oldNavItemObj) ? oldNavItemObj.listData.dateFullRefresh : null,
						dateModified : (oldNavItemObj) ? oldNavItemObj.listData.dateModified : null,
						display : 0,
						headerHTML : (oldNavItemObj) ? oldNavItemObj.listData.headerHTML : null,
						lastSpace : (oldNavItemObj) ? oldNavItemObj.listData.lastSpace : null,
						tabFormInstance : (oldNavItemObj) ? oldNavItemObj.listData.tabFormInstance : null,
						tabNumber : (oldNavItemObj) ? oldNavItemObj.listData.tabNumber : null,
						
						foundsets : (oldNavItemObj) ? oldNavItemObj.listData.foundsets : new Object(),
						index :	(oldNavItemObj) ? oldNavItemObj.listData.index : {
										selected : null,
										start : null,
										end : null
									},
						visitedPKs : (oldNavItemObj) ? oldNavItemObj.listData.visitedPKs : new Object(),
						withButtons : (oldNavItemObj) ? oldNavItemObj.listData.withButtons : null
					}
	
	}
	else {
		//TODO: I'd like a ternary or something here to only set the properties to undefined if they already exist
		navItemObj.listData = {
						dateAdded : (oldNavItemObj) ? oldNavItemObj.listData.dateAdded : null,
						lastSpace : (oldNavItemObj) ? oldNavItemObj.listData.lastSpace : null,
						tabNumber : (oldNavItemObj) ? oldNavItemObj.listData.tabNumber : null
					}
		
	}
	
	//only add fast find, power replace, and filter restrictions to non-navigation items
	if (record.id_navigation != solutionPrefs.config.navigationSetID) {
//TODO: (not)	FAST FIND information
		globals.CODE_ddarray_field = 'findName'
		
		//if there are active find items OR a 'copy' of previously active find items
		//if (utils.hasRecords(record[rlnFindActive]) || (oldNavItemObj && oldNavItemObj.fastFind)) {
			//if findValues doesn't exist or is not the same size as the currently active find items
			//if ((oldNavItemObj && oldNavItemObj.fastFind) ? ((oldNavItemObj && oldNavItemObj.fastFind).length != record[rlnFindActive].getSize()) : true) {
				//overwrite/create fast find node
				var findFast = globals.NAV_find_load(record)
				//check to see if there are finds
				if (findFast.length) {
					navItemObj.fastFind = findFast
				}
		//	}
		//}
	
//TODO: (not)	POWER REPLACE information
		globals.CODE_ddarray_field = 'replaceName'
		
		//if there are active replace items OR a 'copy' of previously active replace items
		//if (utils.hasRecords(record[rlnReplaceActive]) || (oldNavItemObj && oldNavItemObj.powerReplace)) {
			//if replaceValues doesn't exist or is not the same size as the currently active replace items
			//if ((oldNavItemObj && oldNavItemObj.powerReplace) ? (oldNavItemObj && oldNavItemObj.powerReplace.length != record[rlnReplaceActive].getSize()) : true) {
				//overwrite/create power replace node
				var replacePower = globals.NAV_replace_load(record)
				//check to see if there are replaces
				if (replacePower.length) {
					navItemObj.powerReplace = replacePower
				}
			//}
		//}
		
//TODO: (not)	FILTER RESTRICTIONS information
		var restrictFilter = globals.NAV_navigation_item_filter_load(record)
		
		//check to see if there are filters
		if (restrictFilter.length) {
			navItemObj.filters = {
							blueprint : restrictFilter,
							history : new Array()
						}
			
			/*
			//dynamic specs?
			var dynamicFilters = false
			
			//check for type of all filter spec items to see if there are any based on a Function
			for (var i = 0; i < restrictFilter.length && !dynamicFilters; i++) {
				if (restrictFilter[i].filterType == 'Function') {
					dynamicFilters = true
				}
			}
			
			//one or more parameters are dynamic (based on the return of a Function)
				//history stack is required
			if (dynamicFilters) {
				navItemObj.filters.history = new Array()
			}
			*/
		}
	}

//TODO: (not)	UNIVERSAL LIST blueprint information
	if (record.use_fw_list) {
		//main container
		navItemObj.universalList = {
						displays : new Array(),
						buttons : new Object()
					}
		
		if (oldNavItemObj && oldNavItemObj.universalList && 	oldNavItemObj.universalList.displays) {
			var oldDisplayID = oldNavItemObj.universalList.displays.displayID
		}
		
		//load list display values
		globals.CODE_ddarray_field = 'displayDefault'
		
		//if there are active display
		if (utils.hasRecords(record[rlnDisplay])) {
			//overwrite/create displays node
			navItemObj.universalList.displays = globals.NAV_display_load(record)
			
			//try to stay on the same display
			if (oldDisplayID && oldDisplayID != navItemObj.universalList.displays.displayID) {
				var found = false
				for (var i = 0; i < navItemObj.universalList.displays.length && !found; i++) {
					if (navItemObj.universalList.displays[i].displayID == oldDisplayID) {
						 navItemObj.universalList.displays.displayPosn = i
						 navItemObj.universalList.displays.displayID = oldDisplayID
					}
				}
				
				//refire UL redraw - the current display is no longer available
				if (!found) {
					
				}
			}
		}
		
		//load buttons
		var relnButton = 'nav_navigation_item_to_action_item'
		var relnFilter = 'nav_action_item_to_action_item_filter'
		
		//relation valid
		if (utils.hasRecords(record[relnButton])) {
			//sort	//MEMO: this works fine for filters, but everything else must be resorted at the end
			record[relnButton].sort('category asc, id_action_item_parent asc, order_by asc')
			
			//go through all action items and put them into the correct container
			for (var m = 1; m <= record[relnButton].getSize(); m++) {
				var recordButton = record[relnButton].getRecord(m)
				var subItem = globals.CODE_record_object(recordButton,true,true,['method_from_form','method_from_custom'])
				
				switch (subItem.category) {
					case 'Add':
						//check that button turned on
						if (record.bar_item_add) {
							//assign subItem
							navItemObj.universalList.buttons.add = subItem
						}
						
						break
					case 'Actions':
						//check that button turned on
						if (record.bar_item_action) {
							//create array if none exists
							if (!navItemObj.universalList.buttons.actions) {
								navItemObj.universalList.buttons.actions = new Array()
							}
							
							//assign subItem to last position
							navItemObj.universalList.buttons.actions.push(subItem)
						}
						
						break
					case 'Filters':
						//check that button turned on
						if (record.bar_item_filter) {
							//create array if none exists
							if (!navItemObj.universalList.buttons.filters) {
								navItemObj.universalList.buttons.filters = new Array()
							}
							
							//tare out last value
							var filterNode = null
							
							//check for type of filter
							switch (subItem.filterType) {
								//specific instructions
								case 0:
								case null:
								case undefined:
									
									//if filter specs
									if (utils.hasRecords(recordButton[relnFilter])) {
										//create array for filter specs
										var filterNode = new Array()
										
										//add menu name
										filterNode.menuName = (subItem.menuName) ? subItem.menuName : null
										
										//add post processing information
										filterNode.postSort = (subItem.filterSort) ? subItem.filterSort : null
										filterNode.postMethod = (subItem.filterMethod) ? subItem.filterMethod : null
										filterNode.postLimit = (subItem.filterLimit) ? subItem.filterLimit : null
										
										//go through all filter spec items
										for (var i = 1; i <= recordButton[relnFilter].getSize(); i++) {
											var recordFilterItem = recordButton[relnFilter].getRecord(i)
											
											//plop down filter spec
											filterNode.push(globals.CODE_record_object(recordFilterItem,true,true))
										}
									}
									
									break
								//sublist of filters
								case 1:
									var filterNode = new Array()
									
									//add menu name
									filterNode.menuName = subItem.menuName
									filterNode.actionID = subItem.idActionItem
									
									break
								//derived at runtime
								case 2:
									//if filter specs
									if (utils.hasRecords(recordButton[relnFilter])) {
										var recordFilterItem = recordButton[relnFilter].getRecord(1)
										
										//only create if there is a valuelist assigned
										if (recordFilterItem.valuelist) {
											var filterNode = {
														menuName : subItem.menuName,
														columnRelation : recordFilterItem.column_relation,
														columnName : recordFilterItem.column_name,
														operator : recordFilterItem.column_operator,
														valuelist : recordFilterItem.valuelist,
														valuelistType : recordFilterItem.valuelist_type,
														postSort : (subItem.filterSort) ? subItem.filterSort : null,
														postMethod : (subItem.filterMethod) ? subItem.filterMethod : null,
														postLimit : (subItem.filterLimit) ? subItem.filterLimit : null
													}
										}
									}
										
									break
							}
							
							//if a valid node, determine where it should be added
							if (filterNode) {
								//added to some subtree
								if (subItem.idActionItemParent) {
									var found = false
									
									//SUB 1
									for (var j = 0; j < navItemObj.universalList.buttons.filters.length && !found; j++) {
										//this node has children
										if (navItemObj.universalList.buttons.filters[j].actionID) {
												//check node itself
												if (navItemObj.universalList.buttons.filters[j].actionID == subItem.idActionItemParent) {
														found = true
														navItemObj.universalList.buttons.filters[j].push(filterNode)
												}
												
												//SUB2
												for (var k = 0; k < navItemObj.universalList.buttons.filters[j].length && !found; k++) {
														//check node itself
														if (navItemObj.universalList.buttons.filters[j][k].actionID == subItem.idActionItemParent) {
																found = true
																navItemObj.universalList.buttons.filters[j][k].push(filterNode)
														}	
												}
										}
									}
								}
								//added to MAIN MENU
								else {
									navItemObj.universalList.buttons.filters.push(filterNode)
								}
							}
						}
						
						break
					case 'Reports':
						//check that button turned on
						if (record.bar_item_report) {
							//create array if none exists
							if (!navItemObj.universalList.buttons.reports) {
								navItemObj.universalList.buttons.reports = new Array()
							}
							
							//assign subItem to last position
							navItemObj.universalList.buttons.reports.push(subItem)
						}
						
						break
					case 'Tabs':
						//check that button turned on
						if (record.bar_item_tab) {
							//create array if none exists
							if (!navItemObj.universalList.buttons.tabs) {
								navItemObj.universalList.buttons.tabs = new Array()
							}
							
							//assign subItem to last position
							navItemObj.universalList.buttons.tabs.push(subItem)
						}
						
						break
				}
			}
		
			//resort actions, reports, and tabs
			var reSort = new Array('actions','reports','tabs')
			globals.CODE_ddarray_field = 'orderBy'
			
			for (var i = 0; i < reSort.length; i++) {
				//check if that item is even present
				if (navItemObj.universalList.buttons[reSort[i]]) {
					navItemObj.universalList.buttons[reSort[i]].sort(globals.CODE_sort_dd_array)
				}
			}
		}
	}



return navItemObj


}

/**
 *
 * @properties={typeid:24,uuid:"c5bf1fef-c57d-486f-ae80-9e7355fa77c5"}
 */
function NAV_preference_load()
{

/*
 *	TITLE    :	NAV_preference_load
 *			  	
 *	MODULE   :	ds_NAV_engine
 *			  	
 *	ABOUT    :	this method loads in the appropriate CONFIGURATION list and form views
 *			  	
 *	INPUT    :	formName to load
 *			  	
 *	OUTPUT   :	
 *			  	
 *	REQUIRES :	solutionPrefs
 *			  	
 *	MODIFIED :	Mar 25, 2008 -- Troy Elliott, Data Mosaic
 *			  	
 */

if (application.__parent__.solutionPrefs) {
	
//MEMO: need to somehow put this section in a Function of it's own
//running in Tano...strip out jsevents for now
if (utils.stringToNumber(application.getVersion()) >= 5) {
	//cast Arguments to array
	var Arguments = new Array()
	for (var i = 0; i < arguments.length; i++) {
		Arguments.push(arguments[i])
	}
	
	//reassign arguments without jsevents
	arguments = Arguments.filter(globals.CODE_jsevent_remove)
}
	
	var prefPane = arguments[0]
	var prefNavID = arguments[1]
	var formNamePref = 'NAV_R_navigation_item'
	var baseForm = solutionPrefs.config.formNameBase
	
	var navTab
	var listTab
	var mainTab
	
	//save information about current config space setup, but not the first time (it would punch down on workflow instead)
	if (solutionPrefs.config.prefs.workflowFormID && solutionPrefs.config.currentFormID && solutionPrefs.config.prefs.workflowFormID != solutionPrefs.config.currentFormID && navigationPrefs.byNavItemID[solutionPrefs.config.currentFormID]) {
		navigationPrefs.byNavItemID[solutionPrefs.config.currentFormID].spaceStatus = new Array()
		navigationPrefs.byNavItemID[solutionPrefs.config.currentFormID].spaceStatus.lastSpace = solutionPrefs.config.activeSpace
		
		for (var i = 1; i <= 14; i++) {
			navigationPrefs.byNavItemID[solutionPrefs.config.currentFormID].spaceStatus.push(forms[baseForm + '__header'].elements['btn_space_' + i].visible)
		}
	}
	
	//specs for this form
	var navSpecs = navigationPrefs.byNavItemID[prefNavID].navigationItem
	
	//deactivate help-mode
	solutionPrefs.config.helpMode = false

	//if special case navset area, load it; otherwise load blank
	if (navSpecs.itemName == 'Navigation engine') {
		navTab = 'NAV_0L_navigation'
	}
	else if (navSpecs.itemName == 'Access & control') {
		navTab = 'AC_0L_options'
	}
	else if (navSpecs.itemName == 'Solution configuration') {
		navTab = 'MGR_0L__solution_config'
	}
	else if (navSpecs.itemName == 'Deployment') {
		navTab = 'DPLY_0L__deployment'
	}
	else if (navSpecs.itemName == 'Developer tools') {
		navTab = 'DEV_0L_options'
	}
	if (!forms[navTab]) {
		navTab = 'DATASUTRA_0F_solution__blank_3'
	}
	
	//get form to load; if selected value is not available in solution, load blank
	if (navSpecs.formToLoad) {
		mainTab = navSpecs.formToLoad
	}
	if (!forms[mainTab]) {
		mainTab = 'DATASUTRA_0F_solution__blank_1'
	}
	else {
		var serverName = forms[mainTab].controller.getServerName()
		var tableName = forms[mainTab].controller.getTableName()
	}
	
	//set new current form so universal list will fire correctly
	solutionPrefs.config.currentFormName = mainTab
	solutionPrefs.config.currentFormID = prefNavID
	
	//if using custom list, get it if it is available in solution, otherwise load blank list
	listTab = (navSpecs.useFwList) ? 'NAV_0L_universal_list' : navSpecs.listToLoad
	//if form is not available in solution, load blank list
	if (!listTab && !forms[listTab]) {
		listTab = 'DATASUTRA_0F_solution__blank_2'
	}
	
	//spaces configured
	var spaceStatus = navigationPrefs.byNavItemID[prefNavID].spaceSetup
	
	//load navigation window
	if (forms[baseForm].elements.tab_content_A.tabIndex > 0) {
		forms[baseForm].elements.tab_content_A.removeTabAt(1)
	}
	forms[baseForm].elements.tab_content_A.addTab(forms[navTab],'',null,null,null,null)
	forms[baseForm].elements.tab_content_A.tabIndex = forms[baseForm].elements.tab_content_A.getMaxTabIndex()
	
	//load list window
	//form not yet added, add to lists tab panel
	if (listTab != 'DATASUTRA_0F_solution__blank_2' && navigationPrefs.byNavItemID[prefNavID] && !globals.NAV_universal_list_get_status(navigationPrefs.byNavItemID[prefNavID].listData)) {
		//create new form instances for UL
		if (navSpecs.useFwList) {
			//3.5 hacked UL
			if (utils.stringToNumber(solutionPrefs.clientInfo.verServoy) < 4) {	
				var uniList = 'NAV_0L_universal_list'
				//new form name
				var newFormName = uniList + '__preference_item' + prefNavID + '_' + mainTab
				
				//if form not already defined, define and assign 200 record chunk
				if (!forms[newFormName]) {
					//create new form instances
					var success = application.createNewFormInstance(uniList,newFormName)
					var success = application.createNewFormInstance(uniList+'_1L',newFormName+'_1L')
					
					//assign secondary form to UL
					forms[newFormName].elements.tab_ul.removeAllTabs()
					forms[newFormName].elements.tab_ul.addTab(forms[newFormName+'_1L'],'UL Records',null,null,null,null)
					
					//assign UL to list tab panel
					forms[baseForm].elements.tab_content_B.addTab(forms[newFormName],newFormName,null,null,null,null)
					forms[baseForm].elements.tab_content_B.tabIndex = forms[baseForm].elements.tab_content_B.getMaxTabIndex()
					
					//foundset count
					var foundsetCount = databaseManager.getFoundSetCount(forms[mainTab].foundset)
					
					//get records
					var dsUniversalList = databaseManager.getDataSetByQuery(
									forms[baseForm].controller.getServerName(), 
									'SELECT id_universal_list FROM sutra_universal_list WHERE id_universal_list >= ?',
									[navigationPrefs.foundsetPool.nextFreePK],
									forms[mainTab].foundset.getSize() + 1)
									//(foundsetCount == forms[mainTab].foundset.getSize()) ? forms[mainTab].foundset.getSize() + 1 : forms[mainTab].foundset.getSize())
					var pkUL = dsUniversalList.getColumnAsArray(1)
					
					//save next pk down; and remove it from array
					navigationPrefs.foundsetPool.nextFreePK = pkUL.pop()
					
					//punch down foundset onto form via pk array
					forms[newFormName+'_1L'].foundset.loadRecords(databaseManager.convertToDataSet(pkUL))
					
					//save status info
					navigationPrefs.byNavItemID[prefNavID].listData.foundsets.blueprint = pkUL
					navigationPrefs.byNavItemID[prefNavID].listData.foundsets.current = forms[newFormName+'_1L'].foundset
					navigationPrefs.byNavItemID[prefNavID].listData.tabFormInstance = newFormName
					navigationPrefs.byNavItemID[prefNavID].listData.tabNumber = forms[baseForm].elements.tab_content_B.getMaxTabIndex()
					navigationPrefs.byNavItemID[prefNavID].listData.dateAdded = application.getServerTimeStamp()
				}
			}
			
			//4.1 Solution Model
			else if (utils.stringToNumber(solutionPrefs.clientInfo.verServoy) >= 4) {
				var uniList = 'NAV_T_universal_list_1L'
				
				//new form name (UL__preference_item000_CRM_0F_companies)
				var newFormName = 'UL' + '__preference_item' + prefNavID + '_' + mainTab
				
				//if form not already defined, define
				if (!forms[newFormName]) {
					//create new forms
					var template = globals.NAV_universal_list_form_to_template(uniList)
					var myForm = globals.NAV_universal_list_template_to_form(template,newFormName)
					
					//set datasource
					myForm.serverName = serverName
					myForm.tableName = tableName
					
					//set events
					myForm.onShow = solutionModel.getGlobalMethod('NAV_universal_list_show')
					myForm.onRecordSelection = solutionModel.getGlobalMethod('NAV_universal_list_select')
					myForm.rowBGColorCalculation = 'globals.NAV_row_background'
					
					//get the UL data and set it up
					var allULDisplays = navigationPrefs.byNavItemID[prefNavID].universalList.displays
					var initialUL = allULDisplays[allULDisplays.displayPosn].rawDisplay
					
					for (var i = 0; i < initialUL.length; i++) {
						var lineItem = initialUL[i]
						
						//determine alignment
						var horizAlign = 2
						switch (lineItem.align) {
							case 'left':
								horizAlign = 2
								break
							case 'right':
								horizAlign = 4
								break
							case 'center':
								horizAlign = 0
								break
						}
						
						var fieldFormat = null
						var fieldVL = null
						
						//determine format
						if (lineItem.formatMask == 'Number' || lineItem.formatMask == 'Date') { // || lineItem.formatMask == 'Text') {
							var fieldFormat = lineItem.format
						}
						else if (lineItem.formatMask == 'Valuelist') {
							var fieldVL = lineItem.format
						}	
						
						//TODO: check for better name
						var nameNameField = (lineItem.rowDisplay[0].isField) ? lineItem.rowDisplay[0].value : lineItem.fieldName
						
						//TODO: error checking for contents of rawDisplay
						if (!nameNameField) {
							continue
						}
						
						//create field
						var myField = myForm.newTextField(
										nameNameField,			//dataprovider
										i,						//x
										0,						//y
										lineItem.width,			//width
										20						//height
									)
						
						myField.setOnFocusGainedMethod(globals.NAV_universal_list_select__unhilite)		
						myField.anchors = SM_ANCHOR.ALL
						myField.horizontalAlignment = horizAlign
						myField.styleClass = 'customlist'
						myField.editable = false
						myField.borderType = 'EmptyBorder,0,0,0,0'
						myField.margin = '0,4,0,4'
						myField.scrollbars = 0
						myField.transparent = false
						myField.text = (lineItem.header) ? lineItem.header : nameNameField
						if (fieldFormat) {
							myField.format = fieldFormat
						}
						if (fieldVL) {
							myField.valuelist = solutionModel.getValueList(fieldVL)
						}
					}
					
					//assign the secondary form to the main UL
					forms.NAV_T_universal_list.elements.tab_ul.addTab(forms[newFormName],'Prefs',null,null,null,null)
					
					//save status info
					navigationPrefs.byNavItemID[prefNavID].listData.tabFormInstance = newFormName
					navigationPrefs.byNavItemID[prefNavID].listData.tabNumber = forms.NAV_T_universal_list.elements.tab_ul.getMaxTabIndex()
					navigationPrefs.byNavItemID[prefNavID].listData.dateAdded = application.getServerTimeStamp()
					
					//switch to this tab
					forms.NAV_T_universal_list.FORM_on_show(true)
					forms[baseForm].elements.tab_content_B.tabIndex = 2
					forms.NAV_T_universal_list.elements.tab_ul.tabIndex = navigationPrefs.byNavItemID[prefNavID].listData.tabNumber
				}
			}
		}
		//add non-UL form to the list as a new tab
		else {
			//assign to list tab panel
			forms[baseForm].elements.tab_content_B.addTab(forms[listTab],'',null,null,null,null)
			forms[baseForm].elements.tab_content_B.tabIndex = forms[baseForm].elements.tab_content_B.getMaxTabIndex()
			
			//save status info
			navigationPrefs.byNavItemID[prefNavID].listData.tabNumber = forms[baseForm].elements.tab_content_B.tabIndex
			navigationPrefs.byNavItemID[prefNavID].listData.dateAdded = application.getServerTimeStamp()
		}
	}
	//blank form, set to blank tab
	else if (listTab == 'DATASUTRA_0F_solution__blank_2') {
		forms[baseForm].elements.tab_content_B.tabIndex = 1
		
		//save status info
		navigationPrefs.byNavItemID[prefNavID].spaceSetup = spaceStatus
	}
	//form already exists, set tab index to selected preference
	//form already exists, set tab index
	else {
		//3.5
		if (utils.stringToNumber(solutionPrefs.clientInfo.verServoy) < 4) {
			forms[baseForm].elements.tab_content_B.tabIndex = navigationPrefs.byNavItemID[prefNavID].listData.tabNumber
		}
		//>=4
		else if (utils.stringToNumber(solutionPrefs.clientInfo.verServoy) >= 4) {
			//UL, set to 2 and then correct tab
			if (navSpecs.useFwList) {
				if (navigationPrefs.byNavItemID[prefNavID].listData.withButtons) {
					forms.NAV_T_universal_list.FORM_on_show(true)
					forms[baseForm].elements.tab_content_B.tabIndex = 2
					forms.NAV_T_universal_list.elements.tab_ul.tabIndex = navigationPrefs.byNavItemID[prefNavID].listData.tabNumber
				}
				else {
					forms.NAV_T_universal_list__no_buttons.FORM_on_show(true)
					forms[baseForm].elements.tab_content_B.tabIndex = 3
					forms.NAV_T_universal_list__no_buttons.elements.tab_ul.tabIndex = navigationPrefs.byNavItemID[prefNavID].listData.tabNumber
				}
			}
			//set to correct tab
			else {
				forms[baseForm].elements.tab_content_B.tabIndex = navigationPrefs.byNavItemID[prefNavID].listData.tabNumber
			}
		}
	}
	
	//normal workflow load
	if (navTab != 'AC_0L_options' && navTab != 'MGR_0L__solution_config' && navTab != 'DPLY_0L__deployment' && navTab != 'DEV_0L_options') {
		//remove main window if new one different than currently displayed one
		if (forms[baseForm].elements.tab_content_C.tabIndex > 0  && (forms[baseForm].elements.tab_content_C.getTabFormNameAt(1) != mainTab)) {
			forms[baseForm].elements.tab_content_C.removeTabAt(1)
		}
		//load main window if no tab currently there
		if (!forms[baseForm].elements.tab_content_C.getMaxTabIndex()) {
			forms[baseForm].elements.tab_content_C.addTab(forms[mainTab],'')
			forms[baseForm].elements.tab_content_C.tabIndex = forms[baseForm].elements.tab_content_C.getMaxTabIndex()
		}
	}
	
	//clear globals
	globals.DATASUTRA_find = null
	globals.DATASUTRA_find_field = null
	//forms[baseForm + '__header'].elements.find_end.setImageURL('media:///find_end.png')
	
	//if using UL in 35 and active space different than last space, refresh UL
	if (navSpecs.useFwList && (utils.stringToNumber(solutionPrefs.clientInfo.verServoy) < 4) && 
		navigationPrefs.byNavItemID[prefNavID].spaceStatus && 
		navigationPrefs.byNavItemID[prefNavID].spaceStatus.lastSpace && 
		navigationPrefs.byNavItemID[prefNavID].spaceStatus.lastSpace != solutionPrefs.config.activeSpace) {
		
		forms[navigationPrefs.byNavItemID[prefNavID].listData.tabFormInstance].UL_fill_data()
	}
	
	//set check on display pop-down
	//this form has been visited before and has a default display
	if (navigationPrefs.byNavItemID[prefNavID].universalList && navigationPrefs.byNavItemID[prefNavID].universalList.displays && navigationPrefs.byNavItemID[prefNavID].universalList.displays.displayID) {
		globals.DATASUTRA_display = navigationPrefs.byNavItemID[prefNavID].universalList.displays.displayID
	}
	//no displays configured
	else {
		globals.DATASUTRA_display = null
	}
	
	//if above globals.DATASUTRA_find, set appropriate end graphics
/*	if (globals.DATASUTRA_find) {
		forms[baseForm + '__header'].elements.find_end.setImageURL('media:///find_stop.png')
	}
	else {
		forms[baseForm + '__header'].elements.find_end.setImageURL('media:///find_end.png')
	}	*/
	
	//SPACES setup
	var spacesOK = navigationPrefs.byNavItemID[prefNavID].spaceSetup
	var sessionSpaces = navigationPrefs.byNavItemID[prefNavID].spaceStatus
	
	//activate default space if there is one, it is different than current space;  do this on first time form loaded and all subsequent times until space changed while on this navItem
	if (navSpecs.spaceDefault && spacesOK['space_' + (navSpecs.spaceDefault)] != solutionPrefs.config.activeSpace && (!sessionSpaces || ((sessionSpaces && sessionSpaces.lastSpace && sessionSpaces.lastSpace == spacesOK['space_' + navSpecs.spaceDefault]) ? true : false))) {
		globals.DS_space_change('btn_space_'+navSpecs.spaceDefault,true)
	}
	//current space is not allowed for this item, 
	else if (solutionPrefs.config.activeSpace && !spacesOK[spacesOK[solutionPrefs.config.activeSpace] - 1]) {
		//activate last space on for this item
		if (sessionSpaces && sessionSpaces.lastSpace && sessionSpaces.lastSpace != solutionPrefs.config.activeSpace) {
			globals.DS_space_change('btn_space_'+spacesOK[sessionSpaces.lastSpace],true)
		}
		//activate first allowable space
		else {
			var escape = false
			for (var i = 0; i < spacesOK.length && !escape; i++) {
				if (spacesOK[i]) {
					escape = true
					globals.DS_space_change('btn_space_' + (i+1),true)
				}
			}
		}
	}
	
	var borderEnabled = 'MatteBorder,0,0,0,1,#333333'
	var borderDisabled = 'MatteBorder,0,0,0,1,#797778'
	//enabled status specified for different spaces
	for (var i = 1; i <= 14; i++) {
		forms[baseForm + '__header'].elements['btn_space_' + i].enabled = spacesOK[i-1]
		
		if (i != 1 && i != 8) {
			forms[baseForm + '__header'].elements['btn_space_' + i].setBorder(spacesOK[i-1] ? borderEnabled : borderDisabled)
		}
	}
	
	//form visited before, use space setup as of the last visit
	if (sessionSpaces) {
		for (var i = 0; i < 14; i++) {
			forms[baseForm + '__header'].elements['btn_space_'+(i+1)].visible = sessionSpaces[i]
		}
	}
	//decide which space options are showing first based on defaults for this form
	else {
		var flipPreference = (navSpecs.spaceFlip) ? true : false
		
		for (var i = 0, j = i + 7; i < 7; i++, j++) {
			//both available, take spaceFlip preference
			if (spacesOK[i] && spacesOK[j]) {
				forms[baseForm + '__header'].elements['btn_space_'+(i+1)].visible = !flipPreference
				forms[baseForm + '__header'].elements['btn_space_'+(j+1)].visible = flipPreference
			}
			//only flip available, show it
			else if (spacesOK[j]) {
				forms[baseForm + '__header'].elements['btn_space_'+(i+1)].visible = false
				forms[baseForm + '__header'].elements['btn_space_'+(j+1)].visible = true
			}
			//only normal or neither available, show normal
			else {
				forms[baseForm + '__header'].elements['btn_space_'+(i+1)].visible = true
				forms[baseForm + '__header'].elements['btn_space_'+(j+1)].visible = false
			}
		}
	}
	
	//make sure active space's button is showing
	if (!forms[baseForm + '__header'].elements['btn_space_'+spacesOK[solutionPrefs.config.activeSpace]].visible) {
		//if not visible, turn on and do the opposite for it's complement
		
		//get other value
		if (spacesOK[solutionPrefs.config.activeSpace] < 8) {
			var complement = spacesOK[solutionPrefs.config.activeSpace] + 7
		}
		else {
			var complement = spacesOK[solutionPrefs.config.activeSpace] - 7
		}
		
		forms[baseForm + '__header'].elements['btn_space_'+spacesOK[solutionPrefs.config.activeSpace]].visible = true
		forms[baseForm + '__header'].elements['btn_space_'+complement].visible = false
	}
	
	//LOG configuration
	globals.TRIGGER_log_create('Configuration panes',
						prefPane,
						prefNavID,
						navSpecs.idNavigation,
						'Sutra configuration',
						navSpecs.itemName
						)
}



}

/**
 *
 * @properties={typeid:24,uuid:"99b59266-74d8-4630-ab77-07aeb16b7eb0"}
 */
function NAV_replace_load()
{

/*
 *	TITLE    :	NAV_replace_load
 *			  	
 *	MODULE   :	ds_NAV_engine
 *			  	
 *	ABOUT    :	returns all currently enabled replace values for a workflow form
 *			  	
 *	INPUT    :	1- navigation item record
 *			  	
 *	OUTPUT   :	array of objects; properties: replaceName, columnName, columnType, valuelist, toolTip
 *			  	
 *	REQUIRES :	globals.CODE_sort_dd_array()
 *			  	
 *	MODIFIED :	May 2008 -- Troy Elliott, Data Mosaic
 *			  	
 */

var fsNavItem = arguments[0]
var rlnReplaceActive = 'nav_navigation_item_to_column__replace'

if (fsNavItem) {
	var fsReplace = fsNavItem[rlnReplaceActive]
	
	var replaceItems = new Array()
	
	for ( var i = 1 ; i <= fsReplace.getSize() ; i++ ) {
		var replaceItem = fsReplace.getRecord(i)
		
		replaceItems.push({
			replaceName : replaceItem.name_display,
			columnType : replaceItem.type_column,
			columnName : replaceItem.name_column,
			valuelist : replaceItem.valuelist,
			replaceResource : replaceItem.replace_resource,
			replaceAllowed : replaceItem.replace_allowed,
			toolTip : null
		})
	}
	
	replaceItems.sort(globals.CODE_sort_dd_array)
	
	return replaceItems
}



}

/**
 *
 * @properties={typeid:24,uuid:"17b47971-5f9e-4549-83e9-33367936e7da"}
 */
function NAV_preference_mode_get()
{

/*
 *	TITLE    :	NAV_preference_mode_get
 *			  	
 *	MODULE   :	ds_NAV_engine
 *			  	
 *	ABOUT    :	get requested navigation_item properties
 *			  	
 *	INPUT    :	1)	config_type value (admin/user)
 *			  	2)	navigation set ID
 *			  	3)	array of navitems to show
 *			  	
 *	OUTPUT   :	1)	itemName array
 *			  	2)	formName array
 *			  	3)	navItemID array
 *			  	3)	description array
 *			  	
 *	REQUIRES :	
 *			  	
 *	MODIFIED :	Mar 24, 2008 -- Troy Elliott, Data Mosaic
 *			  	
 */

var searchValue = arguments[0]
var navID = arguments[1]
var navItemIDs = arguments[2]

var navigationSets = new Array()
var valueList = new Array()
var formList = new Array()
var detailList = new Array()


//get Admin/User modes, as specified
var navItems = (navigationPrefs.byNavSetID[navID]) ? navigationPrefs.byNavSetID[navID].itemsByOrder : new Array()

//go through both types of modes
for (var i = 0; i < navItems.length; i++) {
	//access and control requested
	if (navItemIDs) {
		var found = false
		for (var j = 0; j < navItemIDs.length && !found; j++) {
			if (navItems[i] && navItems[i].navigationItem && navItems[i].navigationItem.idNavigationItem == navItemIDs[j]) {
				found = true
			}
		}
	}
	//no access control, proceed
	else {
		var found = true
	}
	
	
	//get only the type we are interested in
	if (found && navItems[i] && navItems[i].navigationItem && navItems[i].navigationItem.configType == searchValue && navItems[i].navigationItem.rowStatusShow) {
		navigationSets.push(navItems[i].navigationItem.idNavigationItem)
		valueList.push(navItems[i].navigationItem.itemName)
		formList.push(navItems[i].navigationItem.formToLoad)
		detailList.push(navItems[i].navigationItem.description)
	}
}

return {
	itemName		: valueList,
	formName		: formList,
	navItemID		: navigationSets,
	itemDescription	: detailList
}



}

/**
 *
 * @properties={typeid:24,uuid:"d2d302dc-13b6-495e-ac6a-d29b120541bc"}
 */
function NAV_foundset_restrict()
{

/*
 *	TITLE    :	NAV_foundset_restrict
 *			  	
 *	MODULE   :	ds_NAV_engine
 *			  	
 *	ABOUT    :	filters the foundset based on any configured filters
 *			  	NOTE: this method should not be used from your code...
 *			  		Instead see globals.TRIGGER_navigation_filter_update
 *			  	
 *	INPUT    :	1- force refresh even if filters haven't changed (optional)
 *			  		- NOTE: will reset all finds/filters/etc
 *			  	2- navigationItemID of worfklow to update (optional)
 *			  	3- do not reset foundset before restricting (optional)
 *			  	
 *	OUTPUT   :	boolean whether refreshed or not
 *			  	
 *	REQUIRES :	
 *			  	
 *	USAGE    :	NAV_foundset_restrict()
 *			  	
 *	MODIFIED :	May 15, 2009 -- Troy Elliott, Data Mosaic
 *			  	
 */

//solutionPrefs defined and frameworks not in a locked status
if (application.__parent__.solutionPrefs && solutionPrefs.config && solutionPrefs.config.currentFormID && !solutionPrefs.config.lockStatus) {
	
//MEMO: need to somehow put this section in a Function of it's own
//running in Tano...strip out jsevents for now
if (utils.stringToNumber(application.getVersion()) >= 5) {
	//cast Arguments to array
	var Arguments = new Array()
	for (var i = 0; i < arguments.length; i++) {
		Arguments.push(arguments[i])
	}
	
	//reassign arguments without jsevents
	arguments = Arguments.filter(globals.CODE_jsevent_remove)
}
	
	var forceRefresh = arguments[0]
	var currentNavItem = arguments[1] || solutionPrefs.config.currentFormID
	var forceNoReset = arguments[2]
	
	var filterSetup = navigationPrefs.byNavItemID[currentNavItem].filters

	//get new values of filters
	if (filterSetup) {
		
		var theTemplate = filterSetup.blueprint
		var nowValues = globals.CODE_copy_object(filterSetup.blueprint.slice(0))
		
		//if there are filter, run
		if (theTemplate && theTemplate.length) {
			var formName = navigationPrefs.byNavItemID[currentNavItem].navigationItem.formToLoad
			var tblName = navigationPrefs.byNavItemID[currentNavItem].navigationItem.formToLoadTable
			
			//for all filter line items that call a Fxion, eval it to get the return value
			for (var i = 0; i < theTemplate.length; i++) {
				
				//a Fxion and a method specified
				if (theTemplate[i].filterType == 'Function' && theTemplate[i].methodName) {
					//if global, strip out global text
					if (theTemplate[i].methodName.indexOf('globals.',0) >= 0) {
						var method = globals[theTemplate[i].methodName.substr(8)]
					}
					else {
						var method = forms[solutionPrefs.config.currentFormName][theTemplate[i].methodName]
					}
					
					//set argument if exist, otherwise null
					var args = (theTemplate[i].columnValue) ? theTemplate[i].columnValue : null
					
					//update value
					nowValues[i].columnValue = method(args)
				}
			}
			
			//there is a history of filters
			if (filterSetup.history && filterSetup.history.length) {
				var thenValues = filterSetup.history[filterSetup.history.length - 1]
				
				//flag to quit
				var executeFilters = false
				
				//compare now with then
				for (var i = 0; i < nowValues.length; i++) {
					if (nowValues[i].columnValue != thenValues[i].columnValue) {
						executeFilters = true
					}
				}
			}
			//no history, run the filters
			else {
				var executeFilters = true
			}
			
			//we need to run the filters
			if (executeFilters || forceRefresh) {
				
				if (!forceNoReset) {
					//load all records so we can search on them
					forms[formName].foundset.loadAllRecords()
				}
				
				//start find
				forms[formName].foundset.find()
				
				//all find requests
				for (var i = 0; i < nowValues.length; i++) {
					var step = nowValues[i]
					
					var prefix = ''
					var suffix = ''
					
					switch (step.columnOperator) {
						case '>':
							prefix = '>'
							break
						case '<':
							prefix = '<'
							break
						case '>=':
							prefix = '>='
							break
						case '<=':
							prefix = '<='
							break
						case '!=':
							prefix = '!'
							break
						case 'like':
							prefix = suffix = '%'
							break
					}
					
					//if on current table, find there
					if (step.columnRelation == tblName) {
						forms[formName].foundset[step.columnName] = prefix + step.columnValue + suffix
					}
					//find through relation
					else {
						forms[formName].foundset[step.columnRelation][step.columnName] = prefix + step.columnValue + suffix
					}
				}
				
				//execute find, restricting
				if (forceNoReset) {
					var results = forms[formName].foundset.search(false,true)
				}
				//execute straight up find
				else {
					var results = forms[formName].foundset.search()
				}
				
				//log what ran and when
				if (filterSetup.history) {
					filterSetup.history.push(nowValues)
					filterSetup.history[filterSetup.history.length - 1].lastRun = application.getServerTimeStamp()
				}
				
				return true
			}
			else {
				return false
			}
		}
		else {
			return false
		}
	}
	else {
		return false
	}
}
else {
	return false
}



}

/**
 *
 * @properties={typeid:24,uuid:"a93c613f-28fa-4d50-bb58-96817e0a1710"}
 */
function NAV_navigation_set_load()
{

/*
 *	TITLE    :	NAV_navigation_set_load
 *			  	
 *	MODULE   :	ds_NAV_engine
 *			  	
 *	ABOUT    :	select correct navigation_set record
 *			  	
 *	INPUT    :	1- do not fire loadforms routine
 *			  	2- select first record in nav set
 *			  	
 *	OUTPUT   :	
 *			  	
 *	REQUIRES :	
 *			  	
 *	MODIFIED :	Aug 29, 2007 -- David Workman, Data Mosaic
 *			  	
 */

//MEMO: need to somehow put this section in a Function of it's own
//running in Tano...strip out jsevents for now
if (utils.stringToNumber(application.getVersion()) >= 5) {
	//cast Arguments to array
	var Arguments = new Array()
	for (var i = 0; i < arguments.length; i++) {
		Arguments.push(arguments[i])
	}
	
	//reassign arguments without jsevents
	arguments = Arguments.filter(globals.CODE_jsevent_remove)
}

var skipLoadForms = arguments[0]
var treeTop = arguments[1]

var formName = 'NAV_0L_solution'

//there is a set
if (globals.DATASUTRA_navigation_set) {
	//this set has been navigated to before, go to last selected item
	if (navigationPrefs.byNavSetID[globals.DATASUTRA_navigation_set] && navigationPrefs.byNavSetID[globals.DATASUTRA_navigation_set].lastNavItem && !treeTop) {
		var itemID = navigationPrefs.byNavSetID[globals.DATASUTRA_navigation_set].lastNavItem
	}
	//go to first item in the navigation set
	else if (navigationPrefs.byNavSetID[globals.DATASUTRA_navigation_set] && navigationPrefs.byNavSetID[globals.DATASUTRA_navigation_set].itemsByOrder && navigationPrefs.byNavSetID[globals.DATASUTRA_navigation_set].itemsByOrder.length) {
		var itemID = navigationPrefs.byNavSetID[globals.DATASUTRA_navigation_set].itemsByOrder[0].navigationItem.idNavigationItem
		var initialLoad = true
	}
	//there aren't any nav items in this set, load blanks
	else {
		var itemID = null
	}
}
//no set selected, null out global
else {
	globals.NAV_list_2 = globals.NAV_list = null
}

//update text display
var displayValue = application.getValueListDisplayValue('NAV_navigation_set',globals.DATASUTRA_navigation_set)
forms[formName].elements.lbl_header.text = (displayValue) ? displayValue.toUpperCase() : 'NAVIGATION'

//first time set is viewed and collapse all pref enabled
if (initialLoad && solutionPrefs.config.navigationCollapse) {
	forms[formName].LIST_expand_collapse(itemID,true)
}
//regenerate list
else {
	forms[formName].LIST_redraw(itemID,true,skipLoadForms)
}

}

/**
 *
 * @properties={typeid:24,uuid:"d16cc6ba-d5f1-4a30-8a22-45f4745f9e6b"}
 */
function NAV_universal_list_select()
{
	var formName = solutionPrefs.config.currentFormName
	var currentNavItem = solutionPrefs.config.currentFormID
	var serverName = forms[formName].controller.getServerName()
	var tableName = forms[formName].controller.getTableName()
	var foundsetCount = databaseManager.getFoundSetCount(forms[formName].foundset)
	var rowSelected = forms[formName].foundset.getSelectedIndex()
	var lastRec = forms[formName].foundset.getSize()
	var logClick = (solutionPrefs.analytics && solutionPrefs.analytics.logging) ? solutionPrefs.analytics.logging.Record : false
	
	//show busy indicator while changing record
	if (navigationPrefs.byNavItemID[currentNavItem].navigationItem.ulBusyIndicator) {
		var busyIndicator = true
		
		plugins.sutra.busyCursor = true
		application.updateUI()
	}
	
	//LOG record navigation
	//only run when using query based way to hit repository
	if (solutionPrefs.repository && solutionPrefs.repository.allFormsByTable && solutionPrefs.repository.allFormsByTable[serverName] && solutionPrefs.repository.allFormsByTable[serverName][tableName] && solutionPrefs.repository.allFormsByTable[serverName][tableName].primaryKey) {
		var pkName = solutionPrefs.repository.allFormsByTable[serverName][tableName].primaryKey
		var pkActedOn = forms[formName][pkName]
	}
	else {
		var pkName = 'repositoryAPINotImplemented'
		var pkActedOn = 0
	}
	
	//record not clicked on before, throw up busy bar and busy cursor
	var record = forms[formName].foundset.getRecord(rowSelected)
	if (navigationPrefs.byNavItemID[currentNavItem].navigationItem.initialRecord && !navigationPrefs.byNavItemID[currentNavItem].listData.visitedPKs[record[pkName]]) {
		var recNotLoaded = true
		
		//don't turn busy indicator on if it is already on
		if (!busyIndicator) {
			plugins.sutra.busyCursor = true
		}
		globals.TRIGGER_progressbar_start(-273, navigationPrefs.byNavItemID[currentNavItem].navigationItem.initialRecordLabel)
	}
	
	//log if requested
	if (logClick) {
		globals.TRIGGER_log_create('Records',
							serverName,
							tableName,
							pkName,
							pkActedOn
							)
	}
	
	//save currently selected index
	navigationPrefs.byNavItemID[currentNavItem].listData.index.selected = rowSelected
	
	//save time when pk of this record last accessed
	navigationPrefs.byNavItemID[currentNavItem].listData.visitedPKs[(forms[formName][pkName] != 'repositoryAPINotImplemented') ? forms[formName][pkName] : 0] = application.getServerTimeStamp()
	
	//update record navigator
	globals.TRIGGER_toolbar_record_navigator_set()
	
	//record was not in memory, turn off busy bar and busy cursor
	if (recNotLoaded) {
		globals.TRIGGER_progressbar_stop()
		plugins.sutra.busyCursor = false	
	}
	//changing record, finished turn off busy indicatar
	else if (busyIndicator) {
		plugins.sutra.busyCursor = false	
	}
	
	//unhilite the current record (so highlighter spans entire row)
//	globals.NAV_universal_list_select__unhilite()//navigationPrefs.byNavItemID[currentNavItem].listData.withButtons)
	
	//timed out, throw up error
	if (solutionPrefs.config.prefs.thatsAllFolks) {
		forms.DPLY_0F_solution__license.ACTION_status()
		
		plugins.dialogs.showErrorDialog(
							'Trial expired',
							'Trial time expired\n' +
							'Please restart.'
						)
	}
}

/**
 *
 * @properties={typeid:24,uuid:"844fefbd-ae30-4c5f-897c-071fe0b21b7d"}
 */
function NAV_universal_list_select__unhilite()
{
	var withButtons = navigationPrefs.byNavItemID[solutionPrefs.config.currentFormID].listData.withButtons
//		arguments[0]
	
	if (withButtons) {
		//unhilite the current record (so highlighter spans entire row)
		forms.NAV_T_universal_list.elements.fld_constant.requestFocus(false)
	}
	else {
		//unhilite the current record (so highlighter spans entire row)
		forms.NAV_T_universal_list__no_buttons.elements.fld_constant.requestFocus(false)
	}
}

/**
 *
 * @properties={typeid:24,uuid:"92a1010e-b5bc-4c9d-b812-7b17dd01f3ef"}
 */
function NAV_universal_list_show()
{
	var formName = 'NAV_T_universal_list'
	var currentNavItem = solutionPrefs.config.currentFormID
	
	var rawDisplayPosn = navigationPrefs.byNavItemID[currentNavItem].universalList.displays.displayPosn
	
	//if list_title overridden in display preferences, use it; otherwise, set record header to fw_list_title for that navigation item
	if (navigationPrefs.byNavItemID[currentNavItem].universalList.displays[rawDisplayPosn].listTitle) {
		var listTitle = navigationPrefs.byNavItemID[currentNavItem].universalList.displays[rawDisplayPosn].listTitle
	}
	else {
		var listTitle = navigationPrefs.byNavItemID[currentNavItem].navigationItem.fwListTitle
	}
	
	//set label on record list
	forms[formName].elements.record_heading.text = (listTitle) ? listTitle.toUpperCase() : 'RECORDS'
	
	//show correct buttons for selected item
	forms[formName].BUTTONS_toggle(currentNavItem)
}

/**
 *
 * @properties={typeid:24,uuid:"fbe8962d-fe8f-4213-8f07-f16489bef47e"}
 */
function NAV_record_next()
{

/*
 *	TITLE    :	REC_next
 *			  	
 *	MODULE   :	ds_NAV_engine
 *			  	
 *	ABOUT    :	go to next record, or 200 records if shift held
 *			  	update universal list if present
 *			  	
 *	INPUT    :	
 *			  	
 *	OUTPUT   :	
 *			  	
 *	REQUIRES :	solutionPrefs, globals.TRIGGER_toolbar_record_navigator_set()
 *			  	
 *	MODIFIED :	Oct 30, 2007 -- Troy Elliott, Data Mosaic
 *			  	
 */

if (application.__parent__.solutionPrefs) {
	
	//amount to require between clicking through records
	var delay = solutionPrefs.listSetup.delay
	
	//do not run method if in viewer setup or if run in previous x seconds
	if (solutionPrefs.config.currentFormName != 'MGR_0F_toolbar' && ((new Date() - solutionPrefs.listSetup.lastStart) > delay)) {
		
		solutionPrefs.listSetup.lastStart = new Date()
	
		/*************
			inputs
		*************/
		
		//get form name
		var formName 		= solutionPrefs.config.currentFormName
		
		//get current index
		var index 			= forms[formName].foundset.getSelectedIndex()
		
		//loaded records size
		var loaded			= forms[formName].foundset.getSize()
		
		//get max table size
		var size 			= databaseManager.getFoundSetCount(forms[formName].foundset)
		
		//maximum number of records to display in universal list
		var maxRecs			= solutionPrefs.listSetup.maxRecords
		
		//get current id of loaded form
		var currentNavItem	= solutionPrefs.config.currentFormID
		
		//shift key pressed
		var shift			= globals.CODE_key_pressed('shift')
		
		/***********************
			next record action
		************************/
		
		if (index < size) {

			if (shift) {
				//if not possible to go +200 records, load to the end
				if (index + 200 > size) {
					index = size
				}
				//go +200 records
				else {
					index += 200
				}
		
				//land directly on beginning of 200 chunk to load in
				if (index > loaded) {
					forms[formName].foundset.setSelectedIndex(Math.floor(index / 200) * 200)
				}
				
				//if not possible to go to index, load to the end
				if (index > size) {
					index = size
				}
				
				//go to desired record
				forms[formName].foundset.setSelectedIndex(index)
			}
			else {
				//go to next record
				index++
				forms[formName].controller.setSelectedIndex(index)
			}
			
			//universal list in 3.5
			if (navigationPrefs.byNavItemID[currentNavItem].navigationItem.useFwList && 
				(utils.stringToNumber(solutionPrefs.clientInfo.verServoy) < 4)) {
				
				var formUL = navigationPrefs.byNavItemID[currentNavItem].listData.tabFormInstance + '_1L'
				forms[formUL].foundset.setSelectedIndex(index)
				forms[formUL].UL_set_selected()
			}
			
			//update record navigator
			globals.TRIGGER_toolbar_record_navigator_set()
		}
		
		//LOG record navigation
		var serverName = forms[formName].foundset.getServerName()
		var tableName = forms[formName].foundset.getTableName()
		//run if data is available
		if (solutionPrefs.repository && solutionPrefs.repository.allFormsByTable && 
			solutionPrefs.repository.allFormsByTable[serverName] && 
			solutionPrefs.repository.allFormsByTable[serverName][tableName] && 
			solutionPrefs.repository.allFormsByTable[serverName][tableName].primaryKey) {
			
			var pkName = solutionPrefs.repository.allFormsByTable[serverName][tableName].primaryKey
			var pkActedOn = forms[formName][pkName]
		}
		else {
			var pkName = 'repositoryAPINotImplemented'
			var pkActedOn = 0
		}
		globals.TRIGGER_log_create('Records',
							serverName,
							tableName,
							pkName,
							pkActedOn
							)
	}
}
}

/**
 *
 * @properties={typeid:24,uuid:"66284292-7255-4d81-a748-7a9af46c394e"}
 */
function NAV_record_previous()
{

/*
 *	TITLE    :	REC_previous
 *			  	
 *	MODULE   :	ds_NAV_engine
 *			  	
 *	ABOUT    :	go to previous record, or 200 records if shift held
 *			  	update universal list if present
 *			  	
 *	INPUT    :	
 *			  	
 *	OUTPUT   :	
 *			  	
 *	REQUIRES :	solutionPrefs, globals.TRIGGER_toolbar_record_navigator_set()
 *			  	
 *	MODIFIED :	Oct 30, 2007 -- Troy Elliott, Data Mosaic
 *			  	
 */

if (application.__parent__.solutionPrefs) {
	
	//amount to require between clicking through records
	var delay = solutionPrefs.listSetup.delay
	
	//do not run method if in viewer setup or if run in previous x seconds
	if (solutionPrefs.config.currentFormName != 'MGR_0F_toolbar' && ((new Date() - solutionPrefs.listSetup.lastStart) > delay)) {
		
		solutionPrefs.listSetup.lastStart = new Date()
		
		/*************
			inputs
		*************/
		
		//get form name
		var formName 		= solutionPrefs.config.currentFormName
		
		//get current index
		var index 			= forms[formName].foundset.getSelectedIndex()
		
		//loaded records size
		var loaded			= forms[formName].foundset.getSize()
		
		//get max table size
		var size 			= databaseManager.getFoundSetCount(forms[formName].foundset)
		
		//maximum number of records to display in universal list
		var maxRecs			= solutionPrefs.listSetup.maxRecords
		
		//get current id of loaded form
		var currentNavItem	= solutionPrefs.config.currentFormID
		
		//shift key pressed
		var shift			= globals.CODE_key_pressed('shift')
		
		/***********************
			previous record action
		************************/
		
		if (index > 1) {

			if (shift) {
				//go -200 records if possible
				if (index > 200) {
					index -= 200
				}
				//go to first record
				else {
					index = 1
				}
			}
			else {
				//go to previous record
				index--
			}
			
			forms[formName].controller.setSelectedIndex(index)
			
			//universal list in 3.5
			if (navigationPrefs.byNavItemID[currentNavItem].navigationItem.useFwList && 
				(utils.stringToNumber(solutionPrefs.clientInfo.verServoy) < 4)) {
				
				var formUL = navigationPrefs.byNavItemID[currentNavItem].listData.tabFormInstance + '_1L'
				forms[formUL].foundset.setSelectedIndex(index)
				forms[formUL].UL_set_selected()
			}
			
			//update record navigator
			globals.TRIGGER_toolbar_record_navigator_set()
		}
		
		//LOG record navigation
		var serverName = forms[formName].foundset.getServerName()
		var tableName = forms[formName].foundset.getTableName()
		//run if data is available
		if (solutionPrefs.repository && solutionPrefs.repository.allFormsByTable && 
			solutionPrefs.repository.allFormsByTable[serverName] && 
			solutionPrefs.repository.allFormsByTable[serverName][tableName] && 
			solutionPrefs.repository.allFormsByTable[serverName][tableName].primaryKey) {
			
			var pkName = solutionPrefs.repository.allFormsByTable[serverName][tableName].primaryKey
			var pkActedOn = forms[formName][pkName]
		}
		else {
			var pkName = 'repositoryAPINotImplemented'
			var pkActedOn = 0
		}
		globals.TRIGGER_log_create('Records',
							serverName,
							tableName,
							pkName,
							pkActedOn
							)
	}
}
}

/**
 *
 * @properties={typeid:24,uuid:"55b10d40-41ec-4d45-a2d7-61483b7356bc"}
 */
function NAV_universal_list_form_remove()
{
//MEMO: need to somehow put this section in a Function of it's own
//running in Tano...strip out jsevents for now
if (utils.stringToNumber(application.getVersion()) >= 5) {
	//cast Arguments to array
	var Arguments = new Array()
	for (var i = 0; i < arguments.length; i++) {
		Arguments.push(arguments[i])
	}
	
	//reassign arguments without jsevents
	arguments = Arguments.filter(globals.CODE_jsevent_remove)
}	

	var formName = arguments[0]
	
	//first remove it from the current history, to destroy any active form instance
	var success = history.removeForm(formName)        //returns false
	
	//this form does exist, but isn't in history, show it so can be removed
	if (!success) {
	    //show this form someplace so we can really remove it
	    forms[formName].controller.show()
	    success = history.removeForm(formName)        //returns true
	}
	
	//removes the named form from this session
	success = solutionModel.removeForm(formName)    //returns true 
	
//	//first remove it from the current history, to destroy any active form instance
//	var success = history.removeForm(formName)
//	//removes the named form from this session
//	if (success) {
//		solutionModel.removeForm(formName)
//	}
}

/**
 *
 * @properties={typeid:24,uuid:"5e54f2d6-4947-4515-b606-b3760eae4c42"}
 */
function NAV_universal_list_form_to_template()
{
//MEMO: need to somehow put this section in a Function of it's own
//running in Tano...strip out jsevents for now
if (utils.stringToNumber(application.getVersion()) >= 5) {
	//cast Arguments to array
	var Arguments = new Array()
	for (var i = 0; i < arguments.length; i++) {
		Arguments.push(arguments[i])
	}
	
	//reassign arguments without jsevents
	arguments = Arguments.filter(globals.CODE_jsevent_remove)
}

	//get form and do some stuff
	var smForm = solutionModel.getForm(arguments[0] || currentcontroller.getName())
	var objForm = {
			properties:	new Object(),
			buttons:	new Object(),
			fields:		new Object(),
			labels:		new Object(),
			portals:	new Object(),
			tabpanels:	new Object(),
			vars:		new Object()
	}
	
	//get all properties for this form
	for (var i in smForm) {
		//ignore all methods
		if (!(typeof smForm[i] == 'Function' || typeof smForm[i] == 'func' + 'tion')) {
			objForm.properties[i] = smForm[i]
		}
	}
	
	//get all labels
	var smLabels = smForm.getLabels()
	var cnt = 1
	for (var i = 0; i < smLabels.length; i++) {
		//label has name?
		if (smLabels[i].name) {
			var labelName = smLabels[i].name
		}
		else {
			var labelName = 'label_000' + cnt++
		}
		
		//create position for this label in my object representation
		objForm.labels[labelName] = new Object()
		
		//get all properties for this label
		for (var j in smLabels[i]) {
			//ignore all methods
			if (!(typeof smLabels[i][j] == 'Function' || typeof smLabels[i][j] == 'func' + 'tion')) {
				objForm.labels[labelName][j] = smLabels[i][j]
			}
		}
	}
	
	//get all fields
	var smFields = smForm.getFields()
	var cnt = 1
	for (var i = 0; i < smFields.length; i++) {
		//field has name?
		if (smFields[i].name) {
			var fieldName = smFields[i].name
		}
		else {
			var fieldName = 'field000_' + cnt++
		}
		
		//create position for this field in my object representation
		objForm.fields[fieldName] = new Object()
		
		//get all properties for this field
		for (var j in smFields[i]) {
			//ignore all methods
			if (!(typeof smFields[i][j] == 'Function' || typeof smFields[i][j] == 'func' + 'tion')) {
				objForm.fields[fieldName][j] = smFields[i][j]
			}
		}
	}
	
	
	//get all tabpanels
	var smTabPanels = smForm.getTabPanels()
	var cnt = 1
	for (var i = 0; i < smTabPanels.length; i++) {
		//tabpanel has name?
		if (smTabPanels[i].name) {
			var tabPanelName = smTabPanels[i].name
		}
		else {
			var tabPanelName = 'tabpanel000_' + cnt++
		}
		
		//create position for this field in my object representation
		objForm.tabpanels[tabPanelName] = new Object()
		
		//get all properties for this field
		for (var j in smTabPanels[i]) {
			if (!(typeof smTabPanels[i][j] == 'Function' || typeof smTabPanels[i][j] == 'func' + 'tion')) {
				objForm.tabpanels[tabPanelName][j] = smTabPanels[i][j]
			}
		}
	}
	
	//get all buttons
	var smButtons = smForm.getButtons()
	var cnt = 1
	for (var i = 0; i < smButtons.length; i++) {
		//button has name?
		if (smButtons[i].name) {
			var buttonName = smButtons[i].name
		}
		else {
			var buttonName = 'button000_' + cnt++
		}
		
		//create position for this field in my object representation
		objForm.buttons[buttonName] = new Object()
		
		//get all properties for this field
		for (var j in smButtons[i]) {
			if (!(typeof smButtons[i][j] == 'Function' || typeof smButtons[i][j] == 'func' + 'tion')) {
				objForm.buttons[buttonName][j] = smButtons[i][j]
			}
		}
	}
	
	//save object 'template' into a code global for later usage
	//application.__parent__.myCoolForm = objForm
	return objForm
}

/**
 *
 * @properties={typeid:24,uuid:"7b2b1c49-52d0-40fe-af98-f5b82b1fcd71"}
 */
function NAV_universal_list_get_status()
{

/*
 *	TITLE    :	NAV_universal_list_get_status
 *			  	
 *	MODULE   :	ds_NAV_engine
 *			  	
 *	ABOUT    :	determines if UL needs a redraw
 *			  	
 *			  	
 *	INPUT    :	1) information about the list
 *			  	
 *	OUTPUT   :	true if list already available as a tab
 *			  	
 *	REQUIRES :	solutionPrefs, the scoped element to exist in the solution
 *			  	
 *	MODIFIED :	November 17, 2009 -- Troy Elliott, Data Mosaic
 *			  	
 */

//MEMO: need to somehow put this section in a Function of it's own
//running in Tano...strip out jsevents for now
if (utils.stringToNumber(application.getVersion()) >= 5) {
	//cast Arguments to array
	var Arguments = new Array()
	for (var i = 0; i < arguments.length; i++) {
		Arguments.push(arguments[i])
	}
	
	//reassign arguments without jsevents
	arguments = Arguments.filter(globals.CODE_jsevent_remove)
}

var listData = arguments[0]

if (application.__parent__.solutionPrefs && application.__parent__.navigationPrefs && listData) {
	var navigationItemID = solutionPrefs.config.currentFormID
	var navSpecs = navigationPrefs.byNavItemID[navigationItemID].navigationItem
	
	//status of buttons has changed
	if ((navigationPrefs.byNavItemID[navigationItemID].listData.withButtons && !(navSpecs.barItemAdd || navSpecs.barItemAction || navSpecs.barItemFilter || navSpecs.barItemReport)) ||
		(!navigationPrefs.byNavItemID[navigationItemID].listData.withButtons && (navSpecs.barItemAdd || navSpecs.barItemAction || navSpecs.barItemFilter || navSpecs.barItemReport))) {
		return false
	}
	//tab was added before solution opened (in a prior session)
	else if (solutionPrefs.clientInfo.startTime > listData.dateAdded || !(listData.tabFormInstance in forms)) {
		return false
	}
	//everything copasetic
	else if (solutionPrefs.clientInfo.startTime < listData.dateAdded) {
		return true
	}
}
}

/**
 *
 * @properties={typeid:24,uuid:"8b972d54-96f1-41d5-874f-a092d1bdf711"}
 */
function NAV_universal_list_set_scroll()
{

/*
 *	TITLE    :	NAV_universal_list_set_scroll
 *			  	
 *	MODULE   :	ds_NAV_engine
 *			  	
 *	ABOUT    :	adjusts scroll position of an html field so that the selected 'record' is visible
 *			  	
 *			  	most of solution refers to universal list by selectedIndex scoped to the foundset;
 *			  	this method scopes 'selectedIndex' within the currently displayed subset
 *			  	
 *	INPUT    :	1) selected index
 *			  	2) element name to scroll
 *			  	3) form name of element being set
 *			  	
 *	OUTPUT   :	true if scrolled, false if nothing scrolled
 *			  	
 *	REQUIRES :	solutionPrefs, the scoped element to exist in the solution
 *			  	
 *	MODIFIED :	Nov 5, 2007 -- Troy Elliott, Data Mosaic
 *			  	
 */

//MEMO: need to somehow put this section in a Function of it's own
//running in Tano...strip out jsevents for now
if (utils.stringToNumber(application.getVersion()) >= 5) {
	//cast Arguments to array
	var Arguments = new Array()
	for (var i = 0; i < arguments.length; i++) {
		Arguments.push(arguments[i])
	}
	
	//reassign arguments without jsevents
	arguments = Arguments.filter(globals.CODE_jsevent_remove)
}

var workflowForm = solutionPrefs.config.currentFormName

//arguments
var selected = arguments[0] - forms[workflowForm].listStatus.limitFirst + 1  //add one because of current record
var elem = arguments[1]
var formName = arguments[2]

var indexStart = 1
var indexEnd = forms[workflowForm].listStatus.limitLast - forms[workflowForm].listStatus.limitFirst + 1 //selected records are inclusive

//information about scroll field
var heightHTML = forms[formName].elements[elem].getHeight()
var rowHeight = 20 //this is set in the css for the html field...may be overridden in top level style sheet
var clickSize = Math.floor(heightHTML / 10) //the amount of one downward click in the scroll bar
var rowScroll = heightHTML / rowHeight //Math.floor() gives the number of rows that can be displayed without scrolling
var maxScroll = (rowHeight * (indexEnd - indexStart + 1)) - heightHTML
var currentScroll = forms[formName].elements[elem].getScrollY()
var currentTop = (currentScroll) ? Math.ceil(currentScroll / rowHeight) + 1 : 1 //index of record at top of scroll (add 1 to account for parital records)
var currentBottom = currentTop + Math.floor(rowScroll) - 2 //subtract 1 to account for partial records, 1 for selected offset (in defintion of selected)

//selected item in loaded set
if (indexStart <= selected && selected <= indexEnd) {
	//scroll up
	if (selected < currentTop) {
		//can fit without scroll
		if (selected <= Math.floor(rowScroll)) {
			forms[formName].elements[elem].setScroll(0,0)
			forms[workflowForm].listStatus.scrollY = 0
			return true
		}
		//set to be a few down
		else {
			var scrollY = ((selected - 1) * 20) //-1 to get the bottom of the prior record (in other words, the top of the record we want)
			//if there is room, set the scroll position to be slightly above the selected record
			if (Math.floor(rowScroll) > 4) {
				scrollY -= 60
			}
			forms[formName].elements[elem].setScroll(0,scrollY)
			forms[workflowForm].listStatus.scrollY = scrollY
			return true
		}
	}
	//scroll down
	else if (selected > currentBottom) {
		//can fit with scroll all the way to the bottom
		if ((indexEnd - Math.floor(rowScroll) < selected) && (selected < indexEnd)) {
			forms[formName].elements[elem].setScroll(0,maxScroll)
			forms[solutionPrefs.config.currentFormName].listStatus.scrollY = maxScroll
			return true
		}
		//set to be a few up
		else {
			var scrollY = ((selected - 1) * 20) //-1 to get the bottom of the prior record (in other words, the top of the record we want)
			//if there is room, set the scroll position to be slightly above the selected record
			if (Math.floor(rowScroll) > 4) {
				scrollY -= 60
			}
			forms[formName].elements[elem].setScroll(0,scrollY)
			forms[workflowForm].listStatus.scrollY = scrollY
			return true
		}
	
	}
	//otherwise selected item in viewable area; no action necessary
}
else if (selected != 0) {
	plugins.dialogs.showErrorDialog( 'ERROR',  "Selected index is not in the universal list", 'OK')
}

//if no scrolling took place, return false
return false
}

/**
 *
 * @properties={typeid:24,uuid:"12e4ce35-0b21-4501-9f35-1ed56f930375"}
 */
function NAV_universal_list_template_to_form()
{
//MEMO: need to somehow put this section in a Function of it's own
//running in Tano...strip out jsevents for now
if (utils.stringToNumber(application.getVersion()) >= 5) {
	//cast Arguments to array
	var Arguments = new Array()
	for (var i = 0; i < arguments.length; i++) {
		Arguments.push(arguments[i])
	}
	
	//reassign arguments without jsevents
	arguments = Arguments.filter(globals.CODE_jsevent_remove)
}	

	var objForm = arguments[0] || application.__parent__.myCoolForm
	var newForm = arguments[1] || objForm.properties.name + '__copy'
	
	//check for my global
	if (objForm) {
		
		//if a form with the same name exists (it has already been copied), remove it
		if (forms[newForm]) {
			globals.NAV_universal_list_form_remove(newForm)
		}
		
		//create me a form
		var myForm = solutionModel.newForm(
						newForm,
						objForm.properties.serverName, 
						objForm.properties.tableName,
						objForm.properties.styleName,
						objForm.properties.showInMenu, 
						objForm.properties.width, 
						objForm.properties.height
				)
		
		//loop over all properties on me form and set the ones that weren't set at instantiation
		for (var i in objForm.properties) {
			if (!(i == 'name' || i == 'serverName' || i == 'tableName' || i == 'styleName' || i == 'showInMenu' || i == 'width' || i == 'height')) {
				myForm[i] = objForm.properties[i]
			}
		}
		
		//create labels and set properties
		for (var i in objForm.labels) {
			var myLabel = myForm.newLabel(
							objForm.labels[i].text,
							objForm.labels[i].x,
							objForm.labels[i].y,
							objForm.labels[i].width,
							objForm.labels[i].height
						)
			//loop over all properties for this label and set them and set the ones that weren't set at instantiation (text can be null)
			for (var j in objForm.labels[i]) {
				if (!(j == 'x' || j == 'y' || j == 'width' || j == 'height')) {
					myLabel[j] = objForm.labels[i][j]
				}
			}
		}
		
		//create fields and set properteis
			//TODO: displayType property was added later...so instead of a nasty switch statement, it could be just one myForm.newField()
		for (var i in objForm.fields) {
			switch (objForm.fields[i].displayType) {
				case SM_DISPLAYTYPE.TEXT_FIELD:
					var myField = myForm.newTextField(
							objForm.fields[i].dataProviderID,
							objForm.fields[i].x,
							objForm.fields[i].y,
							objForm.fields[i].width,
							objForm.fields[i].height
						)
					break
				case SM_DISPLAYTYPE.CALENDAR:
					var myField = myForm.newCalendar(
							objForm.fields[i].dataProviderID,
							objForm.fields[i].x,
							objForm.fields[i].y,
							objForm.fields[i].width,
							objForm.fields[i].height
						)
					break
				case SM_DISPLAYTYPE.CHECKS:
					var myField = myForm.newCheck(
							objForm.fields[i].dataProviderID,
							objForm.fields[i].x,
							objForm.fields[i].y,
							objForm.fields[i].width,
							objForm.fields[i].height
						)
					break
				case SM_DISPLAYTYPE.COMBOBOX:
					var myField = myForm.newComboBox(
							objForm.fields[i].dataProviderID,
							objForm.fields[i].x,
							objForm.fields[i].y,
							objForm.fields[i].width,
							objForm.fields[i].height
						)
					break
				case SM_DISPLAYTYPE.HTML_AREA:
					var myField = myForm.newHtmlArea(
							objForm.fields[i].dataProviderID,
							objForm.fields[i].x,
							objForm.fields[i].y,
							objForm.fields[i].width,
							objForm.fields[i].height
						)
					break
				case SM_DISPLAYTYPE.PASSWORD:
					var myField = myForm.newPassword(
							objForm.fields[i].dataProviderID,
							objForm.fields[i].x,
							objForm.fields[i].y,
							objForm.fields[i].width,
							objForm.fields[i].height
						)
					break
				case SM_DISPLAYTYPE.RADIOS:
					var myField = myForm.newRadios(
							objForm.fields[i].dataProviderID,
							objForm.fields[i].x,
							objForm.fields[i].y,
							objForm.fields[i].width,
							objForm.fields[i].height
						)
					break
				case SM_DISPLAYTYPE.RTF_AREA:
					var myField = myForm.newRtfArea(
							objForm.fields[i].dataProviderID,
							objForm.fields[i].x,
							objForm.fields[i].y,
							objForm.fields[i].width,
							objForm.fields[i].height
						)
					break
				case SM_DISPLAYTYPE.TEXT_AREA:
					var myField = myForm.newTextArea(
							objForm.fields[i].dataProviderID,
							objForm.fields[i].x,
							objForm.fields[i].y,
							objForm.fields[i].width,
							objForm.fields[i].height
						)
					break
				case SM_DISPLAYTYPE.TYPE_AHEAD:
					var myField = myForm.newTypeAhead(
							objForm.fields[i].dataProviderID,
							objForm.fields[i].x,
							objForm.fields[i].y,
							objForm.fields[i].width,
							objForm.fields[i].height
						)
					break
			}
			
			//loop over all properties for this field and set them
			for (var j in objForm.fields[i]) {
				if (!(j == 'dataProviderID' || j == 'x' || j == 'y' || j == 'width' || j == 'height')) {
					myField[j] = objForm.fields[i][j]
				}
			}
		}
		
		//create buttons and set properties
		for (var i in objForm.buttons) {
			var myButton = myForm.newButton(
							objForm.buttons[i].text,
							objForm.buttons[i].x,
							objForm.buttons[i].y,
							objForm.buttons[i].width,
							objForm.buttons[i].height
						)
			//loop over all properties for this button and set them
			for (var j in objForm.buttons[i]) {
				if (!(j == 'text' || j == 'x' || j == 'y' || j == 'width' || j == 'height')) {
					myButton[j] = objForm.buttons[i][j]
				}
			}
		}
		
		//create tabpanels and set properties
		for (var i in objForm.tabpanels) {
			var myTabPanel = myForm.newTabPanel(
							objForm.tabpanels[i].name,
							objForm.tabpanels[i].x,
							objForm.tabpanels[i].y,
							objForm.tabpanels[i].width,
							objForm.tabpanels[i].height
						)
			//loop over all properties for this label and set them
			for (var j in objForm.tabpanels[i]) {
				if (!(j == 'name' || j == 'x' || j == 'y' || j == 'width' || j == 'height')) {
					myTabPanel[j] = objForm.tabpanels[i][j]
				}
			}
		}
		
		//TODO: do create tabs for tabpanel and call this method to do forms....
		
		if (application.__parent__.myCoolForm) {
			//show the form
			forms[myForm.name].controller.show()
		}
		else {
			//return it
			return myForm
		}
	}
	else {
		plugins.dialogs.showErrorDialog(
							'Error',
							'Form global not ready yet'
						)
	}
}

/**
 *
 * @properties={typeid:24,uuid:"22395fb1-3b98-4018-8174-0399ac0b46f0"}
 */
function NAV_meta_form_names()
{

/*
 *	TITLE    :	NAV_meta_form_names
 *			  	
 *	MODULE   :	ds_NAV_engine
 *			  	
 *	ABOUT    :	stores an array of all forms by module into solutionPrefs.allForm
 *			  	each array element is an object named <module_name> with property
 *			  		<form_name>, which is an object with properties:
 *			  			moduleName, formName, elementID (of the formName)
 *			  	
 *	INPUT    :	1- true to create a unique copy (non-reference) of everything; used when creating static object
 *			  	
 *	OUTPUT   :	
 *			  	
 *	REQUIRES :	solutionPrefs.repository.allModules
 *			  	
 *	MODIFIED :	September 9, 2009 -- Troy Elliott, Data Mosaic
 *			  	
 */ //TODO: there is some duplication betweeen repositoryPrefs.allModules and repositoryPrefs.allForms; consolidate


if (application.__parent__.repositoryPrefs) {
	
	var nonRef = arguments[0]
	
	var allModules = repositoryPrefs.allModules
	var formsByModule = repositoryPrefs.allForms
	var formsByTable = repositoryPrefs.allFormsByTable
	formsByTable['No datasource'] = new Object()
	
	//get all form names
	for (var i in allModules) {
		var selectedModule = allModules[i]
		
		var repositoryServer = 'repository_server'
		var maxReturnedRows = 100000
		var args = [selectedModule.rootElementID,selectedModule.activeRelease]
		
		//in pre-5 land
		if (utils.stringToNumber(solutionPrefs.clientInfo.verServoy) < 5) {
			var query = "SELECT a.element_id, " + 
						"(SELECT b.property_value FROM servoy_element_properties b " + 
							"WHERE b.content_id = 37 AND b.element_id = a.element_id AND b.revision = a.revision) AS form_name, " + //content_id of 37 is form names
						"(SELECT b.property_value FROM servoy_element_properties b " +
							"WHERE b.content_id = 232 AND b.element_id = a.element_id AND b.revision = a.revision) AS separate_foundset, " + //content_id of 232 is useSeparateFoundset
						"(SELECT b.property_value FROM servoy_element_properties b " +
							"WHERE b.content_id = 36 AND b.element_id = a.element_id AND b.revision = a.revision) AS server_name, " + //content_id of 36 is serverName
						"(SELECT b.property_value FROM servoy_element_properties b " +
							"WHERE b.content_id = 41 AND b.element_id = a.element_id AND b.revision = a.revision) AS table_name, " + //content_id of 41 is tableName
						"(SELECT b.property_value FROM servoy_element_properties b " +
							"WHERE b.content_id = 43 AND b.element_id = a.element_id AND b.revision = a.revision) AS form_type, " + //content_id of 43 is type of form
						"(SELECT b.property_value FROM servoy_element_properties b " +
							"WHERE b.content_id = 38 AND b.element_id = a.element_id AND b.revision = a.revision) AS form_size " + //content_id of 38 is total size of all body parts
						"FROM servoy_releases a " + 
						"WHERE a.root_element_id = ? AND a.release_number = ? AND " + 
						"(SELECT b.property_value FROM servoy_element_properties b WHERE b.content_id = 37 AND b.element_id = a.element_id AND b.revision = a.revision) IS NOT NULL"
			
			var dataset = databaseManager.getDataSetByQuery(repositoryServer, query, args, maxReturnedRows)
		
			var elementIDs = dataset.getColumnAsArray(1)
			var formNames = dataset.getColumnAsArray(2)
			var separateFoundset = dataset.getColumnAsArray(3)
			var serverNames = dataset.getColumnAsArray(4)
			var tableNames = dataset.getColumnAsArray(5)
			var formTypes = dataset.getColumnAsArray(6)
			var formSizes = dataset.getColumnAsArray(7)
		
		}
		//post 5
		else {
			var query = "SELECT a.element_id, " + 
						"(SELECT b.property_value FROM servoy_element_properties b " + 
							"WHERE b.content_id = 37 AND b.element_id = a.element_id AND b.revision = a.revision) AS form_name, " + //content_id of 37 is form names
						"(SELECT b.property_value FROM servoy_element_properties b " +
							"WHERE b.content_id = 313 AND b.element_id = a.element_id AND b.revision = a.revision) AS named_foundset, " + //content_id of 313 is namedFoundSet
						"(SELECT b.property_value FROM servoy_element_properties b " +
							"WHERE b.content_id = 314 AND b.element_id = a.element_id AND b.revision = a.revision) AS datasource, " + //content_id of 314 is datasource
						"(SELECT b.property_value FROM servoy_element_properties b " +
							"WHERE b.content_id = 43 AND b.element_id = a.element_id AND b.revision = a.revision) AS form_type, " + //content_id of 43 is type of form
						"(SELECT b.property_value FROM servoy_element_properties b " +
							"WHERE b.content_id = 38 AND b.element_id = a.element_id AND b.revision = a.revision) AS form_size " + //content_id of 38 is total size of all body parts
						"FROM servoy_releases a " + 
						"WHERE a.root_element_id = ? AND a.release_number = ? AND " + 
						"(SELECT b.property_value FROM servoy_element_properties b WHERE b.content_id = 37 AND b.element_id = a.element_id AND b.revision = a.revision) IS NOT NULL"
			
			var dataset = databaseManager.getDataSetByQuery(repositoryServer, query, args, maxReturnedRows)
			
			var elementIDs = dataset.getColumnAsArray(1)
			var formNames = dataset.getColumnAsArray(2)
			var separateFoundset = dataset.getColumnAsArray(3)
			var datasources = dataset.getColumnAsArray(4)
			
			var serverNames = new Array()
			var tableNames = new Array()
			for (var z = 0; z < datasources.length; z++) {
				var sourceItem = datasources[z]
				if (sourceItem) {
					sourceItem = sourceItem.split('/')
					
					//handle different types of datasources
					switch (sourceItem[0]) {
						case 'db:':
							serverNames.push(sourceItem[1])
							tableNames.push(sourceItem[2])
							break
					}
				}
				else {
					serverNames.push('None')
					tableNames.push('None')
				}
			}
			
			var formTypes = dataset.getColumnAsArray(5)
			var formSizes = dataset.getColumnAsArray(6)
		}
		
		//create module container for all forms
		var allForms = formsByModule[selectedModule.moduleName] = new Object()
		
		//add each form with properties to module
		for (var j = 0 ; j < formNames.length ; j++) {
			if (formNames[j] != null) {
				var formInfo = allForms[formNames[j]] = {
					moduleName : selectedModule.moduleName,
					formName   : formNames[j],
					elementID  : elementIDs[j],
					useSeparateFoundset : ((separateFoundset[j]) ? true : false),	//TODO: when more foundsets than just 'separate' supported, will need to revisit
					serverName : serverNames[j],
					tableName  : tableNames[j],
					formType  : (formTypes[j]) ? formTypes[j] : 0,
					formSize  : formSizes[j]
				}
				
				//add to table view also
				
				//this is a form without a table
				if (formInfo.serverName == 'None' && formInfo.tableName == 'None') {
					//add form
					if (nonRef) {
						formsByTable['No datasource'][formInfo.formName] = globals.CODE_copy_object(formInfo)
					}
					//only used in developer
					else {
						formsByTable['No datasource'][formInfo.formName] = formInfo
					}
				}
				//form with a table
				else {
					//add server if not encountered before
					if (!formsByTable[formInfo.serverName]) {
						formsByTable[formInfo.serverName] = new Object()
					}
					
					//add table if not encountered before
					if (!formsByTable[formInfo.serverName][formInfo.tableName]) {
						formsByTable[formInfo.serverName][formInfo.tableName] = new Object()
						
						//punch in pk info
						var jsTable = databaseManager.getTable(formInfo.serverName,formInfo.tableName)
						
						//will not be a table on a form without a datasource
						if (jsTable) {
							var pkCols = jsTable.getRowIdentifierColumnNames()
							//MEMO: does not account for multiple primary keys on a table
							formsByTable[formInfo.serverName][formInfo.tableName].primaryKey = pkCols[0]
						}
					}
					
					//add form
					if (nonRef) {
						formsByTable[formInfo.serverName][formInfo.tableName][formInfo.formName] = globals.CODE_copy_object(formInfo)
					}
					//only used in developer
					else {
						formsByTable[formInfo.serverName][formInfo.tableName][formInfo.formName] = formInfo
					}
				}
			}
		}
	}
}
}

/**
 *
 * @properties={typeid:24,uuid:"872a1317-b6a2-4396-acea-d0cfb0e792f7"}
 */
function NAV_meta_module_names()
{

/*
 *	TITLE    :	NAV_meta_module_names
 *			  	
 *	MODULE   :	ds_NAV_engine
 *			  	
 *	ABOUT    :	stores an array of all included modules into repositoryPrefs
 *			  	each array element is an object named <module_name> with properties:
 *			  		moduleName, rootElementID, activeRelease
 *			  	
 *	INPUT    :	
 *			  	
 *	OUTPUT   :	
 *			  	
 *	REQUIRES :	NAV_meta_module_names_fx
 *			  	
 *	MODIFIED :	Oct 17, 2007 -- Troy Elliott, Data Mosaic
 *			  	
 */ //TODO: store repositoryPrefs as object during creation instead of post-processing
	//in order to do this, must write method to sort object based on element

//if, by some chance, this method is run outside of the wrapper, instantiate my global baby
if (! application.__parent__.repositoryPrefs) {
	repositoryPrefs = {
				allModules: new Array(),
				allForms: new Object(),
				allFormsByTable: new Object(),
				relations: new Object()
		}
}

//get currently loaded solution name; start recursion
var solutionName = application.getSolutionName()
globals.NAV_meta_module_names_fx([solutionName])

//sort array, remove duplicates, attach root_element_id and active_release
if (repositoryPrefs.allModules.length) {
	var modules = repositoryPrefs.allModules
	modules.sort()
	
	var modulesDistinct = new Array()
	
	//recast as object
	repositoryPrefs.allModules = new Object()
	var k = 0
	for (var i = 0 ; i < modules.length ; i++) {
		if (modules[i] != modules[i+1]) {
			repositoryPrefs.allModules[modules[i]] = new Object()
			modulesDistinct[k] = modules[i]
			k++
		}
	}
	
	//store module names into valuelist
	application.setValueListItems('NAV_modules_included', modulesDistinct)
	
	//get root_element_id/revision
	var repositoryServer = 'repository_server'
	var maxReturnedRows = 10000
	var args = modules
	var query = "SELECT name, root_element_id, active_release FROM servoy_root_elements WHERE name IN (?"
		for (var i = 1; i < modules.length ; i++) {
			query += ', ?'
		}
		query += ') AND object_type_id = 43' //only get solutions
	var dataset = databaseManager.getDataSetByQuery(repositoryServer, query, args, maxReturnedRows)
	
	dataset.sort(1,true)
	var moduleNames = dataset.getColumnAsArray(1)
		
	//attach root_element_id and active_release onto repositoryPrefs
	var k = 1
	for (var j in moduleNames) {
		repositoryPrefs.allModules[moduleNames[j]].moduleName = dataset.getValue(k,1)
		repositoryPrefs.allModules[moduleNames[j]].rootElementID = dataset.getValue(k,2)
		repositoryPrefs.allModules[moduleNames[j]].activeRelease = dataset.getValue(k,3)
		k++
	}
}
}

/**
 *
 * @properties={typeid:24,uuid:"635361ec-27d9-4c7d-a288-8be88e7ec2ef"}
 */
function NAV_meta_module_names_fx()
{

/*
 *	TITLE    :	NAV_meta_module_names_fx
 *			  	
 *	MODULE   :	ds_NAV_engine
 *			  	
 *	ABOUT    :	this method is recursive
 *			  	it takes an array of solution names as input,
 *			  		stores the solution name if there is only one,
 *			  		and calls itself
 *			  	
 *	INPUT    :	solution name
 *			  	
 *	OUTPUT   :	stores all solutions in solutionPrefs.repository.allModules
 *			  	
 *	REQUIRES :	
 *			  	
 *	MODIFIED :	Jan 2, 2009 -- Troy Elliott, Data Mosaic
 *			  	
 */

var solutionName = arguments[0]

//STEP ONE: return if nothing passed
if (!solutionName) {
	return
}

//STEP TWO: if multiple, loop and process each input
outerloop:
for (var i = 0 ; i < solutionName.length; i++) {
	
	//loop through currently added modules, break out of recursion if this module already added
	for (var j = 0 ; j < repositoryPrefs.allModules.length; j++) {
		if (solutionName[i] == repositoryPrefs.allModules[j]) {
			continue outerloop
		}
	}
	
	//get root_element_id/revision
	var repositoryServer = 'repository_server'
	var maxReturnedRows = 10000
	var query = "SELECT root_element_id, active_release FROM servoy_root_elements WHERE name = ? AND object_type_id = 43"
	var args = [solutionName[i]]
	var dataset = databaseManager.getDataSetByQuery(repositoryServer, query, args, maxReturnedRows)
	
	var solutionRootElemID = dataset.getValue(1,1)
	var solutionRelease = dataset.getValue(1,2)
	
	//get list of included modules
	query = "SELECT property_value FROM servoy_element_properties WHERE element_id = ? AND revision = ? AND content_id = 264"
	args = [solutionRootElemID,solutionRelease]
	dataset = databaseManager.getDataSetByQuery(repositoryServer, query, args, maxReturnedRows)
	
	var modules = dataset.getValue(1,1)
	if (modules) {
		modules = modules.split(',')
	}

	//STEP THREE: store parent module
	repositoryPrefs.allModules.push(solutionName[i])
	
	//pass back modules to processoranator
	globals.NAV_meta_module_names_fx(modules)
}

}

/**
 *
 * @properties={typeid:24,uuid:"db373d74-1a67-431f-9947-a830d066b905"}
 */
function NAV_meta_relation_names()
{

/*
 *	TITLE    :	NAV_meta_relation_names
 *			  	
 *	MODULE   :	ds_NAV_engine
 *			  	
 *	ABOUT    :	stores an array of all relations by table into repositoryPrefs.relations
 *			  	each array element is an object named <module_name> with property
 *			  		<form_name>, which is an object with properties:
 *			  			moduleName, formName, elementID (of the formName)
 *			  	
 *	INPUT    :	
 *			  	
 *	OUTPUT   :	
 *			  	
 *	REQUIRES :	solutionPrefs.repository.allModules
 *			  	
 *	MODIFIED :	August 21, 2008 -- Troy Elliott, Data Mosaic
 *			  	
 */ //TODO: there is some duplication betweeen repositoryPrefs.allModules and repositoryPrefs.allForms; consolidate


if (application.__parent__.repositoryPrefs) {
	
	var allModules = repositoryPrefs.allModules
	var relations = repositoryPrefs.relations
	
	//get all form names
	for (var i in allModules) {
		var selectedModule = allModules[i]
		
		var repositoryServer = 'repository_server'
		var maxReturnedRows = -1
		var args = [selectedModule.rootElementID,selectedModule.activeRelease]
		
		//in pre-5 land
		if (utils.stringToNumber(solutionPrefs.clientInfo.verServoy) < 5) {
			var query = "SELECT a.element_id, " +
						"(SELECT b.property_value FROM servoy_element_properties b " +
							"WHERE b.content_id = 142 AND b.element_id = a.element_id AND b.revision = a.revision) AS relation_name, " +
						"(SELECT b.property_value FROM servoy_element_properties b " +
							"WHERE b.content_id = 143 AND b.element_id = a.element_id AND b.revision = a.revision) AS primary_server_name, " +
						"(SELECT b.property_value FROM servoy_element_properties b " +
							"WHERE b.content_id = 145 AND b.element_id = a.element_id AND b.revision = a.revision) AS primary_table_name, " +
						"(SELECT b.property_value FROM servoy_element_properties b " +
							"WHERE b.content_id = 144 AND b.element_id = a.element_id AND b.revision = a.revision) AS foreign_server_name, " +
						"(SELECT b.property_value FROM servoy_element_properties b " +
							"WHERE b.content_id = 146 AND b.element_id = a.element_id AND b.revision = a.revision) AS foreign_table_name, " +
						"(SELECT b.property_value FROM servoy_element_properties b " +
							"WHERE b.content_id = 148 AND b.element_id = a.element_id AND b.revision = a.revision) AS create_related_records, " +
						"(SELECT b.property_value FROM servoy_element_properties b " +
							"WHERE b.content_id = 147 AND b.element_id = a.element_id AND b.revision = a.revision) AS delete_related_records, " +
						"(SELECT b.property_value FROM servoy_element_properties b " +
							"WHERE b.content_id = 284 AND b.element_id = a.element_id AND b.revision = a.revision) AS allow_parent_delete, " +
						"(SELECT b.property_value FROM servoy_element_properties b " +
							"WHERE b.content_id = 292 AND b.element_id = a.element_id AND b.revision = a.revision) AS join_type, " +
						"(SELECT b.property_value FROM servoy_element_properties b " +
							"WHERE b.content_id = 149 AND b.element_id = a.element_id AND b.revision = a.revision) AS keys_in_db, " +
						"(SELECT b.property_value FROM servoy_element_properties b " +
							"WHERE b.content_id = 266 AND b.element_id = a.element_id AND b.revision = a.revision) AS duplicate_related_records, " +
						"(SELECT b.property_value FROM servoy_element_properties b " +
							"WHERE b.content_id = 267 AND b.element_id = a.element_id AND b.revision = a.revision) AS sort_options " +
					"FROM servoy_releases a " +
						"WHERE " +
								"a.root_element_id = ? AND " +
								"a.release_number = ? AND " +
								"(SELECT c.object_type_id FROM servoy_elements c " +
									"WHERE c.object_type_id = 22 AND c.element_id = a.element_id AND c.revision = a.revision) = 22 " +
						"ORDER BY " +
							"(SELECT b.property_value FROM servoy_element_properties b " +
								"WHERE b.content_id = 143 AND b.element_id = a.element_id AND b.revision = a.revision) ASC, " +
							"(SELECT b.property_value FROM servoy_element_properties b " +
								"WHERE b.content_id = 145 AND b.element_id = a.element_id AND b.revision = a.revision) ASC"
			
			var dataset = databaseManager.getDataSetByQuery(repositoryServer, query, args, maxReturnedRows)
			
			var elementIDs = dataset.getColumnAsArray(1)
			var relationNames = dataset.getColumnAsArray(2)
			var priServers = dataset.getColumnAsArray(3)
			var priTables = dataset.getColumnAsArray(4)
			var foreignServers = dataset.getColumnAsArray(5)
			var foreignTables = dataset.getColumnAsArray(6)
			var createRelatedRecords = dataset.getColumnAsArray(7)
			var deleteRelatedRecords = dataset.getColumnAsArray(8)
			var allowParentDelete = dataset.getColumnAsArray(9)
			var joinTypes = dataset.getColumnAsArray(10)
			var existsInDB = dataset.getColumnAsArray(11)
			var duplicateRelatedRecords = dataset.getColumnAsArray(12)
			var sortOptions = dataset.getColumnAsArray(13)
		}
		//post 5
		else {
			var query = "SELECT a.element_id, " +
						"(SELECT b.property_value FROM servoy_element_properties b " +
							"WHERE b.content_id = 142 AND b.element_id = a.element_id AND b.revision = a.revision) AS relation_name, " +
						"(SELECT b.property_value FROM servoy_element_properties b " +
							"WHERE b.content_id = 315 AND b.element_id = a.element_id AND b.revision = a.revision) AS primary_datasource, " +
						"(SELECT b.property_value FROM servoy_element_properties b " +
							"WHERE b.content_id = 316 AND b.element_id = a.element_id AND b.revision = a.revision) AS foreign_datasource, " +
						"(SELECT b.property_value FROM servoy_element_properties b " +
							"WHERE b.content_id = 148 AND b.element_id = a.element_id AND b.revision = a.revision) AS create_related_records, " +
						"(SELECT b.property_value FROM servoy_element_properties b " +
							"WHERE b.content_id = 147 AND b.element_id = a.element_id AND b.revision = a.revision) AS delete_related_records, " +
						"(SELECT b.property_value FROM servoy_element_properties b " +
							"WHERE b.content_id = 284 AND b.element_id = a.element_id AND b.revision = a.revision) AS allow_parent_delete, " +
						"(SELECT b.property_value FROM servoy_element_properties b " +
							"WHERE b.content_id = 292 AND b.element_id = a.element_id AND b.revision = a.revision) AS join_type, " +
						"(SELECT b.property_value FROM servoy_element_properties b " +
							"WHERE b.content_id = 149 AND b.element_id = a.element_id AND b.revision = a.revision) AS keys_in_db, " +
						"(SELECT b.property_value FROM servoy_element_properties b " +
							"WHERE b.content_id = 266 AND b.element_id = a.element_id AND b.revision = a.revision) AS duplicate_related_records, " +
						"(SELECT b.property_value FROM servoy_element_properties b " +
							"WHERE b.content_id = 267 AND b.element_id = a.element_id AND b.revision = a.revision) AS sort_options " +
					"FROM servoy_releases a " +
						"WHERE " +
								"a.root_element_id = ? AND " +
								"a.release_number = ? AND " +
								"(SELECT c.object_type_id FROM servoy_elements c " +
									"WHERE c.object_type_id = 22 AND c.element_id = a.element_id AND c.revision = a.revision) = 22 " +
						"ORDER BY " +
							"(SELECT b.property_value FROM servoy_element_properties b " +
								"WHERE b.content_id = 143 AND b.element_id = a.element_id AND b.revision = a.revision) ASC, " +
							"(SELECT b.property_value FROM servoy_element_properties b " +
								"WHERE b.content_id = 145 AND b.element_id = a.element_id AND b.revision = a.revision) ASC"
			
			var dataset = databaseManager.getDataSetByQuery(repositoryServer, query, args, maxReturnedRows)
			
			var elementIDs = dataset.getColumnAsArray(1)
			var relationNames = dataset.getColumnAsArray(2)
			
			var priDatasource = dataset.getColumnAsArray(3)
			var foreignDatasource = dataset.getColumnAsArray(4)
			
			var priServers = new Array()
			var priTables = new Array()
			var foreignServers = new Array()
			var foreignTables = new Array()
			for (var z = 0; z < priDatasource.length; z++) {
				var priSourceItem = priDatasource[z]
				var foreignSourceItem = foreignDatasource[z]
				
				if (priSourceItem) {
					priSourceItem = priSourceItem.split('/')
					
					//handle different types of datasources
					switch (priSourceItem[0]) {
						case 'db:':
							priServers.push(priSourceItem[1])
							priTables.push(priSourceItem[2])
							break
					}
				}
				else {
					priServers.push('None')
					priTables.push('None')
				}
				
				if (foreignSourceItem) {
					foreignSourceItem = foreignSourceItem.split('/')
					
					//handle different types of datasources
					switch (foreignSourceItem[0]) {
						case 'db:':
							foreignServers.push(foreignSourceItem[1])
							foreignTables.push(foreignSourceItem[2])
							break
					}
				}
				else {
					foreignServers.push('None')
					foreignTables.push('None')
				}
			}
			
			var createRelatedRecords = dataset.getColumnAsArray(5)
			var deleteRelatedRecords = dataset.getColumnAsArray(6)
			var allowParentDelete = dataset.getColumnAsArray(7)
			var joinTypes = dataset.getColumnAsArray(8)
			var existsInDB = dataset.getColumnAsArray(9)
			var duplicateRelatedRecords = dataset.getColumnAsArray(10)
			var sortOptions = dataset.getColumnAsArray(11)
		}
		
		//add each relation with properties to priServer/priTable location
		for (var j = 0 ; j < relationNames.length ; j++) {
			//check to be sure that relation has a name
			if (relationNames[j] != null) {
				
				//add server if not encountered before
				if (!relations[priServers[j]]) {
					relations[priServers[j]] = new Object()
				}
				
				//add table if not encountered before
				if (!relations[priServers[j]][priTables[j]]) {
					relations[priServers[j]][priTables[j]] = new Object()
				}
				
				//add relation
				var relationInfo = 
				relations[priServers[j]][priTables[j]][relationNames[j]] = 
				{
					moduleName : selectedModule.moduleName,
					relation   : relationNames[j],
					elementID  : elementIDs[j],
					source     : {
							server	: priServers[j],
							table	: priTables[j]
						},
					destination: {
							server	: foreignServers[j],
							table	: foreignTables[j]
						},
					options    : {
							createRelated : (createRelatedRecords[j]) ? true : false,
							deleteRelated : (deleteRelatedRecords[j]) ? true : false,
							parentDelete  : (allowParentDelete[j] || allowParentDelete[j] == null) ? true : false
						},
					joinType   : (joinTypes[j]) ? 'left outer join' : 'inner join',
					indexesInDB: (existsInDB[j]) ? true : false,
					misc       : {
							sort             : (sortOptions[j]) ? true : false,
							duplicateRelated : (duplicateRelatedRecords[j]) ? true : false
						}
				}
			}
		}
	}
}
}

/**
 *
 * @properties={typeid:24,uuid:"0E517B0B-B7D0-4572-B046-EC64DCE5C8DB"}
 */
function NAV_find_popdown_set(formName, hide) {
	var baseForm = solutionPrefs.config.formNameBase
	var fastForm = 'NAV__fastfind'
		
	if (formName && forms[formName]) {
		//get the form
		var findPop = solutionModel.getForm(formName)
		
		var findPopWidth = findPop.width
		var findPopParts = findPop.getParts()
		var findPopHeight = findPopParts[findPopParts.length - 1].getPartYOffset() + findPopParts[findPopParts.length - 1].height
		
		//remove all tabs
		forms[fastForm].elements.tab_fastfind.removeAllTabs()
		
		//add this tab
		forms[fastForm].elements.tab_fastfind.addTab(forms[formName])
		
		//size/position tab
		forms[baseForm].elements.tab_fastfind.setSize(findPopWidth + 40,findPopHeight + 30)
		forms[baseForm].elements.tab_fastfind.setLocation(265 + forms.DATASUTRA_0F_solution__header.elements.split_tool_find.dividerLocation + forms.DATASUTRA_0F_solution__header.elements.split_tool_find.dividerSize,25)
		
		//show tab panel
		forms[baseForm].elements.tab_fastfind.visible = true
	}
	else if (hide) {
		//hide tabpanel
		forms[baseForm].elements.tab_fastfind.visible = false
	}
}

/**
 *
 * @properties={typeid:24,uuid:"e4cac4d3-9c81-4dce-b624-dcbc788c8cbe"}
 */
function NAV_row_background(index, selected, fieldType, fieldName, formName, fieldState)
{
//	var index = arguments[0]
//	var selected = arguments[1]
//	var fieldType = arguments[2]
//	var fieldName = arguments[3]
//	var formName = arguments[4]
//	var fieldState = arguments[5]
	
	if (selected) {
		return '#2367A8'
	}
	//bacground for UL
	else {
		return '#D1D7E2'
	}
}

/**
 * @properties={typeid:35,uuid:"46324019-4a22-4ca6-84dc-9473456360a9"}
 */
var NAV_replace_field_value = '';

/**
 * @properties={typeid:35,uuid:"7955df03-d512-4ebd-8863-e143cfa3dfba",variableType:93}
 */
var NAV_replace_field_value_date = new Date();

/**
 * @properties={typeid:35,uuid:"568532a3-3de2-4ea8-8367-043bf1591a3a",variableType:4}
 */
var NAV_replace_field_value_options;

/**
 * @properties={typeid:35,uuid:"37ec3567-11fd-40eb-b1d3-55f8ff8eac58",variableType:4}
 */
var NAV_replace_field;

/**
 * @properties={typeid:35,uuid:"c34dbe04-0eb0-4ed8-8a03-9d629a3f7145"}
 */
var NAV_replace_method = '';

/**
 * @properties={typeid:35,uuid:"bbe906b7-408f-4fcd-9ed8-5c74c480d9a6",variableType:4}
 */
var NAV_replace_step_increment = 1;

/**
 * @properties={typeid:35,uuid:"d2946431-465e-4771-8e68-046c1ee4e080",variableType:4}
 */
var NAV_replace_step_start = 1;
